<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Horizon â€” Telegram Slot Machine</title>
<style>
    html, body { height: 100%; margin: 0; background: #020616; overflow: hidden; }
    #game { position: fixed; inset: 0; display: grid; place-items: center; }
    canvas { display: block; width: 100%; height: 100%; background: transparent;  z-index:1; position:relative;  position:relative; z-index:1; }
    .error-banner { position: fixed; top: 0; left: 0; right: 0; background: #3a0d10; color: #ffd2d2; padding: 10px 14px; font-weight: 700; display: none; z-index: 40; white-space: pre-wrap; }
    body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    audio { display: none !important; }
    .sound-hint{position:fixed;left:16px;bottom:16px;z-index:30;background:rgba(8,12,30,.75);color:#fff;border-radius:14px;padding:10px 14px;font:700 14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 6px 18px rgba(0,0,0,.35);border:1px solid rgba(167,139,250,.45)}
    .sound-hint b{background:linear-gradient(90deg,#ffd066,#ff5a0a);-webkit-background-clip:text;background-clip:text;color:transparent}

    /* Splash (preloader) â€” match the game canvas CSS size exactly */
    #splash{
      position: absolute;            /* centered overlay, sized by JS to match canvas CSS size */
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      z-index: 50;
      display: grid;
      place-items: center;
      background: radial-gradient(1200px 1200px at 50% 20%, #0a1030 0%, #030616 45%, #010314 100%);
      transition: opacity .45s ease, visibility .45s ease;
      /* width & height set by syncSplashToCanvas() */
    }
    #splash.hide { opacity: 0; visibility: hidden; }

    /* Responsive wrap: scales itself to always fit inside splash */
    .splash-wrap {
      width: min(520px, calc(100% - 24px));
      max-height: calc(100% - 24px);
      box-sizing: border-box;

      padding: 28px 24px;
      border-radius: 24px;
      background: rgba(8,12,30,.55);
      border: 1.5px solid rgba(167,139,250,.45);
      box-shadow:
        0 0 0 4px rgba(109,40,217,.15) inset,
        0 10px 36px rgba(0,0,0,.45),
        0 0 46px rgba(110,231,255,.18);
      backdrop-filter: blur(6px);
      display: grid; gap: 14px; justify-items: center;

      will-change: transform;
    }
    .brand { display: grid; gap: 12px; justify-items: center; margin-bottom: 4px; }
    .brand-badge {
      width: 88px; height: 88px; border-radius: 999px; position: relative; overflow: hidden;
      background: radial-gradient(circle at 40% 35%, #0c153a, #070b24 70%, #040618 100%);
      border: 2px solid rgba(110,231,255,.35);
      box-shadow: 0 0 16px rgba(110,231,255,.25), inset 0 0 22px rgba(167,139,250,.18);
      display: grid; place-items: center;
    }
    #constellation { width: 76px; height: 76px; filter: drop-shadow(0 0 8px rgba(110,231,255,.35)); }
    .brand-title {
      font: 900 28px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; letter-spacing: 1.6px;
      background: linear-gradient(90deg,#6ee7ff,#a78bfa,#7dd3fc);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 0 18px rgba(110,231,255,.25);
    }
    .brand-sub { text-align: center; margin-top: -6px; color: rgba(203,213,255,.9); font: 600 13px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; letter-spacing: .4px; }

    .bar { width: 100%; position: relative; height: 18px; border-radius: 14px; background: rgba(12,17,40,.6); border: 1px solid rgba(167,139,250,.35); overflow: hidden; box-shadow: inset 0 8px 22px rgba(0,0,0,.35); }
    .bar-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg,#6ee7ff,#a78bfa,#7dd3fc); box-shadow: 0 0 18px rgba(110,231,255,.35); transition: width .18s ease; }
    .bar-glow { pointer-events: none; position: absolute; inset: -1.5px; border-radius: 14px; box-shadow: 0 0 0 2px rgba(110,231,255,.12) inset, 0 0 22px rgba(110,231,255,.22); }
    .bar-text { margin-top: 10px; font: 800 14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; width: 100%; text-align: right; background: linear-gradient(90deg,#ffd066,#ff5a0a); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 12px rgba(255,120,30,.35); }

    .splash-foot { margin-top: 4px; width: 100%; display: flex; justify-content: space-between; align-items: center; color: rgba(203,213,255,.75); font: 600 12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .dot-stars { position: absolute; inset: 0; pointer-events: none; z-index: 0;
      background-image:
        radial-gradient(1px 1px at 20% 30%, rgba(110,231,255,.55) 0, transparent 60%),
        radial-gradient(1px 1px at 80% 20%, rgba(167,139,250,.55) 0, transparent 60%),
        radial-gradient(1px 1px at 60% 70%, rgba(110,231,255,.35) 0, transparent 60%),
        radial-gradient(1px 1px at 35% 80%, rgba(167,139,250,.35) 0, transparent 60%);
      animation: twinkle 3.2s ease-in-out infinite;
    }
    @keyframes twinkle { 0%,100% { opacity: .8; } 50% { opacity: .35; } }
  
#balanceDisplay {
  color: #FFD700 !important; /* gold color */
  text-shadow: 0 0 6px rgba(255, 215, 0, 0.9), 0 0 12px rgba(255, 165, 0, 0.7);
  z-index: 3 !important; /* ensure above balance.png */
}

#bgVideo {
#bgVideo {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  object-fit: cover;
  width: 100dvw;
  height: 100dvh;
  transform: translateY(40dvh); /* ðŸ‘ˆ moves video upward by 3% of viewport height */
  background: #000;

  will-change: transform;
}
}

/* Fullscreen black overlay to hide backgroundstory.mp4 until game loaded */
#fadeOverlay {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 9000;
  opacity: 1;
  transition: opacity 0.8s ease;
}
body.loaded #fadeOverlay {
  opacity: 0;
  pointer-events: none;
}


/* Solid black mask above the video while splash is active */
#videoMask {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 8000;  /* under splash (e.g., 9000+) but above the video */
  opacity: 1;
  transition: opacity 0.8s ease;
}
body.loaded #videoMask {
  opacity: 0;
  pointer-events: none;
}

/* Ensure the video never leaks outside its viewport box */
#bgVideo {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: 0;
  background-color: #000;
  overflow: hidden;
}


/* Ensure splash always covers entire viewport and hides Background animation */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000;
  overflow: hidden;
}

#splash {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background-color: #000; /* solid black to cover video */
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  inset: 0;
}

#splash * {
  box-sizing: border-box;
  
}

</style>
<style>
/* Local background image on the game container */
#game {}
</style>
<link rel="preload" as="video" href="./backgroundstory.mp4" type="video/mp4"/>
<style>
/* Force splash to cover the viewport regardless of transforms */
#splash {
  position: fixed !important;
  left: 0 !important;
  top: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  transform: none !important;
  z-index: 99999 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  background: #000 !important;
}
#splash * {
  box-sizing: border-box;
  max-width: none !important;
  margin: 0 !important;
}
</style>
<style id="sideButtonsStyles">
  #game { position: relative; overflow: visible; }

  .side-btn {
    position: absolute;
    left: 0; top: 0;
    display: grid;
    place-items: center;
    z-index: 5;
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    pointer-events: auto;
    will-change: transform;
    contain: layout paint;
  }

  .side-btn img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    filter: none !important;
    pointer-events: none;
  }

</style>

<style id="overlayPanelsStyles">
  :root{
    --casino-bg-1: #0c0f22;
    --casino-bg-2: #06091a;
    --casino-card-top: #151a33;
    --casino-card-bot: #0a0f26;
    --casino-neon: #7c3aed; /* purple neon */
    --casino-cyan: #22d3ee;
    --casino-gold: #fcd34d;
    --casino-rose: #fb7185;
    --casino-text: #e9edf7;
    --casino-subtle: #a6b1cc;
    --casino-border: rgba(180,190,210,0.22);
  }

  .overlay{
    position:absolute; inset:0; display:none; z-index:10000;
  }
  .overlay.open{ display:block; }
  .overlay__backdrop{
    position:absolute; inset:0; background:rgba(0,0,0,0.55); backdrop-filter: blur(2px);
  }
  .overlay__card{
  position:absolute; overflow:hidden; border-radius:20px;
  background: linear-gradient(180deg, rgba(18,22,44,0.96), rgba(8,10,28,0.96));
  border: 2px solid rgba(124,58,237,0.75);
  box-shadow:
    inset 0 0 14px rgba(124,58,237,0.35),
    inset 0 -10px 22px rgba(0,0,0,0.55),
    0 12px 28px rgba(0,0,0,0.55),
    0 0 36px rgba(124,58,237,0.35);
}

  .overlay__header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; border-bottom:1px solid rgba(124,58,237,0.5);
}
  .overlay__header::after{
  content:""; position:absolute; left:0; right:0; bottom:-1px; height:2px;
  background: radial-gradient(60% 80% at 50% 100%, rgba(124,58,237,.85), transparent);
  opacity:.8;
}
  .overlay__header h3{
    margin:0; font-size:17px; letter-spacing:.3px; color:var(--casino-text);
    text-shadow: 0 0 12px rgba(124,58,237,.25);
  }
  .overlay__close{
    -webkit-tap-highlight-color: transparent; cursor:pointer;
    background: linear-gradient(180deg,#171b33,#0e132b);
    color:#e5e7eb;
    border:1px solid rgba(167,139,250,.45); border-radius:12px; padding:8px 12px; line-height:1;
    box-shadow: inset 0 1px 4px rgba(255,255,255,0.06), 0 6px 16px rgba(0,0,0,.35);
  }
  .overlay__close:active{ transform: scale(0.96); }
  .overlay__body{overflow-x:hidden;overflow-x:hidden;box-sizing:border-box; overflow-x:hidden; padding:14px; max-height:70vh; overflow:auto; }

  /* Tabs */
  .tabs{ display:flex; gap:8px; margin:0 0 12px 0; }
  .tab-btn{
    flex:1; text-align:center; padding:10px 12px; cursor:pointer; user-select:none;
    border-radius:12px; border:1px solid rgba(167,139,250,.45);
    background: linear-gradient(180deg,#16173a,#0e122b);
    color: #e9d5ff; font-weight:700;
    box-shadow: inset 0 0 10px rgba(124,58,237,.12);
  }
  .tab-btn.active{
    border-color: rgba(110,231,255,.6);
    color:#f0fdff;
    box-shadow: inset 0 0 18px rgba(34,211,238,.25), 0 0 18px rgba(34,211,238,.12);
  }

  /* History table */
  .hist-table{ width:100%; border-collapse:collapse; font-size:13px; color:var(--casino-text);  table-layout:fixed; }
  .hist-table thead th{
    position:relative; padding:9px 8px; font-weight:700; color:#dbeafe; text-align:left;
    border-bottom:1px solid rgba(180,190,210,0.18);
  }
  .hist-table thead th::after{
    content:""; position:absolute; left:0; right:0; bottom:-1px; height:1px;
    background: linear-gradient(90deg, transparent, var(--casino-neon), transparent); opacity:.7;
  }
  .hist-table td{ padding:8px 8px; border-bottom:1px dashed rgba(180,190,210,0.12); }
  .hist-table tr:nth-child(2n){ background: rgba(124,58,237,0.05); }
  .hist-badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .hist-badge.win{  background: rgba(34,197,94,0.18);  color:#86efac; box-shadow:0 0 8px rgba(34,197,94,.25) inset; }
  .hist-badge.loss{ background: rgba(239,68,68,0.18); color:#fecaca; box-shadow:0 0 8px rgba(239,68,68,.25) inset; }

  /* Wallet forms â€” one-column layout */
  .form-1col{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .form-row{ display:block; }
  .form-row label{ font-size:12px; color:var(--casino-subtle); display:block; margin:0 0 4px 2px; }
  .form-row input, .form-row select{
    width:100%; padding:10px 12px; border-radius:12px;
    background: linear-gradient(180deg, #0f1227, #0b0f22);
    border:1px solid rgba(167,139,250,.45);
    color:#e5e7eb; outline:none;
    -webkit-text-fill-color:#e5e7eb;
    box-shadow: inset 0 0 10px rgba(124,58,237,.12);
  }
  .form-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
  .btn{
  border:2px solid rgba(124,58,237,.6);
  background: linear-gradient(180deg,#151a33,#0c0f24);
  color:#e9d5ff; border-radius:14px; padding:10px 14px; cursor:pointer; font-weight:800;
  box-shadow: inset 0 0 10px rgba(124,58,237,.25), 0 6px 16px rgba(0,0,0,.35);
}
  .btn:active{ transform: scale(0.96); }
  .btn.primary{
  border:2px solid rgba(34,211,238,.7);
  background: linear-gradient(180deg,#112136,#0b1020);
  color:#e0f2fe; border-radius:14px; font-weight:800;
  box-shadow: inset 0 0 14px rgba(34,211,238,.25), 0 0 24px rgba(34,211,238,.25);
}

  /* Small devices */
  @media (max-width: 480px){
    .overlay__header h3{ font-size:16px; }
    .hist-table{ font-size:12px;  table-layout:fixed; }
  }

  .hist-table th, .hist-table td{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .form-row input, .form-row select{
    width:100%; padding:10px 12px; border-radius:12px;
    background: linear-gradient(180deg, #0f1227, #0b0f22);
    border:1px solid rgba(167,139,250,.45);
    color:#e5e7eb; outline:none;
    -webkit-text-fill-color:#e5e7eb;
    box-shadow: inset 0 0 10px rgba(124,58,237,.12);
  }
  /* Gradient title like in-game neon banner */
  #overlayTitle{background:linear-gradient(90deg,#f0abfc,#93c5fd);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 10px rgba(147,197,253,.25);}

  .form-row select option{
    color:#e5e7eb; background:#0b0f22;
  }
.overlay__section{ max-width:min(520px, 88%); margin: 0 auto; }
.form-1col{ display:grid; grid-template-columns: 1fr; gap:10px; }
.form-row input, .form-row select{ width:100%; max-width:100%; box-sizing:border-box; }

.tab-btn{position:relative; z-index:1; pointer-events:auto;}
</style>

</head>
<body>
<div id=\"videoMask\"></div>
<div id=\"fadeOverlay\"></div>

<div id="game" style="position:relative;;position:relative;">
<video id="bgVideo" muted playsinline webkit-playsinline autoplay loop preload="auto"
  class="hiddenUntilReady"
  style="position:fixed; inset:0; width:100%; height:100%; object-fit:contain; background:#000; z-index:0; pointer-events:none;">
  <source src="./backgroundstory.mp4" type="video/mp4"/>
</video>
<img alt="Balance background" id="balanceBg" src="./balance.png" style="position:fixed;left:0;top:0;width:0;height:auto;pointer-events:none;z-index:0;opacity:1;"/><a id="historyBtn" class="side-btn side-btn--left" href="#" aria-label="Open History" role="button">
      <img src="https://pinkp0p.github.io/horizon/history.png" alt="History"/>
    </a>
    <a id="walletBtn" class="side-btn side-btn--right" href="#" aria-label="Open Wallet" role="button">
      <img src="https://pinkp0p.github.io/horizon/wallet.png" alt="Wallet"/>
    </a>

<div id="overlay" class="overlay" aria-hidden="true"><div class="overlay__backdrop" id="overlayBackdrop"></div><div class="overlay__card" id="overlayCard" role="dialog" aria-modal="true" aria-labelledby="overlayTitle"><div class="overlay__header"><h3 id="overlayTitle">Panel</h3><button class="overlay__close" id="overlayClose" aria-label="Close">âœ•</button></div><div class="overlay__body"><div id="historyContent" style="display:none"><table class="hist-table" id="historyTable"><thead><tr><th>Time</th><th>Bet</th><th>Result</th><th>Payout</th></tr></thead><tbody></tbody></table></div><div id="walletContent" style="display:none"><div class="overlay__section">
  <div class="tabs">
    <button class="tab-btn active" id="tabAdd">Add Account</button>
    <button class="tab-btn" id="tabWithdraw" type="button">Withdraw</button>
  </div>

  <!-- ADD ACCOUNT (tab) -->
  <div id="tabAddPane">
    <div class="form-1col">
      <div class="form-row">
        <label for="acctType">Account Type</label>
        <select id="acctType">
          <option value="bank">Bank</option>
          <option value="paypal">PayPal</option>
        </select>
      </div>
      <div class="form-row">
        <label for="acctName">Full Name</label>
        <input id="acctName" placeholder="John Smith" />
      </div>
      <div class="form-row" id="bankFields">
        <label for="bankName">Bank Name</label>
        <input id="bankName" placeholder="Your bank" />
        <label for="iban" style="margin-top:8px">Account / IBAN</label>
        <input id="iban" placeholder="Account number / IBAN" />
      </div>
      <div class="form-actions">
        <button class="btn" id="addAccountBtn">Add Account</button>
      </div>
    </div>
  </div>

  <!-- WITHDRAW (tab) -->
  <div id="tabWithdrawPane" style="display:none">
    <div class="form-1col">
      <div class="form-row">
        <label for="withdrawAmount">Withdraw Amount</label>
        <input id="withdrawAmount" type="number" min="1" placeholder="Amount" />
      </div>
      <div class="form-row">
        <label for="currency">account</label>
        <select id="currency">
          <option value="USD">paypal</option>
          <option value="EUR">Bank1</option>
          <option value="LKR">Bank2</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn primary" id="requestWithdrawBtn">Request Withdraw</button>
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div></div>
</div>
<!-- Hidden input for inline bet editing -->
<input aria-label="Edit bet" id="betInput" inputmode="numeric" pattern="[0-9]*" style="position:fixed;left:-9999px;top:-9999px;opacity:0;width:1px;height:1px;border:0;padding:0;background:transparent;color:transparent" type="text"/>
<div class="error-banner" id="errorBanner"></div>
<div class="error-banner" id="fallback" style="display:block;background:#0e1422;color:#cde7ff">
    If you see only this message on iPhone, the file is opening in the Files app preview which doesnâ€™t run JavaScript.
    Tap the share icon â†’ <b>Open in Safari</b>, or host this file on HTTPS and open that link.
  </div>
<div class="sound-hint" id="soundHint" style="display:none">Tap anywhere to <b>enable sound</b> ðŸ”Š</div>
<!-- HTMLAudio fallbacks (WebAudio is preferred) -->
<audio id="spinSound" muted="" playsinline="" preload="auto">
<source src="https://cdn.jsdelivr.net/gh/naptha/talkify/sounds/notification.mp3" type="audio/mpeg"/>
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg"/>
</audio>
<audio id="bangSound" muted="" playsinline="" preload="auto">
<source src="https://cdn.jsdelivr.net/gh/itsmikehere/sample-audio@main/explosion-1.mp3" type="audio/mpeg"/>
<source src="https://actions.google.com/sounds/v1/explosions/explosion.ogg" type="audio/ogg"/>
</audio>
<audio id="coinSound" muted="" playsinline="" preload="auto">
<source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg"/>
<source src="https://cdn.jsdelivr.net/gh/itsmikehere/sample-audio@main/coin-1.mp3" type="audio/mpeg"/>
</audio>
<!-- SPLASH / PRELOADER (exact game size; JS sets width/height) -->
<div aria-live="polite" id="splash" role="status">
<div class="dot-stars"></div>
<div class="splash-wrap">
<div class="brand">
<div class="brand-badge">
<!-- Animated constellation logo -->
<canvas aria-hidden="true" height="76" id="constellation" width="76"></canvas>
</div>
<div aria-label="Game name" class="brand-title">HORIZON</div>
<div class="brand-sub">Preparing constellations &amp; forging the lava frameâ€¦</div>
</div>
<div aria-label="Loading progress" class="bar">
<div class="bar-fill" id="barFill"></div>
<div class="bar-glow"></div>
</div>
<div class="bar-text" id="barText">0%</div>
<div class="splash-foot">
<span id="splashHint">Loading assets</span>
<span>Telegram Mini App</span>
</div>
</div>
</div>
<script>

// --- Telegram shim (iOS-safe): ensures receiveEvent exists even outside Telegram ---
(function(){
  try {
    // Helper that routes events to either WebApp or GameProxy when available
    window.__tgSend = function(payload){
      try{
        if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.sendData === 'function'){
          window.Telegram.WebApp.sendData(payload);
        } else if (window.TelegramGameProxy && typeof window.TelegramGameProxy.receiveEvent === 'function'){
          window.__tgSend(payload);
        } else {
          // Not running inside Telegram; ignore
        }
      }catch(e){}
    };
    // Ensure TelegramGameProxy exists with a safe no-op receiveEvent
    if (!window.TelegramGameProxy || typeof window.TelegramGameProxy.receiveEvent !== 'function'){
      window.TelegramGameProxy = {
        receiveEvent: function(payload){ window.__tgSend(payload); } // delegate to helper
      };
    }
  } catch(e){}
})();

(function(){
  'use strict';

  // -----------------------------------------------------
  // Error banner
  // -----------------------------------------------------
  function show(msg){ var el=document.getElementById('errorBanner'); if(!el) return; el.textContent=String(msg); el.style.display='block'; }
  window.__showBanner=show;
  window.addEventListener('error',function(e){ if(String(e.message).indexOf('Script error')===-1) show('Error: '+e.message); });
  window.addEventListener('unhandledrejection',function(e){ var r=e && e.reason; show('Unhandled: '+(r && (r.message||r))); });

  // -----------------------------------------------------
  // Splash â†” Canvas size sync + content fit
  // -----------------------------------------------------
  var CONFIG={ width:720, height:1280, reelCount:3, rows:4, symbolSize:180, reelSpacing:16, bet:20, startBalance:1000,
    spinBaseDuration:8.0, spinStagger:1.80, cyclesBase:24, cyclesStep:8 };

  function fitSplashContent(){
    var splash = document.getElementById('splash'); if(!splash) return;
    var wrap = splash.querySelector('.splash-wrap'); if(!wrap) return;

    wrap.style.transform = 'none'; // reset to measure

    var sw = splash.clientWidth, sh = splash.clientHeight;
    var w = wrap.offsetWidth,  h = wrap.offsetHeight;

    var scale = Math.min(1, (sw - 12) / Math.max(1,w), (sh - 12) / Math.max(1,h));
    wrap.style.transformOrigin = 'center';
    wrap.style.transform = 'scale(' + scale + ')';
  }

  function syncSplashToCanvas(){
    var splash = document.getElementById('splash');
    var root = document.getElementById('game');
    if(!splash || !root) return;

    var cvs = root.querySelector('canvas');
    if(!cvs){
      // before engine mounts, emulate the scale used by _resize()
      var vw = (window.visualViewport ? window.visualViewport.width : window.innerWidth);
      var vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
      var scale = Math.min(vw/CONFIG.width, vh/CONFIG.height);
      splash.style.width  = Math.floor(CONFIG.width * scale) + 'px';
      splash.style.height = Math.floor(CONFIG.height * scale) + 'px';
      fitSplashContent();
      return;
    }
    // match the rendered CSS size of the canvas (not its internal pixel buffer)
    var cs = getComputedStyle(cvs);
    var csw = parseFloat(cs.width);
    var csh = parseFloat(cs.height);
    splash.style.width  = Math.round(csw) + 'px';
    splash.style.height = Math.round(csh) + 'px';
    fitSplashContent();
  }


// Progress watchdog: if stalled under 100% for 2000ms, force completion
(function(){
  var last = 0, lastT = Date.now();
  setInterval(function(){
    try{
      var t = (window.barText && parseInt(window.barText.textContent)) || 0;
      if (t !== last){ last = t; lastT = Date.now(); }
      if (Date.now() - lastT > 2000 && !__finalized){
        __iconsReady = true; // assume icons done
        __videoReady = true; // assume video done
        maybeComplete('Watchdog');
      }
    }catch(e){}
  }, 500);
})();
  // Keep splash size in sync with canvas scaling and viewport changes
  window.addEventListener('DOMContentLoaded', syncSplashToCanvas);
  window.addEventListener('resize', syncSplashToCanvas);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', syncSplashToCanvas);

  // -----------------------------------------------------
  // Animated Constellation Logo (splash)
  // -----------------------------------------------------
  (function(){
    function run(){
      var cvs = document.getElementById('constellation');
      if(!cvs) return;
      var ctx = cvs.getContext('2d');
      var W = cvs.width, H = cvs.height, t0 = performance.now();
      var running = true;

      var nodes = [
        {x:-20,y:-8}, {x:-5,y:-18}, {x:12,y:-10}, {x:20,y:5},
        {x:8,y:18}, {x:-10,y:12}, {x:-18,y:2}
      ];
      var edges = [[0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[6,0],[1,4],[2,5]];

      function draw(now){
        if(!running) return;
        var t = (now - t0)/1000;
        ctx.clearRect(0,0,W,H);

        var rot = t*0.35;
        var cx = W/2, cy = H/2;

        var rg = ctx.createRadialGradient(cx,cy,8,cx,cy,36);
        rg.addColorStop(0,'rgba(110,231,255,0.22)');
        rg.addColorStop(1,'rgba(167,139,250,0.04)');
        ctx.fillStyle = rg; ctx.beginPath(); ctx.arc(cx,cy,36,0,Math.PI*2); ctx.fill();

        var tw = 0.5+0.5*Math.sin(t*2.1);
        var pts = nodes.map(function(n){
          var x = n.x*Math.cos(rot) - n.y*Math.sin(rot);
          var y = n.x*Math.sin(rot) + n.y*Math.cos(rot);
          return {x: cx + x, y: cy + y};
        });

        ctx.lineCap='round'; ctx.lineJoin='round';
        edges.forEach(function(e){
          var a = pts[e[0]], b = pts[e[1]];
          var lg = ctx.createLinearGradient(a.x,a.y,b.x,b.y);
          lg.addColorStop(0,'rgba(110,231,255,'+(0.45+0.35*tw)+')');
          lg.addColorStop(1,'rgba(167,139,250,'+(0.35+0.25*tw)+')');
          ctx.strokeStyle = lg; ctx.lineWidth = 1.5;
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        });

        pts.forEach(function(p,idx){
          var r = 1.3 + (idx%3?0.0:0.6)*tw;
          ctx.shadowBlur = 6; ctx.shadowColor = 'rgba(110,231,255,0.6)';
          ctx.fillStyle = 'rgba(255,255,255,0.85)';
          ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
        });

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);

      var splash = document.getElementById('splash');
      var obs = new MutationObserver(function(){
        if(splash.classList.contains('hide')) { running=false; obs.disconnect(); }
      });
      obs.observe(splash, {attributes:true, attributeFilter:['class']});
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run);
    } else { run(); }
  })();

  // -----------------------------------------------------
  // Audio system (tick-based spin, coin sfx, bang)
  // -----------------------------------------------------
  var AudioSys=(function(){
    var ctx=null, unlocked=false, gainMain=null;
    var tickAcc=0, tickAccMs=0, lastCoinTime=0;

    function ensure(){
      if(ctx) return ctx;
      var C=window.AudioContext||window.webkitAudioContext; if(!C) return null;
      ctx=new C({latencyHint:'interactive'}); gainMain=ctx.createGain(); gainMain.gain.value=1.0; gainMain.connect(ctx.destination);
      return ctx;
    }
    function unlock(){
      var c=ensure(); if(!c) return false;
      if(c.state==='suspended'){ c.resume().catch(function(){}); }
      var b=c.createBuffer(1,1,22050), s=c.createBufferSource(); s.buffer=b; s.connect(gainMain); try{s.start(0);}catch(_){}
      unlocked=true;
      ['spinSound','bangSound','coinSound'].forEach(function(id){ var a=document.getElementById(id); try{ if(a){ a.muted=false; a.currentTime=0; } }catch(_){} });
      return true;
    }

    function playSpin(){
      var c=ensure();
      if(c && unlocked){
        var o=c.createOscillator(), g=c.createGain(), now=c.currentTime;
        o.type='triangle'; o.frequency.setValueAtTime(880,now); o.frequency.exponentialRampToValueAtTime(1760, now+0.08);
        g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.6,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
        o.connect(g); g.connect(gainMain); o.start(now); o.stop(now+0.18); return;
      }
      var a=document.getElementById('spinSound'); if(a){ try{ a.muted=false; a.currentTime=0; a.play(); }catch(_){ } }
    }
    function playBang(){
      var c=ensure();
      if(c && unlocked){
        var now=c.currentTime, dur=0.45, len=Math.floor(c.sampleRate*dur);
        var buf=c.createBuffer(1,len,c.sampleRate), data=buf.getChannelData(0);
        for(var i=0;i<len;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/len, 2.2); }
        var src=c.createBufferSource(); src.buffer=buf;
        var lp=c.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(1800, now);
        var g=c.createGain(); g.gain.value=0.0;
        src.connect(lp); lp.connect(g); g.connect(gainMain);
        g.gain.linearRampToValueAtTime(0.9, now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
        src.start(now); src.stop(now+dur);
        var o=c.createOscillator(), g2=c.createGain();
        o.type='sine'; o.frequency.setValueAtTime(120, now); o.frequency.exponentialRampToValueAtTime(50, now+0.35);
        g2.gain.setValueAtTime(0, now); g2.gain.linearRampToValueAtTime(0.8, now+0.02); g2.gain.exponentialRampToValueAtTime(0.0001, now+0.5);
        o.connect(g2); g2.connect(gainMain); o.start(now); o.stop(now+0.5); return;
      }
      var a=document.getElementById('bangSound'); if(a){ try{ a.muted=false; a.currentTime=0; a.play(); }catch(_){ } }
    }
    function playCountdown(n){
      var c=ensure(), freq=(n===3?880:(n===2?660:520));
      if(c && unlocked){
        var now=c.currentTime, o=c.createOscillator(), g=c.createGain();
        o.type='square'; o.frequency.setValueAtTime(freq, now);
        g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.7, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
        o.connect(g); g.connect(gainMain); o.start(now); o.stop(now+0.2); return;
      }
      var a=document.getElementById('spinSound'); if(a){ try{ a.muted=false; a.currentTime=0; a.play(); }catch(_){ } }
    }
    function playTick(){
      var c=ensure();
      if(c && unlocked){
        var now=c.currentTime, o=c.createOscillator(), eg=c.createGain(), hp=c.createBiquadFilter();
        o.type='square'; o.frequency.setValueAtTime(1200, now);
        hp.type='highpass'; hp.frequency.value=800;
        eg.gain.setValueAtTime(0, now); eg.gain.linearRampToValueAtTime(0.22, now+0.005); eg.gain.exponentialRampToValueAtTime(0.0001, now+0.07);
        o.connect(hp); hp.connect(eg); eg.connect(gainMain);
        o.start(now); o.stop(now+0.08); return;
      }
      var a=document.getElementById('spinSound'); if(a){ try{ a.currentTime=0; a.play(); }catch(_){} }
    }
    function tick(dt, hz){
      hz = Math.max(6, Math.min(18, hz||10));
      var c = ensure();
      if(c && unlocked){
        var period = 1/hz; tickAcc += dt;
        while(tickAcc >= period){ tickAcc -= period; playTick(); }
      } else {
        var periodMs = 1000/hz; tickAccMs += dt*1000;
        while(tickAccMs >= periodMs){ tickAccMs -= periodMs; playTick(); }
      }
    }
    function resetTicker(){ tickAcc=0; tickAccMs=0; }
    function playCoin(){
  var c = ensure();
  if (c && unlocked){
    var now = c.currentTime;
    if (now - lastCoinTime < 0.05) return;
    lastCoinTime = now;
    var o = c.createOscillator(), hp = c.createBiquadFilter(), g = c.createGain();
    o.type = 'square';
    o.frequency.setValueAtTime(1500, now);
    o.frequency.exponentialRampToValueAtTime(2200, now + 0.03);
    hp.type = 'highpass'; hp.frequency.value = 900;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.45, now + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
    o.connect(hp); hp.connect(g); g.connect(gainMain);
    o.start(now); o.stop(now + 0.14);
    return;
  }
  var a = document.getElementById('coinSound');
  if (a){
    try{ a.muted = false; if (a.currentTime > 0.25) a.currentTime = 0; a.play(); }catch(_){}
  }
}
return { ensure, unlock, playSpin, playBang, playCountdown, playCoin, tick, resetTicker };
  })();

  // -----------------------------------------------------
  // Assets (icons) + helpers
  // -----------------------------------------------------
  var REEL_DIR=[+1,+1,+1];
  var FRAME_RADIUS=28, FRAME_GAP_FRAC=0.12, NAV_HEIGHT_FRAC=0;
  var SYMBOL_FILL=1.0, SYMBOL_MARGIN=0.04; var AUTO_TRIM_ALPHA=8, AUTO_TRIM_PAD_MIN=4, AUTO_TRIM_RATIO=0.10, USE_TRIM=true;

  var ICON_URLS=[
    'https://pinkp0p.github.io/horizon/zodiac_1.png','https://pinkp0p.github.io/horizon/zodiac_2.png','https://pinkp0p.github.io/horizon/zodiac_3.png','https://pinkp0p.github.io/horizon/zodiac_4.png',
    'https://pinkp0p.github.io/horizon/zodiac_5.png','https://pinkp0p.github.io/horizon/zodiac_6.png','https://pinkp0p.github.io/horizon/zodiac_7.png','https://pinkp0p.github.io/horizon/zodiac_8.png',
    'https://pinkp0p.github.io/horizon/zodiac_9.png','https://pinkp0p.github.io/horizon/zodiac_10.png','https://pinkp0p.github.io/horizon/zodiac_11.png','https://pinkp0p.github.io/horizon/zodiac_12.png'
  , 'https://raw.githubusercontent.com/piNkp0p/horizon/main/zodiac_13.png', 'https://pinkp0p.github.io/horizon/wallet.png','https://pinkp0p.github.io/horizon/history.png' ];
  var icons={ imgs:Array(ICON_URLS.length).fill(null), rects:Array(ICON_URLS.length).fill(null), ready:false, error:false };
  var iconCache={ cell:0, inner:0, canvases:Array(ICON_URLS.length).fill(null) };

  function preloadIconsWithProgress(urls, onProgress, onDone){
  var total = ICON_URLS.length;
  var loaded = 0, failed = false;
  function bump(msg){
    loaded++;
    var pct = Math.round((loaded/total)*100);
    try{ onProgress && onProgress(pct, msg||('Loaded '+loaded+'/'+total)); }catch(_){}
    if(loaded>=total && !failed){
      icons.ready = true;
      onDone && onDone();
    }
  }
  // Prefer decode off the main thread using createImageBitmap
  var canBitmap = (typeof createImageBitmap === 'function');
  urls.forEach(function(url,i){
    if (canBitmap) {
      fetch(url, {mode:'cors'}).then(function(r){
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.blob();
      }).then(function(b){ return createImageBitmap(b); })
      .then(function(bmp){
        icons.imgs[i] = bmp;
        try{ icons.rects[i] = USE_TRIM? {sx:0,sy:0,sw:bmp.width,sh:bmp.height} : {sx:0,sy:0,sw:bmp.width,sh:bmp.height}; }
        catch(_){ icons.rects[i] = {sx:0,sy:0,sw:bmp.width,sh:bmp.height}; }
        bump('Icon '+(i+1)+' ready (bitmap)');
      }).catch(function(){
        // Fallback to <img>
        var img=new Image(); img.decoding='async'; img.crossOrigin='anonymous';
        img.onload=function(){
          icons.imgs[i]=img;
          try{ icons.rects[i]=USE_TRIM?trimRectForImage(img):{sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight}; }
          catch(_){ icons.rects[i]={sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight}; }
          bump('Icon '+(i+1)+' ready (fallback)');
        };
        img.onerror=function(){ if(!failed){ failed=true; try{ onDone && onDone(new Error('Failed '+url)); }catch(_){}} };
        img.src=url;
      });
    } else {
      var img=new Image(); img.decoding='async'; img.crossOrigin='anonymous';
      img.onload=function(){
        icons.imgs[i]=img;
        try{ icons.rects[i]=USE_TRIM?trimRectForImage(img):{sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight}; }
        catch(_){ icons.rects[i]={sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight}; }
        bump('Icon '+(i+1)+' ready');
      };
      img.onerror=function(){ if(!failed){ failed=true; try{ onDone && onDone(new Error('Failed '+url)); }catch(_){}} };
      img.src=url;
    }
  });
}
  function trimRectForImage(img){
    var w=img.naturalWidth,h=img.naturalHeight;
    var off=document.createElement('canvas'); off.width=w; off.height=h; var o=off.getContext('2d'); o.drawImage(img,0,0);
    var data=o.getImageData(0,0,w,h).data; var minX=w,minY=h,maxX=-1,maxY=-1;
    for(var y=0;y<h;y++) for(var x=0;x<w;x++){ var a=data[(y*w+x)*4+3]; if(a>AUTO_TRIM_ALPHA){ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; } }
    if(maxX<0||maxY<0) return {sx:0,sy:0,sw:w,sh:h};
    var sw=maxX-minX+1, sh=maxY-minY+1; var pad=Math.max(AUTO_TRIM_PAD_MIN,Math.round(Math.min(w,h)*AUTO_TRIM_RATIO));
    var sx=Math.max(0,minX-pad), sy=Math.max(0,minY-pad); var sx2=Math.min(w,maxX+1+pad), sy2=Math.min(h,maxY+1+pad);
    return {sx:sx,sy:sy,sw:sx2-sx,sh:sy2-sy};
  }
  function buildIconCache(cell){
    if(!icons.ready) return;
    var inner=Math.max(1,Math.floor(cell*(SYMBOL_FILL-2*SYMBOL_MARGIN)));
    if(iconCache.cell===cell && iconCache.inner===inner) return;
    iconCache.cell=cell; iconCache.inner=inner; iconCache.canvases=Array(ICON_URLS.length).fill(null);
    for(var i=0;i<ICON_URLS.length;i++){
      var img=icons.imgs[i]; if(!img) continue;
      var r=icons.rects[i]||{sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight};
      var sc=Math.min(inner/r.sw, inner/r.sh);
      var dw=Math.max(1,Math.round(r.sw*sc)), dh=Math.max(1,Math.round(r.sh*sc));
      var off=document.createElement('canvas'); off.width=dw; off.height=dh; var o=off.getContext('2d',{alpha:true});
      o.imageSmoothingEnabled=true; o.imageSmoothingQuality='high';
      try{o.drawImage(img,r.sx,r.sy,r.sw,r.sh,0,0,dw,dh);}catch(_){}
      iconCache.canvases[i]=off;
    }
  }

  // -----------------------------------------------------
  // Visual helpers
  // -----------------------------------------------------
  function roundRectPath(ctx,x,y,w,h,r){ var rr=Math.max(0,Math.min(r,Math.min(w,h)/2)); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
  
  function drawDividerLine(ctx, x, topY, rows, cell, t){
    ctx.save();
    // Outer neon glow (lava gradient same direction as frame)
    var h = rows * cell;
    var g = lavaGradient(ctx, x - 20, topY, 40, h, t);
    ctx.strokeStyle = g;
    ctx.lineWidth = 5;              // thicker for strong tube look
    ctx.shadowBlur = 22;            // strong glow
    ctx.shadowColor = 'rgba(255,120,30,0.90)';
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(x, topY + 6);
    ctx.lineTo(x, topY + h - 6);
    ctx.stroke();

    // Inner hot core
    ctx.shadowBlur = 0;
    ctx.strokeStyle = 'rgba(255, 220, 140, 0.95)';
    ctx.lineWidth = 2.2;
    ctx.beginPath();
    ctx.moveTo(x, topY + 10);
    ctx.lineTo(x, topY + h - 10);
    ctx.stroke();

    ctx.restore();
  }

function StarBG(W,H){ this.w=W; this.h=H; this.t=0; this.stars=[]; for(var i=0;i<160;i++){ var blue=Math.random()<0.5; var rgb=blue?[140,140,255]:[200,130,255]; this.stars.push({x:Math.random()*W,y:Math.random()*H,r:0.8+Math.random()*1.4,v:20+Math.random()*60,rgb:rgb,baseA:0.6+Math.random()*0.35,tw:0.6+Math.random()*1.6,ph:Math.random()*Math.PI*2}); } }
  StarBG.prototype.update=function(dt){ this.t+=dt; for(var i=0;i<this.stars.length;i++){ var s=this.stars[i]; s.y+=s.v*dt; if(s.y>this.h){ s.y=-2; s.x=Math.random()*this.w; } } };
  StarBG.prototype.draw=function(ctx){ ctx.fillStyle='#050714'; ctx.fillRect(0,0,this.w,this.h); ctx.globalCompositeOperation='lighter'; for(var i=0;i<this.stars.length;i++){ var s=this.stars[i]; var twPhase=0.5+0.5*Math.sin(this.t*s.tw+s.ph); var a=s.baseA*(0.65+0.35*twPhase); var color='rgba('+s.rgb[0]+','+s.rgb[1]+','+s.rgb[2]+','+a.toFixed(3)+')'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*(0.85+0.15*twPhase),0,Math.PI*2); ctx.fillStyle=color; ctx.shadowBlur=6+6*twPhase; ctx.shadowColor=color; ctx.fill(); } ctx.globalCompositeOperation='source-over'; };
  function lavaGradient(ctx,x,y,w,h,t){ var g=ctx.createLinearGradient(x,y+h*Math.sin(t*0.6)*0.1,x+w,y+h*(1+Math.sin(t*0.5)*0.1)); g.addColorStop(0,'#3a0d10'); g.addColorStop(0.25,'#7a1a10'); g.addColorStop(0.45,'#c32c10'); g.addColorStop(0.65,'#ff5a0a'); g.addColorStop(0.85,'#ffd066'); g.addColorStop(1,'#ff5a0a'); return g; }
  //function drawLavaFrame(ctx,x,y,w,h,r,t){ var rr=Math.max(0,Math.min(r,Math.min(w,h)/2)); ctx.save(); ctx.translate(0.5,0.5); ctx.lineWidth=12; ctx.shadowBlur=22; ctx.shadowColor='rgba(255,100,20,0.85)'; ctx.strokeStyle=lavaGradient(ctx,x,y,w,h,t); roundRectPath(ctx,x+3,y+3,w-6,h-6,rr-3); ctx.stroke(); ctx.lineWidth=3; ctx.shadowBlur=10; ctx.strokeStyle='rgba(255,220,120,0.8)'; roundRectPath(ctx,x+8,y+8,w-16,h-16,rr-8); ctx.stroke(); ctx.restore(); }
  function drawLavaButton(ctx,cx,cy,R,t,pressed){ ctx.save(); var g=ctx.createRadialGradient(cx,cy,R*0.2,cx,cy,R); var p=(Math.sin(t*1.6)*0.5+0.5)*0.25; if(pressed){ g.addColorStop(0,'#ffeebf'); g.addColorStop(0.25+p,'#ffb34a'); g.addColorStop(0.65,'#c42d1f'); g.addColorStop(1,'#4a1410'); } else { g.addColorStop(0,'#ffea9a'); g.addColorStop(0.25+p,'#ff962a'); g.addColorStop(0.65,'#a81d0f'); g.addColorStop(1,'#3a0d10'); } ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle=g; ctx.fill(); ctx.lineWidth=6; ctx.strokeStyle='rgba(255,140,30,0.95)'; ctx.shadowColor='rgba(255,120,30,0.9)'; ctx.shadowBlur=20; ctx.stroke(); ctx.beginPath(); ctx.arc(cx,cy,R*0.85,-Math.PI*0.15,Math.PI*0.35); ctx.lineWidth=8; ctx.strokeStyle='rgba(255,240,210,0.35)'; ctx.shadowBlur=0; ctx.stroke(); ctx.restore(); ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='900 36px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; var tl=ctx.createLinearGradient(cx-40,cy-20,cx+40,cy+20); tl.addColorStop(0,'#fff4e2'); tl.addColorStop(1,'#ffd18a'); ctx.fillStyle=tl; ctx.fillText('SPIN',cx,cy); ctx.restore(); }
  
// === Cosmic glow for zodiac symbols ===

// === Zodiac color palette & helpers ===
// Index mapping must match your SYMBOLS order [0..11].
var ZODIAC_COLORS = [
  '#19accb', // 0 Aries - hot red
  '#ff1023', // 1 Taurus - emerald
  '#c851c8', // 2 Gemini - amber
  '#e04800', // 3 Cancer - aqua
  '#066ee9', // 4 Leo - orange/gold
  '#f16008', // 5 Virgo - mint
  '#9d24a1', // 6 Libra - lilac
  '#f0ac06', // 7 Scorpio - magenta
  '#c9842a', // 8 Sagittarius - indigo
  '#cc1a6c', // 9 Capricorn - slate
  '#03b65a', //10 Aquarius - cyan/teal
  '#1fb59b',  //11 Pisces - seafoam
  '#e3a03a'
];

function hexToRgb(hex){
  var m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if(!m) return {r: 180, g: 200, b: 255};
  return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
}
function withAlpha(rgb, a){
  return 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + a.toFixed(3) + ')';
}
function mix(c1, c2, t){
  return { r: Math.round(c1.r*(1-t)+c2.r*t), g: Math.round(c1.g*(1-t)+c2.g*t), b: Math.round(c1.b*(1-t)+c2.b*t) };
}

function drawZodiacGlow(ctx, x, y, size, idx){
  var t = (window.__cosmicT || 0);
  var p = 0.55 + 0.35 * Math.sin(t * 2.1 + idx * 0.7);
  var R = size * 0.58;
  var base = ZODIAC_COLORS[(idx||0) % ZODIAC_COLORS.length];
  var rgb = hexToRgb(base);
  var light = mix(rgb, {r:255,g:255,b:255}, 0.25);
  var deep  = mix(rgb, {r:16,g:20,b:48}, 0.50);
  ctx.save();
  ctx.globalCompositeOperation = 'lighter';
  var g1 = ctx.createRadialGradient(x, y, R*0.15, x, y, R);
  g1.addColorStop(0,  withAlpha(rgb,  0.10 + 0.20*p));
  g1.addColorStop(0.6,withAlpha(deep, 0.08 + 0.16*p));
  g1.addColorStop(1,  'rgba(24,28,64,0)');
  ctx.fillStyle = g1; ctx.beginPath(); ctx.arc(x, y, R, 0, Math.PI*2); ctx.fill();
  var g2 = ctx.createRadialGradient(x, y, 0, x, y, R*0.42);
  g2.addColorStop(0, withAlpha(light, 0.22 + 0.12*p));
  g2.addColorStop(1, withAlpha(rgb,   0.00));
  ctx.fillStyle = g2; ctx.beginPath(); ctx.arc(x, y, R*0.42, 0, Math.PI*2); ctx.fill();
  var ringR = R * 0.74;
  var lg = ctx.createLinearGradient(x-ringR, y-ringR, x+ringR, y+ringR);
  lg.addColorStop(0, withAlpha(light, 0.45*p));
  lg.addColorStop(1, withAlpha(rgb,   0.35*p));
  ctx.strokeStyle = lg;
  ctx.lineWidth = Math.max(1.6, size * 0.035);
  ctx.shadowBlur = 18 * p;
  ctx.shadowColor = withAlpha(deep, 0.60*p);
  ctx.beginPath(); ctx.arc(x, y, ringR, 0, Math.PI*2); ctx.stroke();
  for (var i = 0; i < 3; i++){
    var ang = (i * 2.094) + t * 0.8 + idx * 0.3;
    var rr = R * 0.86;
    var sx = x + Math.cos(ang) * rr;
    var sy = y + Math.sin(ang) * rr;
    var sr = size * 0.028 * (0.8 + 0.4*Math.sin(t*3.2 + i + idx));
    ctx.shadowBlur = 10 + 10*p;
    ctx.shadowColor = withAlpha(rgb, 0.85);
    ctx.fillStyle = 'rgba(255,255,255,0.92)';
    ctx.beginPath(); ctx.arc(sx, sy, sr, 0, Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

function drawJackpotGlow(ctx, x, y, size){
  var t = (window.__cosmicT || 0);
  var p = 0.6 + 0.35 * Math.sin(t * 2.6);
  var R = size * 0.60;
  ctx.save(); ctx.globalCompositeOperation = 'lighter';
  var g = ctx.createRadialGradient(x, y, 0, x, y, R);
  g.addColorStop(0, 'rgba(255,240,180,' + (0.25+0.25*p).toFixed(3) + ')');
  g.addColorStop(1, 'rgba(255,160,40,0)');
  ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, R, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}


function drawSymbol(ctx, sym, x, y, size, spinning){
  if(sym===''){
    drawJackpotGlow(ctx, x, y, size);
    ctx.save();
    ctx.fillStyle='#ffea69';
    ctx.font='900 '+Math.floor(size*0.30)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowBlur = 16; ctx.shadowColor = 'rgba(255,208,102,0.85)';
    ctx.fillText('',x,y);
    ctx.restore();
    return;
  }
  var index=parseInt(sym,10); if(isNaN(index)||index<0||index>=ICON_URLS.length) return; if(!icons.ready) return; buildIconCache(size);
  var off=iconCache.canvases[index]; if(!off) return;
  if(!spinning){ drawZodiacGlow(ctx, x, y, size, index); }
  var dx=x-off.width*0.5, dy=y-off.height*0.5;
  try{ ctx.drawImage(off,dx,dy);}catch(_){}
}

var SYMBOLS=[0,1,2,3,4,5,6,7,8,9,10,11,12];

  // -----------------------------------------------------
  // SlotEngine (game logic)
  // -----------------------------------------------------
  function getPlayerName(){
    try{
      var tg=(window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:null;
      if(tg){ try{ tg.ready&&tg.ready(); }catch(_){ } var u=tg.initDataUnsafe&&tg.initDataUnsafe.user; if(u){
        var parts=[]; if(u.first_name) parts.push(u.first_name); if(u.last_name) parts.push(u.last_name);
        var full=parts.join(' ').trim(); if(full) return full; if(u.username) return u.username;
      }}
    }catch(_){}
    try{ var m=/[?&]name=([^&#]+)/.exec(location.search); if(m) return decodeURIComponent(m[1].replace(/\+/g,' ')); }catch(_){}
    try{ var ls=localStorage.getItem('slot_player_name'); if(ls) return ls; }catch(_){}
    return 'Player';
  }

  function drawNavIcon(ctx, type, cx, cy, size, grad){
    var s=size; ctx.save(); ctx.strokeStyle=grad; ctx.lineWidth=Math.max(2,Math.round(s*0.10)); ctx.lineJoin='round'; ctx.lineCap='round';
    if(type==='wallet'){ var w=s*1.2,h=s*0.75,r=s*0.18; var x=cx-w/2,y=cy-h/2; roundRectPath(ctx,x,y,w,h,r); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x+w*0.20,y+h*0.40); ctx.lineTo(x+w*0.80,y+h*0.40); ctx.stroke(); ctx.beginPath(); ctx.arc(x+w*0.80,y+h*0.52,s*0.06,0,Math.PI*2); ctx.stroke(); }
    else if(type==='home'){ var w2=s*1.15,h2=s*0.9; var x2=cx-w2/2,y2=cy-h2/2; ctx.beginPath(); ctx.moveTo(x2, y2+h2*0.45); ctx.lineTo(cx, y2); ctx.lineTo(x2+w2, y2+h2*0.45); ctx.stroke(); roundRectPath(ctx,x2+w2*0.15,y2+h2*0.40,w2*0.70,h2*0.48,s*0.10); ctx.stroke(); roundRectPath(ctx,x2+w2*0.44,y2+h2*0.56,w2*0.12,h2*0.22,s*0.06); ctx.stroke(); }
    else { var r2=s*0.65; ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx, cy - r2*0.55); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + r2*0.40, cy); ctx.stroke(); ctx.beginPath(); ctx.arc(cx, cy, s*0.08, 0, Math.PI*2); ctx.stroke(); }
    ctx.restore();
  }
  function drawNavButton(ctx,x,y,w,h,label,iconKey,active){
    var r=22; ctx.save(); ctx.globalAlpha=1; ctx.fillStyle='rgba(10, 16, 40, 0.55)'; roundRectPath(ctx,x,y,w,h,r); ctx.fill();
    ctx.shadowBlur=active?20:12; ctx.shadowColor=active?'rgba(110,231,255,0.6)':'rgba(124,58,237,0.35)';
    ctx.strokeStyle=active?'rgba(110,231,255,0.9)':'rgba(167,139,250,0.45)'; ctx.lineWidth=active?3:2;
    roundRectPath(ctx,x+1.5,y+1.5,w-3,h-3,r-2); ctx.stroke();
    var cx=x+w/2, cy=y+h*0.48; var grad=ctx.createLinearGradient(x,y,x+w,y+h);
    grad.addColorStop(0,'#6ee7ff'); grad.addColorStop(0.5,'#a78bfa'); grad.addColorStop(1,'#7dd3fc');
    var baseIconSize=Math.max(26,Math.round(h*0.48));
    var iconSize=iconKey==='history'?Math.round(baseIconSize*0.8):baseIconSize;
    drawNavIcon(ctx, iconKey, cx, cy, iconSize, grad);
    var labelPx=Math.max(16,Math.round(h*0.32)); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='700 '+labelPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.fillStyle=grad; ctx.shadowBlur=active?14:8; ctx.shadowColor='rgba(109, 40, 217, 0.45)'; ctx.fillText(label,cx,y+h*0.78);
    if(active){ ctx.save(); var ug=ctx.createLinearGradient(x,y,x+w,y); ug.addColorStop(0,'#6ee7ff'); ug.addColorStop(1,'#a78bfa'); ctx.strokeStyle=ug; ctx.lineWidth=3.2; ctx.shadowBlur=12; ctx.shadowColor='rgba(110,231,255,0.6)'; ctx.beginPath(); ctx.moveTo(x+16,y+6); ctx.lineTo(x+w-16,y+6); ctx.stroke(); ctx.restore(); }
    ctx.restore();
  }
  function drawRowMask(ctx, x, y, w, h, t, label){
    ctx.save();
    var g=ctx.createLinearGradient(x,y,x+w,y+h);
    g.addColorStop(0,'rgba(10,16,40,0.85)'); g.addColorStop(1,'rgba(20,12,40,0.85)');
    ctx.fillStyle=g; ctx.shadowBlur=20; ctx.shadowColor='rgba(167,139,250,0.35)'; ctx.fillRect(x,y,w,h);
    ctx.globalCompositeOperation='lighter';
    for(var i=0;i<22;i++){
      var sx=x + ((i*53+Math.sin(t+i)*97)%w);
      var sy=y + ((i*19+Math.cos(t*1.3+i)*71)%h);
      ctx.beginPath(); ctx.arc(sx,sy,1.2 + Math.abs(Math.sin(t*2+i))*0.8,0,Math.PI*2);
      ctx.fillStyle='rgba(110,231,255,0.35)'; ctx.fill();
    }
    ctx.globalCompositeOperation='source-over';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='900 '+Math.round(h*0.35)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    var lg=ctx.createLinearGradient(x,y,x+w,y); lg.addColorStop(0,'#ffd066'); lg.addColorStop(1,'#ff5a0a');
    ctx.fillStyle=lg; ctx.fillText(label, x+w/2, y+h/2);
    ctx.restore();
  }
  function drawCelebration(ctx, x, y, w, h, t){
    ctx.save();
    for(var i=0;i<10;i++){
      var p=(t*1.2 + i*0.12)%1; var sx=x + p*w; var sy=y + (i%2? h*0.2 : h*0.8);
      var ex=sx+Math.min(80,w*0.18); var ey=sy+(i%2? -8:8);
      var g=ctx.createLinearGradient(sx,sy,ex,ey);
      g.addColorStop(0,'rgba(167,139,250,0.0)'); g.addColorStop(1,'rgba(110,231,255,0.9)');
      ctx.strokeStyle=g; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(ex,ey); ctx.stroke();
    }
    ctx.restore();
  }
  function drawCoin(ctx, x, y, r){
    ctx.save();
    var g=ctx.createLinearGradient(x-r, y-r, x+r, y+r);
    g.addColorStop(0,'#ffd066'); g.addColorStop(0.5,'#ffb34a'); g.addColorStop(1,'#ff8a1a');
    ctx.fillStyle=g; ctx.shadowBlur=12; ctx.shadowColor='rgba(255,208,102,0.8)';
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=2; ctx.strokeStyle='rgba(255,240,210,0.65)';
    ctx.beginPath(); ctx.arc(x,y,r*0.65,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }
  function easeOutCubic(u){return 1-Math.pow(1-u,3);}
  function easeOutCubicDerivative(u){ return 3*Math.pow(1-u,2); }
  function imod(n,m){return ((n%m)+m)%m;}
  function easeOutBounce(u){ var n1=7.5625, d1=2.75; if(u<1/d1){ return n1*u*u; } else if(u<2/d1){ u-=1.5/d1; return n1*u*u+0.75; } else if(u<2.5/d1){ u-=2.25/d1; return n1*u*u+0.9375; } else { u-=2.625/d1; return n1*u*u+0.984375; } }

  function SlotEngine(root){
  try{ window.__lastSlotInstance=this; }catch(_){}

    this.canvas=document.createElement('canvas'); this.ctx=this.canvas.getContext('2d'); root.appendChild(this.canvas);
    this.W=CONFIG.width; this.H=CONFIG.height; this.balance=CONFIG.startBalance; this.balanceVis=this.balance; this.bet=Math.max(1,Math.floor(CONFIG.bet||1));
    this.machineCenter={ x:this.W/2, y:this.H*0.430 };
    this.bg = {update:function(){}, draw:function(){}};
    this.reels=[]; this.buttonPressed=false;
    this.betRect=this.betPlusRect=this.betMinusRect=null; this.plusPressed=false; this.minusPressed=false; this.editingBet=false; this.betDraft=String(this.bet); this._caretBlink=0;
    this.playerName=getPlayerName(); this.showFPS=false; this.fpsEMA=60; this.fpsRect={x:16,y:16,w:86,h:32};
    this.nav={ active:'home', items:[ {key:'wallet',label:'Wallet',icon:'wallet'}, {key:'home',label:'Home',icon:'home'}, {key:'history',label:'History',icon:'history'} ], rects:[] };

    this.winState='idle'; this._countInt=0;
    this.hiddenRow=-1; this.countdown=0; this.rowHitRect=null; this._celebrateT=0; this.winAmount=0; this._drop={t:0,dur:0.35,hit:false,boom:0};
    this._pendingBangPlayed=false; this._shake={mag:0,time:0};

    for(var i=0;i<CONFIG.reelCount;i++){
      this.reels.push({
        finalSymbols:Array.from({length:CONFIG.rows},function(){return SYMBOLS[(Math.random()*SYMBOLS.length)|0];}),
        spinning:false, dir:REEL_DIR[i]||1, time:0,
        duration:CONFIG.spinBaseDuration+i*CONFIG.spinStagger,
        totalDistPx:0, progressPx:0
      });
    }




SlotEngine.prototype.startIntro = function(){
  this.intro.active = true;
  this.intro.offsets = [-this.H, -this.H, -this.H];
  this.intro.started = [false,false,false];
  this.intro.done    = [false,false,false];
  var self=this, order=[2,1,0], gapMs=120;
  order.forEach(function(ri, idx){
    setTimeout(function(){
      if(!self||!self.intro) return;
      self.intro.started[ri]=true;
      try{
        var el=document.getElementById('sfxWhoosh');
        if(el){ var c=el.cloneNode(true); c.volume=0.9; c.play().catch(function(){}); }
      }catch(_){}
    }, idx*gapMs);
  });
};

this.intro = { active:false, offsets:[0,0,0], started:[false,false,false], done:[false,false,false] };
    this._resize(); var self=this; window.addEventListener('resize',function(){ self._resize(); });
    this.last=performance.now(); this.time=0; var that=this; requestAnimationFrame(function(t){ that._loop(t); });

    var betInput=document.getElementById('betInput');
    function commitBet(){ var v=parseInt(self.betDraft||betInput.value,10); if(!isFinite(v)||v<1){ self._hideEditor(); return; } self.setBet(v); self.betDraft=String(self.bet); self._hideEditor(); self._draw(); }
    betInput.addEventListener('input', function(){ var raw=String(betInput.value||'').replace(/[^0-9]/g,''); if(raw.length>1 && raw[0]==='0') raw=raw.replace(/^0+/,'')||'0'; self.betDraft=raw||'1'; self._draw(); });
    betInput.addEventListener('change',commitBet); betInput.addEventListener('blur',commitBet);
    this._showEditor=function(){ self.editingBet=true; self.betDraft=String(self.bet); betInput.value=self.betDraft; try{ betInput.focus(); betInput.select(); }catch(_){ } };
    this._hideEditor=function(){ self.editingBet=false; try{ betInput.blur(); }catch(_){ } };
    betInput.addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); commitBet(); } if(e.key==='Escape'){ e.preventDefault(); self._hideEditor(); self._draw(); } });

    var pressActive=false; var selfRef=this; var audioArmed=false;
    var canvasToGame=function(ev){ var r=selfRef.canvas.getBoundingClientRect(); return {x:(ev.clientX-r.left)/r.width*selfRef.W,y:(ev.clientY-r.top)/r.height*selfRef.H}; };
    var withinRect=function(p,r){ return r && p.x>=r.x && p.x<=r.x+r.w && p.y>=r.y && p.y<=r.y+r.h; };
    var withinButton=function(p){ var L=selfRef._computeLayout(); var R=L.radius; var dx=p.x-L.cx, dy=p.y-L.cy; return dx*dx+dy*dy<=R*R; };
    var withinNav=function(p){ if(!selfRef.nav||!selfRef.nav.rects||!selfRef.nav.rects.length) return -1; for(var i=0;i<selfRef.nav.rects.length;i++){ if(withinRect(p,selfRef.nav.rects[i])) return i; } return -1; };

    function armAudio(){
      if(audioArmed) return; audioArmed=true;
      try{ AudioSys.unlock(); }catch(_){}
      ['spinSound','bangSound','coinSound'].forEach(function(id){
        var a=document.getElementById(id);
        try{ if(a){ a.muted=false; a.currentTime=0; var p=a.play(); if(p&&p.then){ p.then(function(){ try{ a.pause(); a.currentTime=0; }catch(_){ } }).catch(function(){}); } } }catch(_){}
      });
      var sh=document.getElementById('soundHint'); if(sh) sh.style.display='none';
    }

    this.canvas.addEventListener('pointerdown',function(e){ var p=canvasToGame(e); armAudio(); if(selfRef.winState!=='idle'){ return; } 
      // +/- button press state (for 3D pressed look)
      if(selfRef.betPlusRect && withinRect(p,selfRef.betPlusRect)){ selfRef.plusPressed=true; selfRef._draw(); return; }
      if(selfRef.betMinusRect && withinRect(p,selfRef.betMinusRect)){ selfRef.minusPressed=true; selfRef._draw(); return; }
if(withinButton(p)){ pressActive=true; selfRef.buttonPressed=true; selfRef._draw(); } });
    ['click','touchstart','keydown'].forEach(function(ev){ document.addEventListener(ev, armAudio, {once:true,capture:true}); });
    document.addEventListener('visibilitychange', function(){ if(document.visibilityState==='visible'){ try{ var c=AudioSys.ensure(); if(c&&c.state==='suspended') c.resume(); }catch(_){ } } });
    this.canvas.addEventListener('pointerup',function(e){ var p=canvasToGame(e); var was=pressActive; pressActive=false; selfRef.buttonPressed=false; selfRef._draw();
      if(selfRef.winState==='hidden' && withinRect(p,selfRef.rowHitRect)){ selfRef._startCountdown(3); return; }
      if(selfRef.winState==='countdown' && withinRect(p,selfRef.rowHitRect)){ selfRef.countdown = Math.min(selfRef.countdown, 0.2); return; }
      if(selfRef.winState!=='idle'){ return; }
      if(withinRect(p, selfRef.fpsRect)) { selfRef.toggleFPS(); return; }
      var ni=withinNav(p); if(ni>=0){ var it=selfRef.nav.items[ni]; if(it) selfRef.selectTab(it.key); return; }
      if(was && withinButton(p)){ selfRef._spin(); return; }
      if(withinRect(p,selfRef.betPlusRect)){ selfRef.plusPressed=false; selfRef.minusPressed=false; selfRef._draw(); selfRef.incBet(+1); return; }
      if(withinRect(p,selfRef.betMinusRect)){ selfRef.plusPressed=false; selfRef.minusPressed=false; selfRef._draw(); selfRef.incBet(-1); return; }
      if(withinRect(p,selfRef.betRect)){ selfRef._showEditor(); return; }
    });
    this.canvas.addEventListener('pointercancel',function(){ pressActive=false; selfRef.buttonPressed=false; selfRef.plusPressed=false; selfRef.minusPressed=false; selfRef._draw(); });
    this.canvas.addEventListener('pointerleave',function(){ if(pressActive){ selfRef.buttonPressed=false; } selfRef.plusPressed=false; selfRef.minusPressed=false; selfRef._draw(); });

    window.addEventListener('keydown',function(e){ if(e.key==='f'||e.key==='F'){ selfRef.toggleFPS(); } if(e.key==='+'){ selfRef.incBet(+1); } if(e.key==='-'){ selfRef.incBet(-1); } });
  }

  SlotEngine.prototype._resize=function(){
    var dpr=Math.min(2,Math.max(1,window.devicePixelRatio||1));
    var vw=(window.visualViewport?window.visualViewport.width:window.innerWidth);
    var vh=(window.visualViewport?window.visualViewport.height:window.innerHeight);
    var scale=Math.min(vw/CONFIG.width, vh/CONFIG.height);
    this.canvas.width=CONFIG.width*dpr; this.canvas.height=CONFIG.height*dpr;
    this.canvas.style.width=Math.floor(CONFIG.width*scale)+'px';
    this.canvas.style.height=Math.floor(CONFIG.height*scale)+'px';
    this.ctx.setTransform(dpr,0,0,dpr,0,0);
    // keep splash perfectly matched to canvas size
    if (typeof syncSplashToCanvas === 'function') syncSplashToCanvas();
  };
  SlotEngine.prototype._computeLayout=function(){
    var cell=CONFIG.symbolSize, rows=CONFIG.rows, reelsN=CONFIG.reelCount;
    var totalW=reelsN*cell+(reelsN-1)*CONFIG.reelSpacing;
    var startX=this.machineCenter.x-totalW/2+cell/2;
    var topY=this.machineCenter.y-rows*cell/2;
    var frameBottom=topY+rows*cell;
    var radius=Math.min(totalW*0.18,160);
    var buttonOffset=Math.round(cell*0.22);
    var cx=this.machineCenter.x;
    var cy=frameBottom+radius*0.70+buttonOffset;
cy -= 40; // move up by 50px to fit spin panel
    var betGap=34;
    var bottomExtent=cy+radius+betGap;
    var safeBottom=16, safeTop=16;
    if(bottomExtent>this.H-safeBottom){
      var room=(this.H-safeBottom)-(frameBottom+betGap);
      var maxR=Math.max(48,room/1.6);
      radius=Math.min(radius,maxR);
      cy=frameBottom+radius*0.70+buttonOffset;
    }
    if(topY<safeTop){
      var needDown=safeTop-topY;
      topY+=needDown; frameBottom=topY+rows*cell; cy=frameBottom+radius*0.70+buttonOffset;
    }
    return {cell:cell,rows:rows,reelsN:reelsN,totalW:totalW,startX:startX,topY:topY,frameBottom:frameBottom,cx:cx,cy:cy,radius:radius,betGap:betGap,buttonOffset:buttonOffset};
  };
  SlotEngine.prototype._spin=function(){
    if(this.winState!=='idle') return;
    if(this.reels.some(function(r){return r.spinning;})) return;
    try{ AudioSys.playSpin(); }catch(_){ var sfx=document.getElementById('spinSound'); try{ sfx&&sfx.play&&sfx.play(); }catch(__){} }
    for(var i=0;i<this.reels.length;i++){
      var r=this.reels[i], arr=new Array(CONFIG.rows);
      for(var k=0;k<CONFIG.rows;k++){ arr[k]=SYMBOLS[(Math.random()*SYMBOLS.length)|0]; }
      r.finalSymbols=arr; r.spinning=true; r.time=0; r.duration=CONFIG.spinBaseDuration+i*CONFIG.spinStagger;
      var cycles=CONFIG.cyclesBase+i*CONFIG.cyclesStep; r.totalDistPx=cycles*CONFIG.rows*CONFIG.symbolSize; r.progressPx=0;
    }
    try{ AudioSys.resetTicker(); }catch(_){}
  };
  SlotEngine.prototype.setBet=function(v){ this.bet=Math.max(1,Math.floor(v)); };
  SlotEngine.prototype.incBet=function(d){ this.setBet(this.bet+d); this._draw(); };
  SlotEngine.prototype.selectTab=function(key){ for(var i=0;i<this.nav.items.length;i++){ if(this.nav.items[i].key===key){ this.nav.active=key; break; } } this._draw(); };
  SlotEngine.prototype.toggleFPS=function(){ this.showFPS=!this.showFPS; this._draw(); };
  SlotEngine.prototype._beginTransfer=function(){
    if(!this.transfer) this.transfer={};
    this.transfer.active=true; this.transfer.t=0; this.transfer.p=0; this.transfer.committed=false;
    var n=18; this.transfer.coins=[];
    for(var i=0;i<n;i++){
      var delay=i/(n*1.4), r=6 + Math.random()*4;
      var cx=this.transfer.srcX + (Math.random()*2-1)*80;
      var cy=this.transfer.srcY - 120 - Math.random()*120;
      this.transfer.coins.push({delay:delay,r:r,cx:cx,cy:cy,sfx:false});
    }
  };
  SlotEngine.prototype._allStopped=function(){ for(var i=0;i<this.reels.length;i++){ if(this.reels[i].spinning) return false; } return true; };
  function computeWinAmount(sym, bet){ var idx=parseInt(sym,10); if(!isFinite(idx)) return bet*5; var mult = 6 + (idx%4)*4; return bet * mult; }
  
SlotEngine.prototype._checkForWin=function(){
  var rows = (typeof CONFIG!=='undefined' && CONFIG && CONFIG.rows) ? CONFIG.rows : 3;
  var anyWin=false, found=false;

  try{
    var makeHash = function(){
      var out=[];
      for(var ri=0; ri<rows; ri++){
        var a=(this.reels[0]&&this.reels[0].finalSymbols[ri])||'';
        var b=(this.reels[1]&&this.reels[1].finalSymbols[ri])||'';
        var c=(this.reels[2]&&this.reels[2].finalSymbols[ri])||'';
        out.push([a,b,c].join(','));
      }
      return out.join('|');
    }.bind(this);
    var cur = makeHash();
    if(!this.__lastComboHash){ this.__lastComboHash = cur; return false; }
    if(this.__lastComboHash === cur){ return false; }
    this.__lastComboHash = cur;
  }catch(_){}

  var JACKPOT_INDEX = -1;
  try{
    if (typeof ICON_URLS !== 'undefined' && ICON_URLS && ICON_URLS.length){
      for (var i=0;i<ICON_URLS.length;i++){
        var s=String(ICON_URLS[i]||'');
        if(/zodiac_13(?:\.[a-z0-9]+)?(?:\?.*)?$/i.test(s) || /zodiac_13/i.test(s)){ JACKPOT_INDEX=i; break; }
      }
    }
  }catch(e){}
  if (JACKPOT_INDEX < 0) JACKPOT_INDEX = 12;

  var TWO_MATCH_RATIO = 0.5;
  function toId(x){ if(typeof x==='string' && /^\d+$/.test(x)) return parseInt(x,10); return x; }
  function eq(x,y){ x=toId(x); y=toId(y); return x===y; }
  function isJack(sym){
    try{
      sym=toId(sym);
      if (sym===JACKPOT_INDEX) return true;
      if (typeof sym==='string'){
        return (/zodiac_13(?:\.[a-z0-9]+)?(?:\?.*)?$/i.test(sym) || /zodiac_13/i.test(sym));
      }
      if (typeof sym==='number' && typeof ICON_URLS!=='undefined'){
        var u=ICON_URLS[sym]||''; return (/zodiac_13(?:\.[a-z0-9]+)?(?:\?.*)?$/i.test(u) || /zodiac_13/i.test(u));
      }
    }catch(e){}
    return false;
  }
  function logHistory(kind, bet, payout){
    try{
      var table=document.getElementById('historyTable'); if(!table) return;
      var tb=table.querySelector('tbody'); if(!tb) return;
      var tr=document.createElement('tr');
      var t=new Date(); var timeStr=t.toLocaleTimeString();
      tr.innerHTML = '<td>'+timeStr+'</td><td>$'+bet+'</td><td>'+kind+'</td><td>$'+payout+'</td>';
      tb.prepend(tr);
    }catch(e){}
  }

  for (var r=0; r<rows; r++){
    if(found) { continue; }
    var a=this.reels[0].finalSymbols[r];
    var b=this.reels[1].finalSymbols[r];
    var c=this.reels[2].finalSymbols[r];
    if(a===''||b===''||c==='') continue;
    var A=toId(a), B=toId(b), C=toId(c);

    if (eq(A,B) && eq(B,C) && isJack(A)){
      var baseJ = (typeof computeWinAmount==='function') ? computeWinAmount(A, this.bet) : (this.bet||1);
      var winJ = Math.round(baseJ * 5);
      this.balance = (this.balance||0) + winJ; this.winAmount = winJ; this.hiddenRow=-1; this.winState='idle';
      anyWin=true; found=true;
      try{ (window.showJackpotOverlay||window.showJackpot||window.jackpotWin||function(){})(); }catch(e){}
      logHistory('JACKPOT', this.bet, winJ);
    }
    else if (eq(A,B) && eq(B,C) && !isJack(A)){
      var win3 = (typeof computeWinAmount==='function') ? computeWinAmount(A, this.bet) : (this.bet||1);
      this.balance = (this.balance||0) + win3; this.winAmount = win3; this.hiddenRow=-1; this.winState='idle';
      anyWin=true; found=true;
      try{ (window.showBigWinOverlay||window.showBigWin||window.bigWin||function(){})(); }catch(e){}
      logHistory('3-match', this.bet, win3);
    }
    else if ((eq(A,B) && !eq(A,C) && !isJack(A)) || (eq(B,C) && !eq(B,A) && !isJack(B))){
      var matched = eq(A,B) ? A : B;
      var base2 = (typeof computeWinAmount==='function') ? computeWinAmount(matched, this.bet) : (this.bet||1);
      var win2 = Math.max(1, Math.round(base2 * TWO_MATCH_RATIO));
      this.balance = (this.balance||0) + win2; this.winAmount = win2; this.hiddenRow=-1; this.winState='idle';
      anyWin=true; found=true;
      try{ (window.showBigWinOverlay||window.showBigWin||window.bigWin||function(){})(); }catch(e){}
      logHistory('2-match', this.bet, win2);
    }
  }
  return anyWin;
};

  SlotEngine.prototype._startCountdown=function(){ this.winState='countdown'; this.countdown=3; this._countInt=4; };
  SlotEngine.prototype._triggerReveal=function(){ this.winState='revealing'; this._celebrateT=1.6; this._drop.t=0; this._drop.hit=false; this._drop.boom=0; this._drop.dur=0.35; this._pendingBangPlayed=false; this.transfer={active:false,t:0,p:0,dur:2.0,coins:[],committed:false, srcX:0,srcY:0,tgtX:this.W-40,tgtY:26}; };
  SlotEngine.prototype._updateReels=function(dt){
    
  // Intro drop animation
  if (this.intro && this.intro.active) {
    var speedPx = Math.max(1200, this.H * 2.2);
    var allDone = true;
    for (var ri=0; ri<this.reels.length; ri++) {
      if (this.intro.started[ri] && !this.intro.done[ri]) {
        var y = this.intro.offsets[ri];
        y += speedPx * dt;
        if (y >= 0) { y = 0; this.intro.done[ri] = true; }
        this.intro.offsets[ri] = y;
      }
      if (!this.intro.done[ri]) allDone = false;
    }
    if (allDone) this.intro.active = false;
  }
for(var i=0;i<this.reels.length;i++){
      var r=this.reels[i]; if(!r.spinning) continue;
      r.time+=dt; var u=Math.min(1,r.time/r.duration); var eased=easeOutCubic(u);
      r.progressPx=r.totalDistPx*eased; if(u>=1){ r.spinning=false; r.progressPx=r.totalDistPx; }
    }
    // adaptive tick speed
    var anySpinning=false, maxV=0, maxV0=0;
    for(var j=0;j<this.reels.length;j++){
      var rr=this.reels[j];
      if(rr.spinning){
        anySpinning=true;
        var u=Math.min(1, rr.time/rr.duration);
        var v = rr.totalDistPx * easeOutCubicDerivative(u) / rr.duration;
        if(v>maxV) maxV=v;
        var v0 = rr.totalDistPx * 3 / rr.duration; // derivative at u=0
        if(v0>maxV0) maxV0=v0;
      }
    }
    if(anySpinning){
      var minHz=6, maxHz=18;
      var norm = (maxV0>0)? (maxV / maxV0) : 0;
      var targetHz = minHz + norm*(maxHz-minHz);
      try{ AudioSys.tick(dt, targetHz); }catch(_){}
    }

    if(this.winState==='idle' && this._allStopped()){
      this._checkForWin();
    }
    if(this.winState==='countdown'){
      var prev=Math.ceil(this.countdown);
      this.countdown -= dt; var nowI=Math.ceil(Math.max(0,this.countdown));
      if(nowI!==prev && nowI>0){ try{ AudioSys.playCountdown(nowI); }catch(_){ } }
      if(this.countdown<=0){ this._triggerReveal(); }
    }
    if(this.winState==='revealing'){
      this._celebrateT -= dt;
      if(!this._drop.hit){
        this._drop.t += dt / this._drop.dur;
        if(this._drop.t>=1){
          this._drop.t=1; this._drop.hit=true; this._drop.boom=0.6;
          if(!this._pendingBangPlayed){ try{ AudioSys.playBang(); }catch(_){ var bang=document.getElementById('bangSound'); try{ bang&&bang.play&&bang.play(); }catch(__){} } this._pendingBangPlayed=true; }
          this._shake.mag = Math.max(24, Math.round(CONFIG.symbolSize*0.28));
          this._shake.time = 0.55;
        }
      } else {
        if(this.transfer && !this.transfer.active){ this._beginTransfer(); }
        if(this.transfer && this.transfer.active){
          this.transfer.t = Math.min(1, this.transfer.t + dt/this.transfer.dur);
          this.transfer.p = easeOutCubic(this.transfer.t);
          this.balanceVis = this.balance + this.winAmount * this.transfer.p;
          if(this.transfer.t>=1 && !this.transfer.committed){
            this.balance += this.winAmount; this.balanceVis=this.balance; this.winAmount=0; this.transfer.committed=true;
            this._celebrateT = Math.min(this._celebrateT, 0.3);
          }
        }
        if(this._drop.boom>0){ this._drop.boom -= dt; }
      }
      if(this._shake.time>0){ this._shake.time = Math.max(0, this._shake.time - dt); }
      if(this._celebrateT<=0){ this.winState='idle'; this.hiddenRow=-1; }
    }
    this.bg.update(dt); this._caretBlink += dt;
  };
  SlotEngine.prototype._loop=function(t){
    var dt=(t-this.last)/1000; this.last=t; if(dt<0||!isFinite(dt)) dt=0;
    if(dt>0){ var fps=1/dt; var a=0.15; this.fpsEMA=this.fpsEMA*(1-a)+fps*a; }
    this.time+=dt; this._updateReels(dt); this._draw();
    var self=this; requestAnimationFrame(function(tt){ self._loop(tt); });
  };
  SlotEngine.prototype._draw=function(){
    var spinningAny = !this._allStopped(); var ctx=this.ctx; ctx.clearRect(0,0,this.W,this.H); window.__cosmicT = (this.time || 0); this.bg.draw(ctx); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality=(spinningAny ? 'low' : 'medium');
    var shakeX=0, shakeY=0; if(this._shake && this._shake.time>0){ var s=this._shake; var k=s.time/0.55; var m=s.mag*(k*k); shakeX=(Math.random()*2-1)*m; shakeY=(Math.random()*2-1)*m; ctx.save(); ctx.translate(shakeX, shakeY); }
    var L=this._computeLayout(); 
// Draw spin panel behind SPIN (UI context)
var cell=L.cell, rows=L.rows, reelsN=L.reelsN, totalW=L.totalW, startX=L.startX, topY=L.topY;

    
ctx.save();
ctx.beginPath();
const VISIBLE_PAD = Math.round(cell * 0.09); // add top & bottom padding to visible area
ctx.rect(startX - cell/2, topY - VISIBLE_PAD, totalW, rows * cell + 2 * VISIBLE_PAD);
ctx.clip();

    for(var ri=0;ri<reelsN;ri++){
      var rx=startX+ri*(cell+CONFIG.reelSpacing); var reel=this.reels[ri]; var distPx=reel.progressPx; var whole=(distPx/cell)|0; var frac=distPx-whole*cell; var shift=reel.dir*whole; var fracPx=reel.dir*frac; 
      for(var k=0;k<rows+2;k++){ var visIndex=imod(k-1-shift,rows); var sym=reel.finalSymbols[visIndex]; var introDy=(this.intro&&this.intro.offsets?(this.intro.offsets[ri]||0):0);
      var cy=topY+(k-1)*cell+fracPx+cell*0.5+introDy; drawSymbol(ctx, sym, rx, cy, cell, spinningAny); }
    }
    ctx.restore();

    if(this.hiddenRow>=0){
      var rxv=startX - cell/2; var ryv=topY + this.hiddenRow*cell; var rwv=totalW; var rhv=cell;
      this.rowHitRect={x:rxv,y:ryv,w:rwv,h:rhv};
      if(this.winState==='hidden'){
        drawRowMask(ctx, rxv, ryv, rwv, rhv, this.time, 'Tap to reveal');
      } else if(this.winState==='countdown'){
        drawRowMask(ctx, rxv, ryv, rwv, rhv, this.time, String(Math.ceil(this.countdown)));
      } else if(this.winState==='revealing'){
        drawCelebration(ctx, rxv, ryv, rwv, rhv, (1.6-this._celebrateT)/1.6);
        var centerX = rxv + rwv/2; var startY = -Math.max(40, this.H*0.22); var endY=ryv + rhv*0.52; var u=Math.max(0,Math.min(1,this._drop.t));
        var y=startY + (endY-startY)*easeOutBounce(u);
        if(!this._drop.hit){
          ctx.save(); var trail=ctx.createLinearGradient(centerX, 0, centerX, y); trail.addColorStop(0,'rgba(255,255,255,0.0)'); trail.addColorStop(1,'rgba(255,208,102,0.9)'); ctx.strokeStyle=trail; ctx.lineWidth=2; ctx.shadowBlur=12; ctx.shadowColor='rgba(255,208,102,0.7)'; ctx.beginPath(); ctx.moveTo(centerX, 0); ctx.lineTo(centerX, y-4); ctx.stroke(); ctx.restore();
        }
        if(this._drop.hit && this.transfer && !this.transfer.active && !this.transfer.srcSet){ this.transfer.srcX=centerX; this.transfer.srcY=endY; this.transfer.srcSet=true; }
        var prog = (this.transfer&&this.transfer.active)? (this.transfer.p||0) : 0; var shown = Math.round(this.winAmount * (1 - prog));
        var jitter=(this._drop.hit && this._drop.boom>0)?(Math.sin(this.time*80)*3):0;
        ctx.save();
        ctx.fillStyle = '#ffff00'; // plain yellow amount
        ctx.textAlign='center'; ctx.textBaseline='middle';
        var fontPx=Math.max(26,Math.round(cell*0.40));
        var scale=(this._drop.hit && this._drop.boom>0)? 1 + Math.max(0,this._drop.boom)*0.4 : 1;
        ctx.font='900 '+Math.round(fontPx*scale)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.shadowBlur=16; ctx.shadowColor='rgba(255,240,0,0.75)';
        ctx.fillText((shown>0?'+$'+shown:''), centerX + jitter, y);
        ctx.restore();

        if(this._drop.hit && this._drop.boom>0){
          var k=1 - this._drop.boom / 0.6; var rr=rhv*(0.25 + k*0.55);
          ctx.save(); ctx.strokeStyle='rgba(255,208,102,'+(1-k)+')'; ctx.lineWidth=3 + 4*(1-k); ctx.beginPath(); ctx.arc(centerX, endY, rr, 0, Math.PI*2); ctx.stroke(); ctx.restore();
        }

        if(this.transfer && this.transfer.active){
          var p=this.transfer.p; var tgtX=this.transfer.tgtX, tgtY=this.transfer.tgtY; var srcX=this.transfer.srcX, srcY=this.transfer.srcY;
          for(var ci=0; ci<this.transfer.coins.length; ci++){
            var C=this.transfer.coins[ci]; var tt=Math.min(1, Math.max(0, (p - C.delay) / (1 - C.delay)));
            if(tt>0 && !C.sfx){ if(Math.random() < 0.7){ try{ AudioSys.playCoin(); }catch(_){ } } C.sfx = true; }
            if(tt<=0) continue;
            var q=tt*tt*(3-2*tt);
            var bx=(1-q)*(1-q)*srcX + 2*(1-q)*q*C.cx + q*q*tgtX;
            var by=(1-q)*(1-q)*srcY + 2*(1-q)*q*C.cy + q*q*tgtY;
            drawCoin(ctx, bx, by, C.r);
          }
        }
      }
    } else { this.rowHitRect=null; }

    for(var ri=1;ri<reelsN;ri++){ var lineX=startX-cell/2+ri*(cell+CONFIG.reelSpacing)-CONFIG.reelSpacing/2; drawDividerLine(ctx,lineX,topY,rows,cell,this.time); }
    var gapPx=Math.max(1,Math.round(cell*FRAME_GAP_FRAC)); var fx=startX-cell/2-gapPx, fy=topY-gapPx, fw=totalW+gapPx*2, fh=rows*cell+gapPx*2; drawLavaFrame(ctx,fx,fy,fw,fh,FRAME_RADIUS,this.time);

    var cx=L.cx, cy=L.cy, radius=L.radius; //drawLavaButton(ctx,cx,cy,radius,this.time,this.buttonPressed);

    // welcome
    ctx.save(); var welcomeFontPx=Math.max(18,Math.round(cell*0.18)); var welcomeGrad=ctx.createLinearGradient(16,16,220,36); welcomeGrad.addColorStop(0,'#ffd066'); welcomeGrad.addColorStop(1,'#ff5a0a'); ctx.fillStyle=welcomeGrad; ctx.font='800 '+welcomeFontPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.shadowBlur=8; ctx.shadowColor='rgba(255,120,30,0.55)'; var welcomeText='Hi, '+this.playerName+' ðŸ‘‹'; var maxWelcomeW=Math.min(this.W*0.6,420); var wt=ctx.measureText(welcomeText); if(wt.width>maxWelcomeW){ while(welcomeText.length>4 && ctx.measureText(welcomeText+'â€¦').width>maxWelcomeW){ welcomeText=welcomeText.slice(0,-1); } welcomeText+='â€¦'; } ctx.fillText(welcomeText,16,16); ctx.restore();

    // FPS chip
    ctx.save(); var frY=16+welcomeFontPx+8; this.fpsRect.y=frY; var fr=this.fpsRect; var rr=12; ctx.fillStyle='rgba(8,12,30,0.55)'; ctx.shadowBlur=10; ctx.shadowColor='rgba(109,40,217,0.35)'; roundRectPath(ctx,fr.x,fr.y,fr.w,fr.h,rr); ctx.fill(); var fg=ctx.createLinearGradient(fr.x,fr.y,fr.x+fr.w,fr.y+fr.h); fg.addColorStop(0,'rgba(167,139,250,0.9)'); fg.addColorStop(1,'rgba(110,231,255,0.9)'); ctx.lineWidth=2; ctx.strokeStyle=fg; ctx.stroke(); var textG=ctx.createLinearGradient(fr.x,fr.y,fr.x+fr.w,fr.y); textG.addColorStop(0,'#6ee7ff'); textG.addColorStop(1,'#a78bfa'); ctx.shadowBlur=8; ctx.shadowColor='rgba(110,231,255,0.4)'; ctx.font='700 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillStyle=textG; ctx.fillText('FPS', fr.x+10, fr.y+fr.h/2); if(this.showFPS){ var txt=(this.fpsEMA||0).toFixed(0); ctx.textAlign='right'; ctx.fillText(txt, fr.x+fr.w-10, fr.y+fr.h/2); } ctx.restore();

    // balance
    ctx.save(); var balFontPx=Math.max(24,Math.round(cell*0.26)); var moneyGrad=ctx.createLinearGradient(this.W-200,0,this.W,60); moneyGrad.addColorStop(0,'#ffd066'); moneyGrad.addColorStop(1,'#ff5a0a'); ctx.fillStyle=moneyGrad; ctx.font='900 '+balFontPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='right'; ctx.textBaseline='top'; ctx.shadowBlur=10; ctx.shadowColor='rgba(255,120,30,0.65)'; ctx.fillText('$'+Math.round(this.balanceVis),this.W-30,50); ctx.restore();

    
// bet UI (legacy) removed completely


    var navH2=Math.max(64,Math.round(cell*NAV_HEIGHT_FRAC)); this._drawNav(ctx,L,navH2);

    if(this._shake && this._shake.time>0){ ctx.restore(); }
  };
  SlotEngine.prototype._drawNav=function(ctx,L,navH){ return;
    var pad=12; var w=this.W-pad*2; var h=navH; var x=pad; var y=this.H-h-8;
    ctx.save(); ctx.globalAlpha=1; ctx.fillStyle='rgba(8,12,30,0.55)'; roundRectPath(ctx,x,y,w,h,26); ctx.fill();
    var bg=ctx.createLinearGradient(x,y,x+w,y+h); bg.addColorStop(0,'rgba(167,139,250,0.55)'); bg.addColorStop(1,'rgba(110,231,255,0.55)');
    ctx.strokeStyle=bg; ctx.lineWidth=2; ctx.shadowBlur=14; ctx.shadowColor='rgba(109,40,217,0.35)'; ctx.stroke();
    ctx.shadowBlur=0; ctx.globalAlpha=1; ctx.restore();
    var n=this.nav.items.length; var bw=w/n; this.nav.rects=[];
    for(var i=0;i<n;i++){
      var bx=x+i*bw, by=y; var rect={x:bx,y:by,w:bw,h:h}; this.nav.rects.push(rect);
      var it=this.nav.items[i];
      drawNavButton(ctx, rect.x+8, rect.y+8, rect.w-16, rect.h-16, it.label, it.icon, this.nav.active===it.key);
    }
  };

  // -----------------------------------------------------
  // Minimal self test
  // -----------------------------------------------------
  function assert(c,m){ if(!c){ throw new Error('[TEST FAIL] '+m); } }
  function selfTest(s){
    try{
      assert(typeof SlotEngine==='function','SlotEngine defined');
      assert(!!s.canvas&&!!s.ctx,'canvas initialized');
      assert(s.reels.length===CONFIG.reelCount,'reel count ok');
      s._draw();
    }catch(e){ window.__showBanner && window.__showBanner(e.message||e); }
  }

  // -----------------------------------------------------
  // Boot with Splash
  // -----------------------------------------------------
  window.addEventListener('DOMContentLoaded', function(){
    var fb=document.getElementById('fallback'); if(fb) fb.style.display='none';
    var sh=document.getElementById('soundHint'); if(sh) sh.style.display='block';

    window.barFill = document.getElementById('barFill');
window.barText = document.getElementById('barText');
window.splashHint = document.getElementById('splashHint');
var barFill = window.barFill;
var barText = window.barText;
var splash = document.getElementById('splash');
var hint = window.splashHint;

    function setProgress(pct, msg){
  if (!window.barFill || !window.barText || !window.splashHint){
    window.barFill = document.getElementById('barFill') || window.barFill;
    window.barText = document.getElementById('barText') || window.barText;
    window.splashHint = document.getElementById('splashHint') || window.splashHint;
  }
  var bf=window.barFill, bt=window.barText, hintEl=window.splashHint;
  var clamped = Math.max(0, Math.min(100, pct||0));
  if(bf) bf.style.width = clamped + '%';
  if(bt) bt.textContent = clamped.toFixed(0) + '%';
  if(hintEl && msg) hintEl.textContent = msg;
  try{ syncSplashToCanvas(); }catch(_){}
}
// milestones: 12 icons + 1 fonts = 13
    var TOTAL=15; // +1 for Background animation
    var milestones=0;
    function bump(msg){
      milestones++;
      var pct = Math.round((milestones / TOTAL) * 100);
      setProgress(pct, msg);
      return pct;
    }

    
    // Preload Background animation and count it toward milestones
    (function(){
      try {
        var video = document.createElement('video');
        video.src = './backgroundstory.mp4';
        video.preload = 'auto';
        video.muted = true;
        video.playsInline = true;
        var done = false;
        function finish(msg){
          if (done) return;
          done = true;
          bump(msg || 'Background animation ready');
        }
        video.oncanplaythrough = function(){ __videoReady=true; maybeComplete('Background animation ready'); };
        video.onerror = function(){ __videoReady=true; maybeComplete('Background animation error'); };
        // Hint: kick off loading in some browsers
        video.load && video.load();
      setTimeout(function(){ if(!__videoReady){ __videoReady=true; maybeComplete('Video timeout'); } }, 3000);
        } catch(e){ /* no-op */ }
    })();
    var __iconsReady=false, __videoReady=false, __finalized=false;
function maybeComplete(reason){
  if(__finalized) return;
  if(__iconsReady && (__videoReady || !document.getElementById('bgVideo'))){
    __finalized = true;
    try{ finish(reason||'Ready'); }catch(e){}
  }
}
// Start preloading icons
    preloadIconsWithProgress(ICON_URLS, function(pct, msg){
      // map icon-only progress into global total (~0..92%)
      var mapped = Math.min(92, Math.floor((pct/100) * (12/TOTAL) * 100));
      setProgress(mapped, msg||'Loading icons');
    }, function(){ __iconsReady=true; maybeComplete('Icons ready'); 
      milestones = 12;
      setProgress(Math.floor((milestones/TOTAL)*100), 'Icons ready');

      (document.fonts && document.fonts.ready ? document.fonts.ready : Promise.resolve()).then(function(){
        var p = bump('Fonts ready');
        // create engine after short delay, hide splash after canvas has styled size
        setTimeout(function(){
          try{
            var root=document.getElementById('game');
            window.$slot=new SlotEngine(root);
            // ensure splash matches the now-mounted canvas
            setTimeout(syncSplashToCanvas, 0);
            selfTest(window.$slot);
          }catch(e){
            var el=document.getElementById('errorBanner'); el.textContent='Bootstrap failed: '+(e.message||e); el.style.display='block';
          }
          // fade out splash after sizes are synced
          setTimeout(function(){ if(splash){ splash.classList.add('hide'); } }, 180);
        }, 200);
      });
    });
  });
})();
</script>
<script>
(function(){
  var rafId = 0;
  function isHidden(el){
    if(!el) return true;
    var cs = getComputedStyle(el);
    return cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0' || el.offsetParent === null;
  }
  function sync(){
    var v = document.getElementById('bgImage');
    var game = document.getElementById('game');
    var splash = document.getElementById('splash');
    var cvs = game ? game.querySelector('canvas') : null;
    if(!v || !cvs){
      rafId = requestAnimationFrame(sync);
      return;
    }
    var r = cvs.getBoundingClientRect();
    v.style.left = r.left + 'px';
    v.style.top = r.top + 'px';
    v.style.width = r.width + 'px';
    v.style.height = r.height + 'px';
    var shouldShow = isHidden(splash);
    v.style.opacity = shouldShow ? '1' : '0';
    rafId = requestAnimationFrame(sync);
  }
  window.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
    window.visualViewport.addEventListener('scroll', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  }
  sync();
})();
</script>
<script>
// SAFE OVERRIDE: keep engine intact; just neutralize the lava frame draw call.
try { window.drawLavaFrame = function(ctx,x,y,w,h,r,t){}; } catch(e) {}
</script>
<script>
(function(){
  var rafId = 0;
  function isHidden(el){
    if(!el) return true;
    var cs = getComputedStyle(el);
    return cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0' || el.offsetParent === null;
  }
  function sync(){
    var img = document.getElementById('bgImage');
    var game = document.getElementById('game');
    var splash = document.getElementById('splash');
    var cvs = game ? game.querySelector('canvas') : null;
    if(!img || !cvs){
      rafId = requestAnimationFrame(sync);
      return;
    }
    var r = cvs.getBoundingClientRect();
    // CONFIG pulled from engine defaults
    var W = 720, H = 1280;
    var rows = 4, reelsN = 3, cell = 180, reelSpacing = 16;
    var FRAME_GAP_FRAC = 0.12;
    var mcx = W/2, mcy = H*0.43;
    var totalW = reelsN*cell + (reelsN-1)*reelSpacing;
    var startX = mcx - totalW/2 + cell/2;
    var topY = mcy - rows*cell/2;
    var gapPx = Math.max(1, Math.round(cell * FRAME_GAP_FRAC));
    var fx = startX - cell/2 - gapPx;
    var fy = topY - gapPx;
    var fw = totalW + gapPx*2;
    var fh = rows*cell + gapPx*2;
    var scaleX = r.width / W, scaleY = r.height / H;
    img.style.left = (r.left + fx * scaleX) + 'px';
    img.style.top  = (r.top  + fy * scaleY) + 'px';
    img.style.width  = (fw * scaleX) + 'px';
    img.style.height = (fh * scaleY) + 'px';
    img.style.objectFit = 'cover';
    img.style.opacity = isHidden(splash) ? '1' : '0';
    rafId = requestAnimationFrame(sync);
  }
  window.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
    window.visualViewport.addEventListener('scroll', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  }
  sync();
})();
</script>
<script>
(function(){
  function align(){
    var img = document.getElementById('bgImageLocal');
    var game = document.getElementById('game');
    var cvs = game ? game.querySelector('canvas') : null;
    if(!img || !cvs){
      requestAnimationFrame(align);
      return;
    }
    var r = cvs.getBoundingClientRect();
    img.style.left   = r.left + 'px';
    img.style.top    = r.top + 'px';
    img.style.width  = r.width + 'px';
    img.style.height = r.height + 'px';
    requestAnimationFrame(align);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', align);
  } else {
    align();
  }
})();
</script>
<script>
(function(){
  // === Manual adjustment knobs ===
  // Change these four values to reposition/resize the background image.
  // Positive OFFSET_X moves right; negative moves left.
  // Positive OFFSET_Y moves down; negative moves up.
  // SCALE_X/SCALE_Y scale the image relative to the game canvas size.
  window.BG_ALIGN = {
    OFFSET_X: 0,
    OFFSET_Y: -50,
    SCALE_X: 1.0,
    SCALE_Y: 1.0
  };

  function align(){
    var img = document.getElementById('bgImageLocal');
    var root = document.getElementById('game');
    var cvs  = root ? root.querySelector('canvas') : null;
    if(!img || !cvs){
      requestAnimationFrame(align);
      return;
    }
    var r = cvs.getBoundingClientRect();
    var sx = window.BG_ALIGN.SCALE_X || 1;
    var sy = window.BG_ALIGN.SCALE_Y || 1;
    var ox = window.BG_ALIGN.OFFSET_X || 0;
    var oy = window.BG_ALIGN.OFFSET_Y || -50;

    var w = r.width  * sx;
    var h = r.height * sy;
    var l = r.left + (r.width  - w)/2 + ox;
    var t = r.top  + (r.height - h)/2 + oy;

    img.style.left   = l + 'px';
    img.style.top    = t + 'px';
    img.style.width  = w + 'px';
    img.style.height = h + 'px';

    requestAnimationFrame(align);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', align);
  } else { align(); }
})();
</script>
<!-- UI Overlay Neon Button (manual knobs + feature toggles) -->
<script>
(function(){
  // ====== Manual knobs (edit these to position/scale) ======
  window.SPIN_OVERLAY = Object.assign({
    ENABLED: true,        // set false to disable overlay
    DIAM_FRAC: 0.20,      // base diameter as % of canvas width
    SCALE: 1.32,          // fine-tune size
    BOTTOM_FRAC: 0.1,    // distance from bottom as % of canvas height
    OFFSET_X: 0,          // px shift right(+)/left(-)
    OFFSET_Y: -50,          // px shift down(+)/up(-)
    SHOW_FLARE: false,    // thin orange line accent (false hides it)
    SHOW_HIGHLIGHT: true, // glossy arc
    SHOW_PULSE: true,      // outer breathing glow
	SHOW_INNER: false

  }, (window.SPIN_OVERLAY||{}));

  // ====== Overlay canvas setup ======
  function ensureUICanvas(){
    var ui = document.getElementById('uiCanvas');
    if (ui) return ui;
    ui = document.createElement('canvas');
    ui.id = 'uiCanvas';
    ui.style.position = 'fixed';
    ui.style.left = '0';
    ui.style.top  = '0';
    ui.style.zIndex = '3';            // above game canvas
    ui.style.pointerEvents = 'none';  // clicks pass through
    document.body.appendChild(ui);
    return ui;
  }

  function syncUICanvasToGame(ui){
    var root = document.getElementById('game');
    var cvs  = root ? root.querySelector('canvas') : null;
    if (!cvs) return null;
    var r = cvs.getBoundingClientRect();
    ui.style.left   = r.left + 'px';
    ui.style.top    = r.top  + 'px';
    ui.style.width  = Math.round(r.width)  + 'px';
    ui.style.height = Math.round(r.height) + 'px';
    var dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    var w = Math.max(2, Math.round(r.width  * dpr));
    var h = Math.max(2, Math.round(r.height * dpr));
    if (ui.width !== w || ui.height !== h) { ui.width = w; ui.height = h; }
    return { rect: r, dpr: dpr };
  }

  // ====== Neon renderer ======
  function drawNeonSpinButton(ctx, cx, cy, R, t, pressed, knobs){
    var k = pressed ? 0.94 : 1.00;
    var R0 = R * k;
    ctx.save();

    // Core
    var gCore = ctx.createRadialGradient(cx, cy, R0*0.12, cx, cy, R0);
    gCore.addColorStop(0.00, '#3f33ff');
    gCore.addColorStop(0.40, '#2b1e8a');
    gCore.addColorStop(1.00, '#0b0a26');
    ctx.beginPath(); ctx.arc(cx, cy, R0*0.94, 0, Math.PI*2);
    ctx.fillStyle = gCore; ctx.fill();

    // Outer neon ring
    var gRing = ctx.createLinearGradient(cx - R0, cy - R0, cx + R0, cy + R0);
    gRing.addColorStop(0.00, '#ff4fd8');
    gRing.addColorStop(0.50, '#7a3bff');
    gRing.addColorStop(1.00, '#35b6ff');
    ctx.lineWidth   = Math.max(6, R0 * 0.11);
    ctx.strokeStyle = gRing;
    ctx.shadowBlur  = 28;
    ctx.shadowColor = 'rgba(120, 80, 255, 0.85)';
    ctx.beginPath(); ctx.arc(cx, cy, R0*0.88, 0, Math.PI*2); ctx.stroke();

    // Inner thin rim
    //var gInner = ctx.createLinearGradient(cx - R0, cy, cx + R0, cy);
    //gInner.addColorStop(0.00, '#ffd4ff');
    //gInner.addColorStop(1.00, '#9fd8ff');
    //ctx.lineWidth   = Math.max(2, R0 * 0.035);
    //ctx.strokeStyle = gInner;
   // ctx.shadowBlur  = 8;
    //ctx.shadowColor = 'rgba(255, 200, 255, 0.65)';
    //ctx.beginPath(); ctx.arc(cx, cy, R0*0.70, 0, Math.PI*2); ctx.stroke();

    // Glossy highlight arc (toggle)
    if (knobs.SHOW_HIGHLIGHT !== true){
      ctx.save();
      ctx.lineCap = 'round'; ctx.shadowBlur = 0;
      ctx.lineWidth = Math.max(4, R0 * 0.05);
      ctx.strokeStyle = 'rgba(255, 240, 255, 0.45)';
      ctx.beginPath();
      ctx.arc(cx, cy, R0*0.78, -Math.PI*0.18, Math.PI*0.34);
      ctx.stroke();
      ctx.restore();
    }

    // Subtle orange horizontal flare (toggle)
    if (knobs.SHOW_FLARE){
      var flareY = cy + R0 * 0.62;
      var gFlare = ctx.createLinearGradient(cx - R0, flareY, cx + R0, flareY);
      gFlare.addColorStop(0.00, 'rgba(255,120,30,0)');
      gFlare.addColorStop(0.50, 'rgba(255,120,30,0.85)');
      gFlare.addColorStop(1.00, 'rgba(255,120,30,0)');
      ctx.strokeStyle = gFlare;
      ctx.lineWidth   = Math.max(3, R0 * 0.035);
      ctx.shadowBlur  = 18;
      ctx.shadowColor = 'rgba(255,120,30,0.55)';
      ctx.beginPath(); ctx.moveTo(cx - R0*0.88, flareY); ctx.lineTo(cx + R0*0.88, flareY); ctx.stroke();
    }

    // "SPIN" label
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    var fontPx = Math.max(26, Math.round(R0 * 0.52));
    ctx.font = '900 ' + fontPx + 'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    var gTxt = ctx.createLinearGradient(cx - R0*0.4, cy - R0*0.4, cx + R0*0.4, cy + R0*0.4);
    gTxt.addColorStop(0.00, '#ffd6ff'); gTxt.addColorStop(1.00, '#ff7ae6');
    ctx.fillStyle  = gTxt;
    ctx.shadowBlur = 14;
    ctx.shadowColor = 'rgba(255,120,220,0.80)';
    ctx.fillText('SPIN', cx, cy);

    // Outer pulse (toggle)
    if (knobs.SHOW_PULSE !== false){
      var pulse = (Math.sin(t * 2.0) * 0.5 + 0.5) * 0.35;
      ctx.globalCompositeOperation = 'lighter';
      ctx.beginPath(); ctx.arc(cx, cy, R0*0.90, 0, Math.PI*2);
      ctx.lineWidth = Math.max(2, R0 * 0.04);
      ctx.strokeStyle = 'rgba(128, 96, 255,' + (0.25 + pulse*0.25).toFixed(3) + ')';
      ctx.stroke();
    }

    ctx.restore();
  }

  // ====== Render loop using manual geometry ======
  function loop(){
    var knobs = window.SPIN_OVERLAY || {};
    if (!knobs.ENABLED) { requestAnimationFrame(loop); return; }

    var ui = ensureUICanvas();
    var sync = syncUICanvasToGame(ui);
    if (!sync) { requestAnimationFrame(loop); return; }

    var rect = sync.rect, dpr = sync.dpr;
    var ctx = ui.getContext('2d');
    ctx.clearRect(0,0,ui.width,ui.height);

    // Geometry from knobs
    var diamCSS = rect.width * (knobs.DIAM_FRAC || 0.26) * (knobs.SCALE || 1);
    var R = (diamCSS/2) * dpr;
    var cx = (rect.width/2 + (knobs.OFFSET_X||0)) * dpr;
    var bottomMarginCSS = rect.height * (knobs.BOTTOM_FRAC || 0.06);
    var cy = (rect.height - bottomMarginCSS - diamCSS/2 + (knobs.OFFSET_Y||0)) * dpr;
    // Draw panel behind the existing SPIN button (correct context: ctx)
    (function(){
      if (typeof drawSpinPanel === "function") {
        var betValue = (window.$slot && typeof window.$slot.getBet==='function') ? window.$slot.getBet()
                      : (window.$slot && typeof window.$slot.bet==='number') ? window.$slot.bet
                      : (CONFIG && typeof CONFIG.bet==='number') ? CONFIG.bet : 20;
        (function(){
  var __rects = drawSpinPanel(ctx, cx, cy, R, betValue);
  if (window.$slot) {
    window.$slot.betMinusRect = __rects.minus;
    window.$slot.betPlusRect  = __rects.plus;
    window.$slot.betRect      = __rects.capsule;
    window.$slot.spinRect     = __rects.spin;
  }
})();
      }
      // Debug center dot
      ctx.fillStyle = "rgba(255,0,200,0.9)";
      ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();
    })();


    var pressed = false;
    try { if (window.$slot && typeof window.$slot.buttonPressed !== 'undefined') pressed = !!window.$slot.buttonPressed; } catch(e){}
    var t = (performance.now() || 0)/1000;

    drawNeonSpinButton(ctx, cx, cy, R, t, pressed, knobs);
    requestAnimationFrame(loop);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loop);
  else loop();
})();
</script>
<script>
(function(){
  var rafId = 0;
  function isHidden(el){
    if(!el) return true;
    var cs = getComputedStyle(el);
    return cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0' || el.offsetParent === null;
  }
  function sync(){
    var img = document.getElementById('balanceBg');
    var game = document.getElementById('game');
    var splash = document.getElementById('splash');
    var cvs = game ? game.querySelector('canvas') : null;
    if(!img || !cvs){
      rafId = requestAnimationFrame(sync);
      return;
    }
    var r = cvs.getBoundingClientRect();
    var W = 720, H = 1280; // base config
    var scaleX = r.width / W, scaleY = r.height / H;

    var TOP = 0;        // game units from top
    var RIGHT = -10;      // game units from right edge
    var WIDTH = 200;    // width in game units

    var left = r.left + (W - RIGHT - WIDTH) * scaleX;
    var top  = r.top  + TOP * scaleY;

    img.style.left   = left + 'px';
    img.style.top    = top  + 'px';
    img.style.width  = (WIDTH * scaleX) + 'px';
    img.style.height = 'auto';
    img.style.opacity = isHidden(splash) ? '1' : '0';

    rafId = requestAnimationFrame(sync);
  }
  window.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
    window.visualViewport.addEventListener('scroll', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  }
  sync();
})();
</script><script>
(function(){
  var rafId = 0;
  function sync(){
    var img = document.getElementById('balanceBg');
    var game = document.getElementById('game');
    if(!img || !game){ rafId = requestAnimationFrame(sync); return; }
    var cvs = game.querySelector('canvas');
    if(!cvs){ rafId = requestAnimationFrame(sync); return; }
    var r = cvs.getBoundingClientRect();
    var W = 720, H = 1280;
    var scaleX = r.width / W, scaleY = r.height / H;
    var TOP = -10, RIGHT = -10, WIDTH = 250;
    var left = r.left + (W - RIGHT - WIDTH) * scaleX;
    var top  = r.top  + TOP * scaleY;
    img.style.left = left + 'px';
    img.style.top  = top  + 'px';
    img.style.width = (WIDTH * scaleX) + 'px';
    img.style.opacity = '1'; // always ready; no tie to splash
    rafId = requestAnimationFrame(sync);
  }
  window.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
    window.visualViewport.addEventListener('scroll', function(){ cancelAnimationFrame(rafId); sync(); }, {passive:true});
  }
  sync();
})();
</script>
<script>
(function(){
  var v = document.getElementById('bgVideo');
  if(!v) return;

  function ensureAutoplay(){
    try { v.muted = true; v.setAttribute('muted',''); } catch(e){}
    try { v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); } catch(e){}
    try { if (v.readyState < 2) v.load(); } catch(e){}
    var attempt = function(){
      try {
        var p = v.play();
        if (p && typeof p.then === 'function') {
          p.catch(function(){
            var kick = function(){
              document.removeEventListener('pointerdown', kick);
              document.removeEventListener('keydown', kick);
              try { v.play(); } catch(_){}
            };
            document.addEventListener('pointerdown', kick, {once:true});
            document.addEventListener('keydown', kick, {once:true});
          });
        }
      } catch(e){}
    };
    attempt();
    v.addEventListener('loadeddata', attempt, {once:true});
    v.addEventListener('canplay', attempt, {once:true});
  }

  // reveal when splash hides
  function reveal(){ document.body.classList.add('splash-hidden'); v.classList.remove('hiddenUntilReady'); }
  var splash = document.getElementById('splash') || document.querySelector('.splash');
  if (splash) {
    var obs = new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        if (muts[i].type === 'attributes' && splash.classList.contains('hide')) { reveal(); obs.disconnect(); break; }
      }
    });
    obs.observe(splash, { attributes:true });
  } else {
    setTimeout(reveal, 800);
  }

  if (v.readyState >= 1) ensureAutoplay();
  v.addEventListener('loadedmetadata', ensureAutoplay, {once:true});
})();
</script>


<audio id="sfxWhoosh" preload="auto"><source src="./sfx/whoosh.mp3" type="audio/mpeg"/></audio>

<script>
(function(){
  var started=false;
  function tryStart(){
    if(started) return;
    if(window.$slot && typeof window.$slot.startIntro==='function'){ started=true; window.$slot.startIntro(); }
  }
  document.addEventListener('DOMContentLoaded', function(){
    var splash=document.getElementById('splash');
    if(!splash){ setTimeout(tryStart, 400); return; }
    var obs=new MutationObserver(function(m){ if(splash.classList.contains('hide')){ tryStart(); obs.disconnect(); } });
    obs.observe(splash, {attributes:true, attributeFilter:['class']});
    setTimeout(tryStart, 2000);
  });
})();
</script>


<script>
(function(){
  if(!window.$slot){
    var tries=0, id=setInterval(function(){
      tries++;
      if(window.$slot || tries>50){ clearInterval(id); return; }
      if(window.__lastSlotInstance){ window.$slot=window.__lastSlotInstance; clearInterval(id); }
    }, 100);
  }
})();
</script>


<script id="spin-panel-pop">
(function(){
  function rr(ctx, x, y, w, h, r){
    const k = Math.min(r, Math.min(w, h)/2);
    ctx.beginPath();
    ctx.moveTo(x+k, y);
    ctx.arcTo(x+w, y,   x+w, y+h, k);
    ctx.arcTo(x+w, y+h, x,   y+h, k);
    ctx.arcTo(x,   y+h, x,   y,   k);
    ctx.arcTo(x,   y,   x+w, y,   k);
    ctx.closePath();
  }
  function neonText(ctx, txt, x, y, font, fill, glow, blur){
    ctx.save();
    ctx.font = font; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillStyle = fill; ctx.shadowColor = glow; ctx.shadowBlur = blur;
    ctx.fillText(txt, x, y);
    ctx.restore();
  }
  window.drawSpinPanel = function(ctx, cx, cy, R, betValue){
    const POP_ELEV_BTN   = Math.max(6, R*0.16);
    const POP_ELEV_CAP   = Math.max(4, R*0.12);
    const SHADOW_OPACITY = 0.38;

    const plateW = R * 5;
    const plateH = R * 2.2;
    const plateX = cx - plateW/2;
    const plateY = cy - R*-0.2;
    const plateR = R * 0.28;

    ctx.save();
    rr(ctx, plateX, plateY, plateW, plateH, plateR);
    ctx.save(); ctx.clip();
    let gBody = ctx.createLinearGradient(plateX, plateY, plateX, plateY+plateH);
    gBody.addColorStop(0.00, "#2a1563");
    gBody.addColorStop(0.55, "#201049");
    gBody.addColorStop(1.00, "#180a3a");
    ctx.fillStyle = gBody; ctx.fill();
    let specH = Math.max(22, R*0.26);
    let gSpec = ctx.createLinearGradient(plateX, plateY, plateX, plateY+specH);
    gSpec.addColorStop(0, "rgba(160,130,255,0.40)");
    gSpec.addColorStop(1, "rgba(160,130,255,0.00)");
    ctx.fillStyle = gSpec; ctx.fillRect(plateX, plateY, plateW, specH);
    let vignH = Math.max(30, R*0.36);
    let gVig = ctx.createLinearGradient(plateX, plateY+plateH-vignH, plateX, plateY+plateH);
    gVig.addColorStop(0, "rgba(0,0,0,0.00)");
    gVig.addColorStop(1, "rgba(0,0,0,0.40)");
    ctx.fillStyle = gVig; ctx.fillRect(plateX, plateY+plateH-vignH, plateW, vignH);
    let inset = Math.max(6, R*0.08);
    rr(ctx, plateX+inset, plateY+inset, plateW-2*inset, plateH-2*inset, plateR*0.75);
    ctx.strokeStyle = "rgba(0,0,0,0.5)";
    ctx.lineWidth = Math.max(2, R*0.05);
    ctx.shadowBlur = Math.max(10, R*0.2);
    ctx.shadowColor = "rgba(0,0,0,0.65)";
    ctx.stroke();
    ctx.restore();
    ctx.strokeStyle = "#5c36e1";
    ctx.lineWidth = Math.max(3, R*0.05);
    ctx.shadowBlur = Math.max(12, R*0.18);
    ctx.shadowColor = "#5c36e1";
    ctx.stroke();
    rr(ctx, plateX+2, plateY+2, plateW-4, plateH-4, plateR*0.92);
    ctx.strokeStyle = "rgba(110,80,255,0.38)";
    ctx.lineWidth = 2; ctx.shadowBlur = 0; ctx.stroke();
    ctx.restore();

    const capW = R * 1.92;
    const capH = R * 0.96;
    const capX = cx - capW/2;
    const capY = cy + R*0.98;
    const capR = capH/2;

    ctx.save();
    ctx.globalAlpha = SHADOW_OPACITY;
    ctx.fillStyle = "#000";
    ctx.translate(capX + capW/2, capY + capH + POP_ELEV_CAP*0.55);
    ctx.scale(1.25, 0.35);
    ctx.beginPath(); ctx.arc(0, 0, capW*0.46, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    ctx.save();
    rr(ctx, capX, capY - POP_ELEV_CAP, capW, capH, capR);
    let gCap = ctx.createLinearGradient(capX, capY-POP_ELEV_CAP, capX, capY-POP_ELEV_CAP+capH);
    gCap.addColorStop(0, "#311a70");
    gCap.addColorStop(1, "#1b0d45");
    ctx.fillStyle = gCap;
    ctx.shadowColor = "#5c36e1";
    ctx.shadowBlur  = Math.max(14, R*0.2);
    ctx.shadowOffsetY = Math.max(2, R*0.06);
    ctx.fill();
    ctx.strokeStyle = "#6c4bff";
    ctx.lineWidth = 3; ctx.shadowBlur = 12; ctx.shadowColor="#6c4bff"; ctx.stroke();

    const pad = Math.max(7, R*0.11);
    rr(ctx, capX+pad, (capY-POP_ELEV_CAP)+pad, capW-2*pad, capH-2*pad, (capH-2*pad)/2);
    let gInner = ctx.createLinearGradient(capX, capY-POP_ELEV_CAP, capX, capY-POP_ELEV_CAP+capH);
    gInner.addColorStop(0, "#23114f");
    gInner.addColorStop(0.55, "#1d0e46");
    gInner.addColorStop(1, "#190b3c");
    ctx.fillStyle = gInner;
    ctx.shadowBlur = Math.max(10, R*0.16);
    ctx.shadowColor = "rgba(40,200,255,0.3)";
    ctx.fill();
    rr(ctx, capX+pad+2, (capY-POP_ELEV_CAP)+pad+2, capW-2*(pad+2), capH-2*(pad+2), (capH-2*(pad+2))/2);
    ctx.strokeStyle = "rgba(100,210,255,0.28)";
    ctx.lineWidth = 2; ctx.shadowBlur = 0; ctx.stroke();
    ctx.restore();

    neonText(ctx, String(betValue), cx, (capY - POP_ELEV_CAP) + capH/2,
      `800 ${Math.round(R*0.66)}px Inter, system-ui, sans-serif`,
      "#c6f6ff", "#3dd9ff", Math.max(12, R*0.18)
    );

    const sq   = capH * 0.84;
    const gap  = R * 0.12;
    const btnY = (capY - POP_ELEV_CAP) + (capH - sq)/2;
    const btnR = sq*0.22;
    const minusX = capX - gap - sq;
    const plusX  = capX + capW + gap;

    function drawRaisedButton(x, y, glyph, down){
      var elev = down ? POP_ELEV_BTN*0.18 : POP_ELEV_BTN;
ctx.save();
      ctx.globalAlpha = SHADOW_OPACITY;
      ctx.fillStyle = "#000";
      ctx.translate(x + sq/2, y + sq + elev*0.55);
      ctx.scale(1.05, 0.36);
      ctx.beginPath(); ctx.arc(0, 0, sq*0.58, 0, Math.PI*2); ctx.fill();
      ctx.restore();

      ctx.save();
      rr(ctx, x, y - elev, sq, sq, btnR);
      let gB = ctx.createLinearGradient(x, y-elev, x, y-elev+sq);
      gB.addColorStop(0, "#341a74");
      gB.addColorStop(1, "#1c0e46");
      ctx.fillStyle = gB;
      ctx.shadowColor = "rgba(0,0,0,0.45)";
      ctx.shadowBlur  = Math.max(10, R*0.16);
      ctx.shadowOffsetY = Math.max(2, R*0.06);
      ctx.fill();

      ctx.strokeStyle = "#39d7ff";
      ctx.lineWidth = 3; ctx.shadowBlur = 12; ctx.shadowColor = "#39d7ff"; ctx.stroke();

      rr(ctx, x+3, y - elev + 3, sq-6, sq-6, (sq-6)*0.22);
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 2; ctx.shadowBlur = 0; ctx.stroke();

      rr(ctx, x+4, y - elev + 4, sq-8, sq-8, (sq-8)*0.22);
      ctx.strokeStyle = "rgba(0,0,0,0.22)";
      ctx.lineWidth = 2; ctx.stroke();

      neonText(ctx, glyph, x + sq/2, y - elev + sq/2,
        `900 ${Math.round(sq*0.66)}px Inter, system-ui, sans-serif`,
        "#e0fbff", "#39d7ff", Math.max(10, R*0.14)
      );
      ctx.restore();
    }
    drawRaisedButton(minusX, btnY, "â€“", (window.$slot && window.$slot.minusPressed));
    drawRaisedButton(plusX, btnY, "+", (window.$slot && window.$slot.plusPressed));

    const betY = plateY + plateH - R*0.30;
    ctx.save();
    ctx.shadowBlur = Math.max(4, R*0.08);
    ctx.shadowColor = "rgba(0,0,0,0.6)";
    ctx.fillStyle = "rgba(40,45,95,0.9)";
    ctx.font = `800 ${Math.round(R*0.42)}px Inter, system-ui, sans-serif`;
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText("BET", cx, betY+1.5);
    ctx.shadowBlur = 0;
    ctx.strokeStyle = "rgba(140,150,220,0.18)";
    ctx.lineWidth = 2; ctx.strokeText("BET", cx, betY+1.5);
    ctx.restore();

    return {
      minus:   {x: minusX, y: btnY-POP_ELEV_BTN, w: sq, h: sq},
      plus:    {x: plusX,  y: btnY-POP_ELEV_BTN, w: sq, h: sq},
      capsule: {x: capX,   y: capY-POP_ELEV_CAP, w: capW, h: capH},
      spin:    {x: cx-R,   y: cy-R, w: 2*R, h: 2*R}
    };
  };
})();
</script>


<script>
/* BG-SYNC: device-proof video cover */
(function(){
  const GAME_W = 720, GAME_H = 1280;
  const FOCAL_Y = -0.06; // bias crop slightly upward; tweak as needed

  
  function syncBackground() {
    const video = document.getElementById('bgVideo');
    const game  = document.getElementById('game');
    if (!video || !game) return;

    const canvas = game.querySelector('canvas');
    if (!canvas) return;

    const cr = canvas.getBoundingClientRect();
    const cw = cr.width, ch = cr.height;

    // Canvas center in viewport coords
    const cx = cr.left + cw/2;
    const cy = cr.top  + ch/2;

    // Fit the video to COVER the canvas' logical aspect
    const GAME_W = 720, GAME_H = 1280;
    const scale = Math.max(cw / GAME_W, ch / GAME_H);
    const targetW = GAME_W * scale;
    const targetH = GAME_H * scale;

    // Focal bias: -0.06 lifts the content slightly
    const FOCAL_Y = -0.06;
    const focalShiftY = FOCAL_Y * (targetH - ch);

    // Place so that video center == canvas center
    const left = cx - targetW/2;
    const top  = cy - targetH/2 + focalShiftY;

    // Apply
    video.style.width  = targetW + 'px';
    video.style.height = targetH + 'px';
    video.style.left   = left + 'px';
    video.style.top = (top - 0.1095 * targetH) + 'px';

    // Layering
    video.style.zIndex = '0';
    if (canvas.style.position !== 'relative') canvas.style.position = 'relative';
    canvas.style.zIndex = '1';
  }


  const ro = new ResizeObserver(syncBackground);
  window.addEventListener('resize', syncBackground, {passive:true});
  window.visualViewport && window.visualViewport.addEventListener('resize', syncBackground, {passive:true});
  window.addEventListener('orientationchange', syncBackground, {passive:true});
  window.addEventListener('load', syncBackground);
  document.addEventListener('DOMContentLoaded', syncBackground);

  // Observe the canvas once available
  (function waitCanvas(){
    const game = document.getElementById('game');
    const canvas = game && game.querySelector('canvas');
    if (canvas) { try { ro.observe(canvas); } catch(e){} syncBackground(); }
    else { requestAnimationFrame(waitCanvas); }
  })();
})();
</script>
<script>document.body.classList.add('loaded');</script>

<script>
// Ensure splash is a direct child of body to prevent fixed-position issues
(function () {
  var s = document.getElementById('splash');
  if (s && s.parentNode !== document.body) {
    document.body.prepend(s);
  }
})();

// Override syncSplashToCanvas to enforce full-screen splash
function syncSplashToCanvas() {
  var splash = document.getElementById('splash');
  if (!splash) return;
  splash.style.position = 'fixed';
  splash.style.left = '0';
  splash.style.top = '0';
  splash.style.right = '0';
  splash.style.bottom = '0';
  splash.style.width = '100vw';
  splash.style.height = '100vh';
  splash.style.transform = 'none';
  splash.style.zIndex = '99999';
  if (typeof fitSplashContent === 'function') fitSplashContent();
}
</script>

<script id="sideButtonsAutoAnchor">
(function(){
  function el(id){ return document.getElementById(id); }

  var game, canvas, leftBtn, rightBtn;

  

function place(){
  if(!game || !canvas || !leftBtn || !rightBtn) return;
  var g = game.getBoundingClientRect();
  var r = canvas.getBoundingClientRect();
  if(!r.width || !r.height) return;

  // Measure the rendered sizes of the icon <img> elements (fallback to 60px)
  function imgSize(btn, fallback){
    var img = btn && btn.querySelector && btn.querySelector('img');
    if(img){
      var ir = img.getBoundingClientRect();
      return { w: (ir.width||fallback), h:(ir.height||fallback) };
    }
    var br = btn.getBoundingClientRect ? btn.getBoundingClientRect() : {width:0,height:0};
    return { w:(br.width||fallback), h:(br.height||fallback) };
  }
  var lb = imgSize(leftBtn, 60);
  var rb = imgSize(rightBtn, 60);

  // Horizontal gap from canvas edges (reduce to pull closer to edges)
  var gapX = Math.max(4, Math.floor(r.width * 0.01)); // 1% of canvas width

  // Vertical placement as a percentage of canvas height
  var yPct = 0.85; // 0.70 higher, 0.85 lower
  var y = (r.top - g.top) + (r.height * yPct) - (lb.h / 2);

  // Desired X positions relative to #game
  var leftDesired  = (r.left  - g.left) + gapX;
  var rightDesired = (r.right - g.left) - rb.w - gapX;

  // Clamp inside canvas
  var minX = (r.left  - g.left) + 4;
  var maxX = (r.right - g.left) - rb.w - 4;
  var minY = (r.top   - g.top) + 4;
  var maxY = (r.bottom- g.top) - lb.h - 4;

  var leftX  = Math.max(minX, Math.min(leftDesired,  maxX));
  var rightX = Math.max(minX, Math.min(rightDesired, maxX));
  y = Math.max(minY, Math.min(y, maxY));

  // GPU-friendly transform â€” no layout thrash
  leftBtn.style.transform  = 'translate3d(' + leftX.toFixed(2) + 'px,' + y.toFixed(2) + 'px,0)';
  rightBtn.style.transform = 'translate3d(' + rightX.toFixed(2) + 'px,' + y.toFixed(2) + 'px,0)';
}

        

  function init(){
    game = el('game');
    leftBtn = el('historyBtn');
    rightBtn = el('walletBtn');
    canvas = game ? game.querySelector('canvas') : null;
    if(!game || !leftBtn || !rightBtn || !canvas){
      setTimeout(init, 120);
      return;
    }
    place();
    window.addEventListener('resize', place, {passive:true});
    window.addEventListener('orientationchange', place, {passive:true});
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, {once:true});
  else init();
})();
</script>
<script id="overlayPanelsScript">(function(){var e=document.getElementById("overlay"),t=document.getElementById("overlayCard"),n=document.getElementById("overlayTitle"),o=document.getElementById("overlayClose"),a=document.getElementById("overlayBackdrop"),d=document.getElementById("historyContent"),l=document.getElementById("walletContent"),r=document.querySelector("#historyTable tbody"),i=[],c=[];function s(e){var t=e?new Date(e):new Date;return t.toLocaleString()}function y(){if(!r)return;var e="";if(0===c.length)e='<tr><td colspan="4" style="opacity:.8">No bets made yet.</td></tr>';else for(var t=c.length-1;t>=0;t--){var n=c[t];e+="<tr><td>"+(n.time||s())+"</td><td>"+(n.bet||0)+"</td><td>"+(n.win?'<span class=\"hist-badge win\">WIN</span>':'<span class=\"hist-badge loss\">LOSS</span>')+"</td><td>"+(null!=n.payout?n.payout:"-")+"</td></tr>"}r.innerHTML=e}window.HorizonUI=window.HorizonUI||{},window.HorizonUI.addBetHistory=function(e,t,n,o){c.push({bet:e,win:!!t,payout:n,time:o||s()}),document.getElementById("overlay")&&document.getElementById("overlay").classList.contains("open")&&d&&"none"!==d.style.display&&y()};var u=document.getElementById("acctType"),m=document.getElementById("acctName"),v=document.getElementById("bankFields"),h=document.getElementById("bankName"),p=document.getElementById("iban"),f=document.getElementById("withdrawAmount"),g=document.getElementById("currency"),w=document.getElementById("addAccountBtn"),_=document.getElementById("requestWithdrawBtn");function b(){u&&v&&(v.style.display="bank"===u.value?"":"none")}function E(){var e=u?u.value:"bank",t=m&&m.value||"";if(!(t=t.trim()))return void alert("Please enter account name/identifier");var n={type:e,name:t};if("bank"===e){if(n.bank=h&&h.value||"",n.iban=p&&p.value||"",!(n.bank=n.bank.trim())||!(n.iban=n.iban.trim()))return void alert("Please enter bank and account/IBAN")}i.push(n);try{var o={type:"wallet",action:"add_account",data:n};window.__tgSend?window.__tgSend(JSON.stringify(o)):window.TelegramGameProxy&&"function"==typeof window.TelegramGameProxy.receiveEvent&&window.TelegramGameProxy.receiveEvent(JSON.stringify(o))}catch(e){}alert("Account added.")}function L(){var e=parseFloat(f&&f.value||"0");if(!(e>0))return void alert("Enter a valid withdrawal amount");var t={amount:e,currency:g&&g.value||"USD"};try{var n={type:"wallet",action:"request_withdraw",data:t};window.__tgSend?window.__tgSend(JSON.stringify(n)):window.TelegramGameProxy&&"function"==typeof window.TelegramGameProxy.receiveEvent&&window.TelegramGameProxy.receiveEvent(JSON.stringify(n))}catch(e){}alert("Withdrawal request submitted.")}u&&u.addEventListener("change",b),b(),w&&w.addEventListener("click",function(e){e.preventDefault(),E()}),_&&_.addEventListener("click",function(e){e.preventDefault(),L()});function k(o){e&&t&&(n.textContent="wallet"===o?"Wallet":"Betting History",d.style.display="history"===o?"":"none",l.style.display="wallet"===o?"":"none",e.classList.add("open"),e.setAttribute("aria-hidden","false"),x(),"history"===o&&y())}function C(){e&&(e.classList.remove("open"),e.setAttribute("aria-hidden","true"))}o&&o.addEventListener("click",C),a&&a.addEventListener("click",C);function x(){var e=document.getElementById("game");if(!e)return;var n=e.querySelector("canvas");if(!n)return;var o=e.getBoundingClientRect(),a=n.getBoundingClientRect(),d=Math.floor(.8*a.width),l=Math.floor(.6*a.height),r=a.left-o.left+Math.floor((a.width-d)/2),i=a.top-o.top+Math.floor((a.height-l)/2);t.style.left=r+"px",t.style.top=i+"px",t.style.width=d+"px",t.style.height=l+"px"}window.addEventListener("resize",x,{passive:!0}),window.addEventListener("orientationchange",x,{passive:!0});function O(){var e=document.getElementById("historyBtn"),t=document.getElementById("walletBtn");e&&e.addEventListener("click",function(e){k("history")}),t&&t.addEventListener("click",function(e){k("wallet")})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",O,{once:!0}):O(),window.HorizonUI=window.HorizonUI||{},window.HorizonUI.openOverlay=k,window.HorizonUI.closeOverlay=C})();

function initWalletTabs(){
  var tabAdd = document.getElementById('tabAdd');
  var tabWithdraw = document.getElementById('tabWithdraw');
  var addPane = document.getElementById('tabAddPane');
  var withdrawPane = document.getElementById('tabWithdrawPane');

  function activate(which){
    var addActive = (which === 'add');
    if (tabAdd) tabAdd.classList.toggle('active', addActive);
    if (tabWithdraw) tabWithdraw.classList.toggle('active', !addActive);
    if (addPane) addPane.style.display = addActive ? '' : 'none';
    if (withdrawPane) withdrawPane.style.display = addActive ? 'none' : '';
    // store state for future opens
    document.body.dataset.walletTab = which;
  }

  // Clear old listeners by resetting onclick each time
  if (tabAdd) tabAdd.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); activate('add'); };
  if (tabWithdraw) tabWithdraw.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); activate('withdraw'); };

  // Use last chosen tab if available, else default to add
  var last = document.body.dataset.walletTab || 'add';
  activate(last === 'withdraw' ? 'withdraw' : 'add');
}

</script>

<script id="overlayWalletTabHook">
(function(){
  function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true}); else fn(); }
  ready(function(){
    // Hook wallet button to always init tabs
    var wb = document.getElementById('walletBtn');
    if(wb){
      wb.addEventListener('click', function(){
        try{ if(window.initWalletTabs) initWalletTabs(); }catch(e){}
      });
    }
    // Fallback event delegation on wallet container
    var wallet = document.getElementById('walletContent');
    if(wallet && !wallet.__tabsDelegated){
      wallet.addEventListener('click', function(ev){
        var t = ev.target.closest && ev.target.closest('.tab-btn');
        if(!t) return;
        ev.preventDefault();
        if(window.initWalletTabs){
          // re-run to ensure handlers/state exist, then simulate activation
          initWalletTabs();
          if(t.id === 'tabWithdraw'){
            document.body.dataset.walletTab = 'withdraw';
            initWalletTabs();
          } else {
            document.body.dataset.walletTab = 'add';
            initWalletTabs();
          }
        }
      });
      wallet.__tabsDelegated = true;
    }
  });
})();
</script>



<style id="fxCanvasStyles">
  #fxCanvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: block; }
</style>

<script id="fxCanvasOverlay">
(function () {
  // Detect canvas and fit overlay to its *client* box each frame (prevents stretch/drift)
  var CANVAS_SELECTOR = '#game canvas, canvas#gameCanvas, .game canvas, canvas';
  function getGameCanvas(){ return document.querySelector(CANVAS_SELECTOR); }
  function ensureFxCanvas(){
    var cv = getGameCanvas(); if(!cv) return null;
    var parent = cv.parentElement || document.body;
    // parent must clip/anchor
    var ps = getComputedStyle(parent);
    if(ps.position === 'static'){ parent.style.position = 'relative'; }
    if(ps.overflow === 'visible'){ parent.style.overflow = 'hidden'; }
    var fx = document.getElementById('fxCanvas');
    if(!fx){ fx = document.createElement('canvas'); fx.id='fxCanvas'; parent.appendChild(fx); }
    else if(fx.parentElement !== parent){ parent.appendChild(fx); }
    // style to exactly match canvas client rect
    var r = cv.getBoundingClientRect();
    var pr = parent.getBoundingClientRect();
    fx.style.position = 'absolute';
    fx.style.left = (cv.offsetLeft) + 'px';
    fx.style.top  = (cv.offsetTop)  + 'px';
    fx.style.width  = (cv.clientWidth)  + 'px';
    fx.style.height = (cv.clientHeight) + 'px';
    fx.style.pointerEvents = 'none';
    fx.style.zIndex = 9999;
    // backing store matches client size * DPR
    var dpr = Math.max(1, window.devicePixelRatio || 1);
    var w = cv.clientWidth || cv.width || 720;
    var h = cv.clientHeight || cv.height || 1280;
    var needResize = (fx.width !== Math.round(w*dpr) || fx.height !== Math.round(h*dpr));
    if(needResize){
      fx.width = Math.round(w*dpr);
      fx.height= Math.round(h*dpr);
    }
    var ctx = fx.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    return {fx:fx, ctx:ctx, w:w, h:h, dpr:dpr, cv:cv};
  }

  // --- particles ---
  function makeCoins(cx, cy, count){
    var out=[]; for(var i=0;i<count;i++){ var ang=(Math.PI*2)*(i/count)+(Math.random()*0.25);
      var spd=220+Math.random()*180;
      out.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd*0.85,life:0,ttl:0.9+Math.random()*0.6});
    } return out;
  }
  function drawCoins(ctx, coins, dt){
    ctx.save();
    for(var i=coins.length-1;i>=0;i--){
      var c=coins[i]; c.life+=dt; var t=c.life/c.ttl;
      if(t>=1){ coins.splice(i,1); continue; }
      var ease = t<0.2 ? (t/0.2) : (1-(t-0.2)/0.8);
      var x=c.x+c.vx*t, y=c.y+c.vy*t;
      var r=8, alpha=Math.max(0,1-t);
      var g=ctx.createRadialGradient(x-r*0.3,y-r*0.3,0,x,y,r);
      g.addColorStop(0,'rgba(255,255,255,'+alpha.toFixed(3)+')');
      g.addColorStop(0.4,'rgba(255,215,64,'+(0.9*alpha).toFixed(3)+')');
      g.addColorStop(1,'rgba(214,164,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r*(0.6+0.6*ease),0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }
  function drawGlow(ctx, cx, cy, rx, ry, stops, alpha){
  ctx.save();
  // Clip strictly to the visible canvas area in logical coords
  try{
    var a=1,d=1;
    if (ctx.getTransform) { var tr = ctx.getTransform(); a = tr.a||1; d = tr.d||1; }
    var w = (ctx.canvas && ctx.canvas.width ? ctx.canvas.width/a : 720);
    var h = (ctx.canvas && ctx.canvas.height ? ctx.canvas.height/d : 1280);
    ctx.beginPath(); ctx.rect(0,0,w,h); ctx.clip();
  }catch(e){ /* best-effort clip; continue */ }

  var grad = ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(rx,ry));
  for (var i=0;i<stops.length;i++) grad.addColorStop(stops[i][0], stops[i][1]);
  ctx.globalAlpha = alpha;
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

  // image cache
  var imgCache={};
  function getImage(src, cb){
    if(imgCache[src] && imgCache[src].complete) return cb(imgCache[src]);
    var im = new Image();
    im.onload=function(){ imgCache[src]=im; cb(im); };
    im.src=src;
  }

  // Single runner shared by BigWin/Jackpot
  function runFx(kind, imgSrc){
    var env = ensureFxCanvas(); if(!env) return;
    var ctx = env.ctx, W = env.w, H = env.h;
    var cx=W/2, cy=H*0.42;
    getImage(imgSrc, function(img){
      var start=performance.now(), dur=1400;
      var coins=makeCoins(cx,cy,26);
      // image size (fit within current client size)
      var imgW = Math.min(W*0.86, 640); var imgH = imgW * (img.height/img.width);

      function loop(now){
        // Keep fx canvas glued to the real canvas each frame
        env = ensureFxCanvas(); if(!env) return; ctx = env.ctx; W=env.w; H=env.h; cx=W/2; cy=H*0.42;

        var t = Math.min(1, (now-start)/dur);
        ctx.clearRect(0,0,W,H);
        // backdrop
        ctx.save(); ctx.fillStyle='rgba(0,0,0,'+(0.6*t).toFixed(3)+')'; ctx.fillRect(0,0,W,H); ctx.restore();
        // glow
        if(kind==='jackpot'){
          drawGlow(ctx,cx,cy+10,imgW*0.75,imgH*0.75,[[0,'rgba(255,240,160,0.35)'],[0.6,'rgba(255,120,0,0.28)'],[1,'rgba(255,120,0,0)']],0.9*t);
        }else{
          drawGlow(ctx,cx,cy+10,imgW*0.7,imgH*0.7,[[0,'rgba(255,240,160,0.30)'],[0.6,'rgba(255,200,0,0.24)'],[1,'rgba(255,200,0,0)']],0.85*t);
        }
        // pop
        var scale = 0.7 + 0.3*Math.sin(t*Math.PI);
        var w = imgW*(0.9+0.1*scale), h = imgH*(0.9+0.1*scale);
        ctx.save(); ctx.translate(cx-w/2, cy-h/2); ctx.drawImage(img, 0,0, w,h); ctx.restore();
        drawCoins(ctx, coins, 1/60);
        if(t<1) requestAnimationFrame(loop);
        else{
          var fadeStart=performance.now();
          (function fade(now2){
            var ft = Math.min(1,(now2-fadeStart)/300);
            ctx.globalAlpha = 1-ft; ctx.clearRect(0,0,W,H); ctx.globalAlpha=1;
            if(ft<1) requestAnimationFrame(fade); else ctx.clearRect(0,0,W,H);
          })(fadeStart);
        }
      }
      requestAnimationFrame(loop);
    });
  }

  // Disable legacy DOM overlays so we only see the canvas-based one
  (function killLegacy(){
    var ids=['bigwinOverlay','jackpotOverlay'];
    ids.forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
  })();

  // Expose robust globals that the game can call
  window.showBigWinOverlay = function(){ runFx('bigwin', './bigwin.png'); };
  window.showJackpotOverlay = function(){ runFx('jackpot', './jackpot.png'); };
  // Common fallbacks some codebases use:
  window.showBigWin = window.showBigWinOverlay;
  window.showJackpot = window.showJackpotOverlay;
  window.bigWin = window.showBigWinOverlay;
  window.jackpotWin = window.showJackpotOverlay;

  // Hotkeys for testing
  document.addEventListener('keydown', function(e){
    if(e.shiftKey && (e.key==='B'||e.key==='b')) window.showBigWinOverlay();
    if(e.shiftKey && (e.key==='J'||e.key==='j')) window.showJackpotOverlay();
  });
})();
</script>


</body>
</html>

<script id="sideButtonsScript">
(function(){
  function send(evt){
    try{
      if (window.__tgSend){ window.__tgSend(JSON.stringify(evt)); }
      else if (window.TelegramGameProxy && typeof window.TelegramGameProxy.receiveEvent === 'function'){
        window.TelegramGameProxy.receiveEvent(JSON.stringify(evt));
      }
    }catch(e){}
  }
  function ready(){
    var w = document.getElementById('walletBtn');
    var h = document.getElementById('historyBtn');
    if(w){ w.addEventListener('click', function(e){ e.preventDefault(); send({type:'ui', action:'open_wallet'}); }); }
    if(h){ h.addEventListener('click', function(e){ e.preventDefault(); send({type:'ui', action:'open_history'}); }); }
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ready);
  else ready();
})();
</script>
