<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Telegram Slot Machine â€“ Zodiac</title>
  <style>
    html, body { height: 100%; margin: 0; background: #020616; overflow: hidden; }
    #game { position: fixed; inset: 0; display: grid; place-items: center; }
    canvas { display: block; width: 100%; height: 100%; background: #000; }
    .error-banner { position: fixed; top: 0; left: 0; right: 0; background: #3a0d10; color: #ffd2d2; padding: 10px 14px; font-weight: 700; display: none; z-index: 20; white-space: pre-wrap; }
    body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    audio { display: none !important; }
    .sound-hint{position:fixed;left:16px;bottom:16px;z-index:30;background:rgba(8,12,30,.75);color:#fff;border-radius:14px;padding:10px 14px;font:700 14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 6px 18px rgba(0,0,0,.35);border:1px solid rgba(167,139,250,.45)}
    .sound-hint b{background:linear-gradient(90deg,#ffd066,#ff5a0a);-webkit-background-clip:text;background-clip:text;color:transparent}
  </style>
</head>
<body>
  <div id="game"></div>
  <!-- hidden input to capture keyboard while editing bet inline on canvas -->
  <input id="betInput" type="text" inputmode="numeric" pattern="[0-9]*"
         style="position:fixed;left:-9999px;top:-9999px;opacity:0;width:1px;height:1px;border:0;padding:0;background:transparent;color:transparent"
         aria-label="Edit bet" />
  <div id="errorBanner" class="error-banner"></div>
  <div id="fallback" class="error-banner" style="display:block;background:#0e1422;color:#cde7ff">
    If you see only this message on iPhone, the file is opening in the Files app preview which doesnâ€™t run JavaScript.
    Tap the share icon â†’ <b>Open in Safari</b>, or host this file on HTTPS and open that link.
  </div>
  <div id="soundHint" class="sound-hint" style="display:none">Tap anywhere to <b>enable sound</b> ðŸ”Š</div>

  <!-- HTMLAudio fallbacks (WebAudio is preferred) -->
  <audio id="spinSound" preload="auto" playsinline muted>
    <source src="https://cdn.jsdelivr.net/gh/naptha/talkify/sounds/notification.mp3" type="audio/mpeg" />
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg" />
  </audio>
  <audio id="bangSound" preload="auto" playsinline muted>
    <source src="https://cdn.jsdelivr.net/gh/itsmikehere/sample-audio@main/explosion-1.mp3" type="audio/mpeg" />
    <source src="https://actions.google.com/sounds/v1/explosions/explosion.ogg" type="audio/ogg" />
  </audio>
  <!-- coin clink fallback -->
  <audio id="coinSound" preload="auto" playsinline muted>
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg" />
    <source src="https://cdn.jsdelivr.net/gh/itsmikehere/sample-audio@main/coin-1.mp3" type="audio/mpeg" />
  </audio>
  <!-- spin loop fallback (subtle whoosh loop) -->
  <audio id="spinLoopSound" preload="auto" playsinline loop muted>
    <source src="https://cdn.jsdelivr.net/gh/itsmikehere/sample-audio@main/slot_whoosh_loop.mp3" type="audio/mpeg" />
  </audio>

<script>
(function(){
  'use strict';

  // -----------------------------------------------------
  // Error banner helpers
  // -----------------------------------------------------
  function show(msg){ var el=document.getElementById('errorBanner'); if(!el) return; el.textContent=String(msg); el.style.display='block'; }
  window.__showBanner=show;
  window.addEventListener('error',function(e){ if(String(e.message).indexOf('Script error')===-1) show('Error: '+e.message); });
  window.addEventListener('unhandledrejection',function(e){ var r=e && e.reason; show('Unhandled: '+(r && (r.message||r))); });

  // -----------------------------------------------------
  // Cross-browser audio (WebAudio first; HTMLAudio fallback)
  // -----------------------------------------------------
  var AudioSys=(function(){
    var ctx=null, unlocked=false;
    var gainMain=null;
    var lastCoinTime = 0; // throttle coin ticks

    // spin loop state
    var spinLoop = { g:null, whoosh:null, lfo:null, tickInt:null, usingFallback:false };

    function ensure(){
      if(ctx) return ctx;
      var C=window.AudioContext||window.webkitAudioContext; if(!C) return null;
      ctx=new C({latencyHint:'interactive'}); gainMain=ctx.createGain(); gainMain.gain.value=1.0;
      gainMain.connect(ctx.destination); return ctx;
    }
    function unlock(){
      var c=ensure(); if(!c) return false;
      if(c.state==='suspended'){ c.resume().catch(function(){}); }
      // Play a tiny silent buffer to satisfy iOS/Firefox gesture requirement
      var b=c.createBuffer(1, 1, 22050); var src=c.createBufferSource(); src.buffer=b; src.connect(gainMain); try{ src.start(0); }catch(_){ }
      unlocked=true;
      // Also unmute HTMLAudio as fallback
      var a1=document.getElementById('spinSound');
      var a2=document.getElementById('bangSound');
      var a3=document.getElementById('coinSound');
      var a4=document.getElementById('spinLoopSound');
      [a1,a2,a3,a4].forEach(function(a){ try{ if(a){ a.muted=false; a.currentTime=0; } }catch(_){ } });
      return true;
    }

    function playSpin(){
      var c=ensure();
      if(c && unlocked){
        var o=c.createOscillator(); var g=c.createGain();
        o.type='triangle'; o.frequency.value=880; o.connect(g); g.connect(gainMain);
        var now=c.currentTime; o.frequency.setValueAtTime(880, now);
        o.frequency.exponentialRampToValueAtTime(1760, now+0.08);
        g.gain.setValueAtTime(0.0, now);
        g.gain.linearRampToValueAtTime(0.6, now+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
        o.start(now); o.stop(now+0.18);
        return;
      }
      var a=document.getElementById('spinSound'); if(a){ try{ a.muted=false; a.currentTime=0; a.play(); }catch(_){ } }
    }

    function playBang(){
      var c=ensure();
      if(c && unlocked){
        var dur=0.45; var now=c.currentTime;
        var len=Math.floor(c.sampleRate*dur), buf=c.createBuffer(1,len,c.sampleRate), data=buf.getChannelData(0);
        for(var i=0;i<len;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/len, 2.2); }
        var src=c.createBufferSource(); src.buffer=buf;
        var lp=c.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(1800, now);
        var g=c.createGain(); g.gain.value=0.0;
        src.connect(lp); lp.connect(g); g.connect(gainMain);
        g.gain.linearRampToValueAtTime(0.9, now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
        src.start(now); src.stop(now+dur);

        var o=c.createOscillator(); var g2=c.createGain();
        o.type='sine'; o.frequency.setValueAtTime(120, now);
        o.frequency.exponentialRampToValueAtTime(50, now+0.35);
        g2.gain.setValueAtTime(0.0, now);
        g2.gain.linearRampToValueAtTime(0.8, now+0.02);
        g2.gain.exponentialRampToValueAtTime(0.0001, now+0.5);
        o.connect(g2); g2.connect(gainMain); o.start(now); o.stop(now+0.5);
        return;
      }
      var a=document.getElementById('bangSound'); if(a){ try{ a.muted=false; a.currentTime=0; a.play(); }catch(_){ } }
    }

    function playCountdown(n){
      var c=ensure();
      var freq = (n===3?880:(n===2?660:520));
      if(c && unlocked){
        var now=c.currentTime; var o=c.createOscillator(); var g=c.createGain();
        o.type='square'; o.frequency.setValueAtTime(freq, now);
        g.gain.setValueAtTime(0.0, now);
        g.gain.linearRampToValueAtTime(0.7, now+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
        o.connect(g); g.connect(gainMain);
        o.start(now); o.stop(now+0.2);
        return;
      }
      var a=document.getElementById('spinSound'); if(a){ try{ a.muted=false; a.currentTime=0; a.play(); }catch(_){ } }
    }

    // --- Coin clink SFX (WebAudio; falls back to HTMLAudio) ---
    function playCoin(){
      var c = ensure();
      if(c && unlocked){
        var now = c.currentTime;
        if(now - lastCoinTime < 0.05) return; // ~20 clinks/sec max
        lastCoinTime = now;

        var o = c.createOscillator();
        var hp = c.createBiquadFilter();
        var g  = c.createGain();

        o.type = 'square';
        o.frequency.setValueAtTime(1500, now);
        o.frequency.exponentialRampToValueAtTime(2200, now + 0.03);

        hp.type = 'highpass';
        hp.frequency.value = 900;

        g.gain.setValueAtTime(0.0, now);
        g.gain.linearRampToValueAtTime(0.45, now + 0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

        o.connect(hp); hp.connect(g); g.connect(gainMain);

        o.start(now);
        o.stop(now + 0.14);
        return;
      }
      var a = document.getElementById('coinSound');
      if(a){
        try{
          a.muted = false;
          if(a.currentTime > 0.25) a.currentTime = 0;
          a.play();
        }catch(_){}
      }
    }

    // --- Spin loop (whoosh + soft ticking), with HTMLAudio fallback ---
    function startSpinLoop(){
      var c=ensure();
      // If WebAudio unavailable or not yet unlocked, use HTMLAudio fallback
      if(!(c && unlocked)){
        var af=document.getElementById('spinLoopSound');
        if(af){ try{ af.muted=false; af.currentTime=0; af.play(); spinLoop.usingFallback=true; }catch(_){ } }
        return;
      }
      if(spinLoop.g) return; // already running

      var g=c.createGain(); g.gain.value=0.0; g.connect(gainMain);
      spinLoop.g=g;

      // whoosh = bandpassed noise with LFO amplitude
      var len=c.sampleRate*1.0, buf=c.createBuffer(1, len, c.sampleRate), data=buf.getChannelData(0);
      for(var i=0;i<len;i++){ data[i]=(Math.random()*2-1); }
      var src=c.createBufferSource(); src.buffer=buf; src.loop=true;

      var bp=c.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=700; bp.Q.value=0.9;

      var lfo=c.createOscillator(); lfo.frequency.value=1.0;
      var lfoGain=c.createGain(); lfoGain.gain.value=0.14;

      var whooshGain=c.createGain(); whooshGain.gain.value=0.28;

      src.connect(bp); bp.connect(whooshGain); whooshGain.connect(g);
      lfo.connect(lfoGain); lfoGain.connect(whooshGain.gain);

      var now=c.currentTime;
      g.gain.linearRampToValueAtTime(0.6, now+0.12); // fade-in
      src.start(now); lfo.start(now);

      spinLoop.whoosh=src; spinLoop.lfo=lfo;

      // soft ticking every ~120ms
      spinLoop.tickInt=setInterval(function(){
        var o=c.createOscillator(), eg=c.createGain(), hp=c.createBiquadFilter();
        o.type='square'; o.frequency.setValueAtTime(1200, c.currentTime);
        hp.type='highpass'; hp.frequency.value=800;
        eg.gain.setValueAtTime(0, c.currentTime);
        eg.gain.linearRampToValueAtTime(0.22, c.currentTime+0.005);
        eg.gain.exponentialRampToValueAtTime(0.0001, c.currentTime+0.07);
        o.connect(hp); hp.connect(eg); eg.connect(g);
        o.start(c.currentTime);
        o.stop(c.currentTime+0.08);
      }, 120);
    }

    function stopSpinLoop(){
      // stop fallback if used
      if(spinLoop.usingFallback){
        var af=document.getElementById('spinLoopSound');
        if(af){ try{ af.pause(); }catch(_){ } }
        spinLoop.usingFallback=false;
      }

      var c=ensure(); if(!c) return;
      if(spinLoop.tickInt){ clearInterval(spinLoop.tickInt); spinLoop.tickInt=null; }
      if(spinLoop.whoosh){ try{ spinLoop.whoosh.stop(); }catch(_){ } try{ spinLoop.whoosh.disconnect(); }catch(_){ } spinLoop.whoosh=null; }
      if(spinLoop.lfo){ try{ spinLoop.lfo.stop(); }catch(_){ } try{ spinLoop.lfo.disconnect(); }catch(_){ } spinLoop.lfo=null; }
      if(spinLoop.g){
        var now=c.currentTime; // short fade-out
        try{
          spinLoop.g.gain.cancelScheduledValues(now);
          spinLoop.g.gain.setValueAtTime(spinLoop.g.gain.value, now);
          spinLoop.g.gain.linearRampToValueAtTime(0.0001, now+0.12);
        }catch(_){}
        setTimeout(function(){ try{ spinLoop.g.disconnect(); }catch(_){ } spinLoop.g=null; }, 140);
      }
    }

    return {
      ensure:ensure,
      unlock:unlock,
      playSpin:playSpin,
      playBang:playBang,
      playCountdown:playCountdown,
      playCoin:playCoin,
      startSpinLoop:startSpinLoop,
      stopSpinLoop:stopSpinLoop
    };
  })();

  window.addEventListener('DOMContentLoaded',function(){
    var sh=document.getElementById('soundHint'); if(sh) sh.style.display='block';
    var fb=document.getElementById('fallback'); if(fb) fb.style.display='none';

    // ---------------------------------------------------
    // Config & constants
    // ---------------------------------------------------
    var CONFIG={ width:720, height:1280, reelCount:3, rows:4, symbolSize:180, reelSpacing:16, bet:20, startBalance:1000,
      spinBaseDuration:2.0, spinStagger:0.45, cyclesBase:6, cyclesStep:2 };
    var REEL_DIR=[-1,+1,-1];
    var FRAME_RADIUS=28;
    var FRAME_GAP_FRAC=0.12;
    var BUTTON_OFFSET_FRAC=0.22;
    var NAV_HEIGHT_FRAC=0.58;

    var SYMBOL_FILL=1.0, SYMBOL_MARGIN=0.04;
    var AUTO_TRIM_ALPHA=8, AUTO_TRIM_PAD_MIN=4, AUTO_TRIM_RATIO=0.10, USE_TRIM=true;

    var ICON_URLS=[
      'https://pinkp0p.github.io/horizon/zodiac_1.png','https://pinkp0p.github.io/horizon/zodiac_2.png','https://pinkp0p.github.io/horizon/zodiac_3.png','https://pinkp0p.github.io/horizon/zodiac_4.png',
      'https://pinkp0p.github.io/horizon/zodiac_5.png','https://pinkp0p.github.io/horizon/zodiac_6.png','https://pinkp0p.github.io/horizon/zodiac_7.png','https://pinkp0p.github.io/horizon/zodiac_8.png',
      'https://pinkp0p.github.io/horizon/zodiac_9.png','https://pinkp0p.github.io/horizon/zodiac_10.png','https://pinkp0p.github.io/horizon/zodiac_11.png','https://pinkp0p.github.io/horizon/zodiac_12.png'
    ];

    // ---------------------------------------------------
    // Utilities
    // ---------------------------------------------------
    function getPlayerName(){
      try{
        var tg=(window.Telegram&&window.Telegram.WebApp)?window.Telegram.WebApp:null;
        if(tg){ try{ tg.ready&&tg.ready(); }catch(_){ } var u=tg.initDataUnsafe&&tg.initDataUnsafe.user; if(u){
          var parts=[]; if(u.first_name) parts.push(u.first_name); if(u.last_name) parts.push(u.last_name);
          var full=parts.join(' ').trim(); if(full) return full; if(u.username) return u.username;
        }}
      }catch(_){ }
      try{ var m=/[?&]name=([^&#]+)/.exec(location.search); if(m) return decodeURIComponent(m[1].replace(/\+/g,' ')); }catch(_){ }
      try{ var ls=localStorage.getItem('slot_player_name'); if(ls) return ls; }catch(_){ }
      return 'Player';
    }

    var icons={ imgs:Array(12).fill(null), rects:Array(12).fill(null), ready:false, error:false };
    var iconCache={ cell:0, inner:0, canvases:Array(12).fill(null) };

    function buildIconCache(cell){
      if(!icons.ready) return;
      var inner=Math.max(1,Math.floor(cell*(SYMBOL_FILL-2*SYMBOL_MARGIN)));
      if(iconCache.cell===cell && iconCache.inner===inner) return;
      iconCache.cell=cell; iconCache.inner=inner; iconCache.canvases=Array(12).fill(null);
      for(var i=0;i<12;i++){
        var img=icons.imgs[i]; if(!img) continue;
        var r=icons.rects[i]||{sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight};
        var sc=Math.min(inner/r.sw, inner/r.sh);
        var dw=Math.max(1,Math.round(r.sw*sc)), dh=Math.max(1,Math.round(r.sh*sc));
        var off=document.createElement('canvas'); off.width=dw; off.height=dh; var o=off.getContext('2d',{alpha:true});
        o.imageSmoothingEnabled=true; o.imageSmoothingQuality='high';
        try{o.drawImage(img,r.sx,r.sy,r.sw,r.sh,0,0,dw,dh);}catch(_){ }
        iconCache.canvases[i]=off;
      }
    }

    function preloadIcons(urls, cb){
      var remaining=urls.length, failed=false;
      urls.forEach(function(url,i){
        var img=new Image(); img.decoding='async'; img.crossOrigin='anonymous';
        img.onload=function(){
          icons.imgs[i]=img;
          try{ icons.rects[i]=USE_TRIM?trimRectForImage(img):{sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight}; }
          catch(_){ icons.rects[i]={sx:0,sy:0,sw:img.naturalWidth,sh:img.naturalHeight}; }
          remaining-=1; if(remaining===0 && !failed){ icons.ready=true; if(cb) cb(); }
        };
        img.onerror=function(){ failed=true; icons.error=true; window.__showBanner&&window.__showBanner('Failed to load: '+url); };
        img.src=url;
      });
    }

    function trimRectForImage(img){
      var w=img.naturalWidth,h=img.naturalHeight;
      var off=document.createElement('canvas'); off.width=w; off.height=h; var o=off.getContext('2d'); o.drawImage(img,0,0);
      var data=o.getImageData(0,0,w,h).data; var minX=w,minY=h,maxX=-1,maxY=-1;
      for(var y=0;y<h;y++) for(var x=0;x<w;x++){ var a=data[(y*w+x)*4+3]; if(a>AUTO_TRIM_ALPHA){ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; } }
      if(maxX<0||maxY<0) return {sx:0,sy:0,sw:w,sh:h};
      var sw=maxX-minX+1, sh=maxY-minY+1; var pad=Math.max(AUTO_TRIM_PAD_MIN,Math.round(Math.min(w,h)*AUTO_TRIM_RATIO));
      var sx=Math.max(0,minX-pad), sy=Math.max(0,minY-pad); var sx2=Math.min(w,maxX+1+pad), sy2=Math.min(h,maxY+1+pad);
      return {sx:sx,sy:sy,sw:sx2-sx,sh:sy2-sy};
    }

    preloadIcons(ICON_URLS,function(){
      window.__showBanner&&window.__showBanner('Loaded 12 icons'+(USE_TRIM?' (+safe trim)':''));
      setTimeout(function(){ var el=document.getElementById('errorBanner'); if(el) el.style.display='none'; },900);
      try{ if(window.$slot) selfTest(window.$slot);}catch(_){ }
    });

    // ---------------------------------------------------
    // Drawing helpers
    // ---------------------------------------------------
    function roundRectPath(ctx,x,y,w,h,r){ var rr=Math.max(0,Math.min(r,Math.min(w,h)/2)); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
    function drawDividerLine(ctx,x,topY,rows,cell,t){ ctx.save(); ctx.lineWidth=3; ctx.strokeStyle=lavaGradient(ctx,x-20,topY,40,rows*cell,t); ctx.shadowBlur=8; ctx.shadowColor='rgba(255,120,30,0.6)'; ctx.beginPath(); ctx.moveTo(x,topY); ctx.lineTo(x,topY+rows*cell); ctx.stroke(); ctx.restore(); }

    function StarBG(W,H){ this.w=W; this.h=H; this.t=0; this.stars=[]; for(var i=0;i<160;i++){ var blue=Math.random()<0.5; var rgb=blue?[140,140,255]:[200,130,255]; this.stars.push({x:Math.random()*W,y:Math.random()*H,r:0.8+Math.random()*1.4,v:20+Math.random()*60,rgb:rgb,baseA:0.6+Math.random()*0.35,tw:0.6+Math.random()*1.6,ph:Math.random()*Math.PI*2}); } }
    StarBG.prototype.update=function(dt){ this.t+=dt; for(var i=0;i<this.stars.length;i++){ var s=this.stars[i]; s.y+=s.v*dt; if(s.y>this.h){ s.y=-2; s.x=Math.random()*this.w; } } };
    StarBG.prototype.draw=function(ctx){ ctx.fillStyle='#050714'; ctx.fillRect(0,0,this.w,this.h); ctx.globalCompositeOperation='lighter'; for(var i=0;i<this.stars.length;i++){ var s=this.stars[i]; var twPhase=0.5+0.5*Math.sin(this.t*s.tw+s.ph); var a=s.baseA*(0.65+0.35*twPhase); var color='rgba('+s.rgb[0]+','+s.rgb[1]+','+s.rgb[2]+','+a.toFixed(3)+')'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*(0.85+0.15*twPhase),0,Math.PI*2); ctx.fillStyle=color; ctx.shadowBlur=6+6*twPhase; ctx.shadowColor=color; ctx.fill(); } ctx.globalCompositeOperation='source-over'; };

    function lavaGradient(ctx,x,y,w,h,t){ var g=ctx.createLinearGradient(x,y+h*Math.sin(t*0.6)*0.1,x+w,y+h*(1+Math.sin(t*0.5)*0.1)); g.addColorStop(0,'#3a0d10'); g.addColorStop(0.25,'#7a1a10'); g.addColorStop(0.45,'#c32c10'); g.addColorStop(0.65,'#ff5a0a'); g.addColorStop(0.85,'#ffd066'); g.addColorStop(1,'#ff5a0a'); return g; }
    function drawLavaFrame(ctx,x,y,w,h,r,t){ var rr=Math.max(0,Math.min(r,Math.min(w,h)/2)); ctx.save(); ctx.translate(0.5,0.5); ctx.lineWidth=12; ctx.shadowBlur=22; ctx.shadowColor='rgba(255,100,20,0.85)'; ctx.strokeStyle=lavaGradient(ctx,x,y,w,h,t); roundRectPath(ctx,x+3,y+3,w-6,h-6,rr-3); ctx.stroke(); ctx.lineWidth=3; ctx.shadowBlur=10; ctx.strokeStyle='rgba(255,220,120,0.8)'; roundRectPath(ctx,x+8,y+8,w-16,h-16,rr-8); ctx.stroke(); ctx.restore(); }
    function drawLavaButton(ctx,cx,cy,R,t,pressed){ ctx.save(); var g=ctx.createRadialGradient(cx,cy,R*0.2,cx,cy,R); var p=(Math.sin(t*1.6)*0.5+0.5)*0.25; if(pressed){ g.addColorStop(0,'#ffeebf'); g.addColorStop(0.25+p,'#ffb34a'); g.addColorStop(0.65,'#c42d1f'); g.addColorStop(1,'#4a1410'); } else { g.addColorStop(0,'#ffea9a'); g.addColorStop(0.25+p,'#ff962a'); g.addColorStop(0.65,'#a81d0f'); g.addColorStop(1,'#3a0d10'); } ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle=g; ctx.fill(); ctx.lineWidth=6; ctx.strokeStyle='rgba(255,140,30,0.95)'; ctx.shadowColor='rgba(255,120,30,0.9)'; ctx.shadowBlur=20; ctx.stroke(); ctx.beginPath(); ctx.arc(cx,cy,R*0.85,-Math.PI*0.15,Math.PI*0.35); ctx.lineWidth=8; ctx.strokeStyle='rgba(255,240,210,0.35)'; ctx.shadowBlur=0; ctx.stroke(); ctx.restore(); ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='900 36px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; var tl=ctx.createLinearGradient(cx-40,cy-20,cx+40,cy+20); tl.addColorStop(0,'#fff4e2'); tl.addColorStop(1,'#ffd18a'); ctx.fillStyle=tl; ctx.fillText('SPIN',cx,cy); ctx.restore(); }

    function drawSymbol(ctx,sym,x,y,size){ if(sym==='JP'){ ctx.save(); ctx.fillStyle='#ff2b2b'; ctx.font='900 '+Math.floor(size*0.30)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('JP',x,y); ctx.restore(); return; } var index=parseInt(sym,10); if(isNaN(index)||index<0||index>=12) return; if(!icons.ready) return; buildIconCache(size); var off=iconCache.canvases[index]; if(!off) return; var dx=x-off.width*0.5, dy=y-off.height*0.5; try{ ctx.drawImage(off,dx,dy);}catch(_){ } }

    var SYMBOLS=[0,1,2,3,4,5,6,7,8,9,10,11,'JP'];

    // ---------------------------------------------------
    // Bottom navigation
    // ---------------------------------------------------
    function drawNavIcon(ctx, type, cx, cy, size, grad){ var s=size; ctx.save(); ctx.strokeStyle=grad; ctx.lineWidth=Math.max(2,Math.round(s*0.10)); ctx.lineJoin='round'; ctx.lineCap='round'; if(type==='wallet'){ var w=s*1.2,h=s*0.75,r=s*0.18; var x=cx-w/2,y=cy-h/2; roundRectPath(ctx,x,y,w,h,r); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x+w*0.20,y+h*0.40); ctx.lineTo(x+w*0.80,y+h*0.40); ctx.stroke(); ctx.beginPath(); ctx.arc(x+w*0.80,y+h*0.52,s*0.06,0,Math.PI*2); ctx.stroke(); } else if(type==='home'){ var w2=s*1.15,h2=s*0.9; var x2=cx-w2/2,y2=cy-h2/2; ctx.beginPath(); ctx.moveTo(x2, y2+h2*0.45); ctx.lineTo(cx, y2); ctx.lineTo(x2+w2, y2+h2*0.45); ctx.stroke(); roundRectPath(ctx,x2+w2*0.15,y2+h2*0.40,w2*0.70,h2*0.48,s*0.10); ctx.stroke(); roundRectPath(ctx,x2+w2*0.44,y2+h2*0.56,w2*0.12,h2*0.22,s*0.06); ctx.stroke(); } else { var r2=s*0.65; ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx, cy - r2*0.55); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx + r2*0.40, cy); ctx.stroke(); ctx.beginPath(); ctx.arc(cx, cy, s*0.08, 0, Math.PI*2); ctx.stroke(); } ctx.restore(); }

    function drawNavButton(ctx,x,y,w,h,label,iconKey,active){
      var r=22; ctx.save(); ctx.globalAlpha=1; ctx.fillStyle='rgba(10, 16, 40, 0.55)'; roundRectPath(ctx,x,y,w,h,r); ctx.fill(); ctx.shadowBlur=active?20:12; ctx.shadowColor=active?'rgba(110,231,255,0.6)':'rgba(124,58,237,0.35)'; ctx.strokeStyle=active?'rgba(110,231,255,0.9)':'rgba(167,139,250,0.45)'; ctx.lineWidth=active?3:2; roundRectPath(ctx,x+1.5,y+1.5,w-3,h-3,r-2); ctx.stroke(); var cx=x+w/2, cy=y*h*0.48; var grad=ctx.createLinearGradient(x,y,x+w,y+h); grad.addColorStop(0,'#6ee7ff'); grad.addColorStop(0.5,'#a78bfa'); grad.addColorStop(1,'#7dd3fc'); var baseIconSize=Math.max(26,Math.round(h*0.48)); var iconSize=iconKey==='history'?Math.round(baseIconSize*0.8):baseIconSize; drawNavIcon(ctx, iconKey, cx, cy, iconSize, grad); var labelPx=Math.max(16,Math.round(h*0.32)); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='700 '+labelPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.fillStyle=grad; ctx.shadowBlur=active?14:8; ctx.shadowColor='rgba(109, 40, 217, 0.45)'; ctx.fillText(label,cx,y+h*0.78); if(active){ ctx.save(); var ug=ctx.createLinearGradient(x,y,x+w,y); ug.addColorStop(0,'#6ee7ff'); ug.addColorStop(1,'#a78bfa'); ctx.strokeStyle=ug; ctx.lineWidth=3.2; ctx.shadowBlur=12; ctx.shadowColor='rgba(110,231,255,0.6)'; ctx.beginPath(); ctx.moveTo(x+16,y+6); ctx.lineTo(x+w-16,y+6); ctx.stroke(); ctx.restore(); } ctx.restore(); }

    // ---------------------------------------------------
    // Reveal mask & celebration
    // ---------------------------------------------------
    function drawRowMask(ctx, x, y, w, h, t, label){
      ctx.save();
      var g=ctx.createLinearGradient(x,y,x+w,y+h);
      g.addColorStop(0,'rgba(10,16,40,0.85)');
      g.addColorStop(1,'rgba(20,12,40,0.85)');
      ctx.fillStyle=g;
      ctx.shadowBlur=20; ctx.shadowColor='rgba(167,139,250,0.35)';
      ctx.fillRect(x,y,w,h);
      ctx.globalCompositeOperation='lighter';
      for(var i=0;i<22;i++){
        var sx=x + ((i*53+Math.sin(t+i)*97)%w); var sy=y + ((i*19+Math.cos(t*1.3+i)*71)%h);
        ctx.beginPath(); ctx.arc(sx,sy,1.2 + Math.abs(Math.sin(t*2+i))*0.8,0,Math.PI*2);
        ctx.fillStyle='rgba(110,231,255,0.35)'; ctx.fill();
      }
      ctx.globalCompositeOperation='source-over';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font='900 '+Math.round(h*0.35)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
      var lg=ctx.createLinearGradient(x,y,x+w,y);
      lg.addColorStop(0,'#ffd066'); lg.addColorStop(1,'#ff5a0a');
      ctx.fillStyle=lg; ctx.fillText(label, x+w/2, y+h/2);
      ctx.restore();
    }

    function drawCelebration(ctx, x, y, w, h, t){
      ctx.save();
      for(var i=0;i<10;i++){
        var p=(t*1.2 + i*0.12)%1; var sx=x + p*w; var sy=y + (i%2? h*0.2 : h*0.8);
        var ex=sx+Math.min(80,w*0.18); var ey=sy+(i%2? -8:8);
        var g=ctx.createLinearGradient(sx,sy,ex,ey);
        g.addColorStop(0,'rgba(167,139,250,0.0)');
        g.addColorStop(1,'rgba(110,231,255,0.9)');
        ctx.strokeStyle=g; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(ex,ey); ctx.stroke();
      }
      ctx.restore();
    }

    function drawCoin(ctx, x, y, r){
      ctx.save();
      var g=ctx.createLinearGradient(x-r, y-r, x+r, y+r);
      g.addColorStop(0,'#ffd066'); g.addColorStop(0.5,'#ffb34a'); g.addColorStop(1,'#ff8a1a');
      ctx.fillStyle=g; ctx.shadowBlur=12; ctx.shadowColor='rgba(255,208,102,0.8)';
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle='rgba(255,240,210,0.65)';
      ctx.beginPath(); ctx.arc(x,y,r*0.65,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }

    // ---------------------------------------------------
    // Easing helpers
    // ---------------------------------------------------
    function easeOutCubic(u){return 1-Math.pow(1-u,3);} function imod(n,m){return ((n%m)+m)%m;}
    function easeOutBounce(u){ var n1=7.5625, d1=2.75; if(u<1/d1){ return n1*u*u; } else if(u<2/d1){ u-=1.5/d1; return n1*u*u+0.75; } else if(u<2.5/d1){ u-=2.25/d1; return n1*u*u+0.9375; } else { u-=2.625/d1; return n1*u*u+0.984375; } }

    // ---------------------------------------------------
    // SlotEngine
    // ---------------------------------------------------
    function SlotEngine(root){
      this.canvas=document.createElement('canvas'); this.ctx=this.canvas.getContext('2d'); root.appendChild(this.canvas);
      this.W=CONFIG.width; this.H=CONFIG.height; this.balance=CONFIG.startBalance; this.balanceVis=this.balance; this.bet=Math.max(1,Math.floor(CONFIG.bet||1));
      this.machineCenter={ x:this.W/2, y:this.H*0.43 };
      this.bg=new StarBG(this.W,this.H);
      this.reels=[]; this.buttonPressed=false;
      this.betRect=this.betPlusRect=this.betMinusRect=null; this.editingBet=false; this.betDraft=String(this.bet); this._caretBlink=0;
      this.playerName=getPlayerName(); this.showFPS=false; this.fpsEMA=60; this.fpsRect={x:16,y:16,w:86,h:32};
      this.nav={ active:'home', items:[ {key:'wallet',label:'Wallet',icon:'wallet'}, {key:'home',label:'Home',icon:'home'}, {key:'history',label:'History',icon:'history'} ], rects:[] };

      this.winState='idle'; this._countInt=0;
      this.hiddenRow=-1; this.countdown=0; this.rowHitRect=null; this._celebrateT=0; this.winAmount=0; this._drop={t:0,dur:0.35,hit:false,boom:0};
      this._pendingBangPlayed=false; this._shake={mag:0,time:0};

      for(var i=0;i<CONFIG.reelCount;i++){
        this.reels.push({
          finalSymbols:Array.from({length:CONFIG.rows},function(){return SYMBOLS[(Math.random()*SYMBOLS.length)|0];}),
          spinning:false, dir:REEL_DIR[i]||1, time:0,
          duration:CONFIG.spinBaseDuration+i*CONFIG.spinStagger,
          totalDistPx:0, progressPx:0
        });
      }

      this._resize(); var self=this; window.addEventListener('resize',function(){ self._resize(); });
      this.last=performance.now(); this.time=0; var that=this; requestAnimationFrame(function(t){ that._loop(t); });

      // --- inline editing ---
      var betInput=document.getElementById('betInput');
      function commitBet(){ var v=parseInt(self.betDraft||betInput.value,10); if(!isFinite(v)||v<1){ self._hideEditor(); return; } self.setBet(v); self.betDraft=String(self.bet); self._hideEditor(); self._draw(); }
      betInput.addEventListener('input', function(){ var raw=String(betInput.value||'').replace(/[^0-9]/g,''); if(raw.length>1 && raw[0]==='0') raw=raw.replace(/^0+/,'')||'0'; self.betDraft=raw||'1'; self._draw(); });
      betInput.addEventListener('change',commitBet); betInput.addEventListener('blur',commitBet);
      this._showEditor=function(){ self.editingBet=true; self.betDraft=String(self.bet); betInput.value=self.betDraft; try{ betInput.focus(); betInput.select(); }catch(_){ } };
      this._hideEditor=function(){ self.editingBet=false; try{ betInput.blur(); }catch(_){ } };
      betInput.addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); commitBet(); } if(e.key==='Escape'){ e.preventDefault(); self._hideEditor(); self._draw(); } });

      // --- input handlers ---
      var pressActive=false; var selfRef=this; var audioArmed=false;
      var canvasToGame=function(ev){ var r=selfRef.canvas.getBoundingClientRect(); return {x:(ev.clientX-r.left)/r.width*selfRef.W,y:(ev.clientY-r.top)/r.height*selfRef.H}; };
      var withinRect=function(p,r){ return r && p.x>=r.x && p.x<=r.x+r.w && p.y>=r.y && p.y<=r.y+r.h; };
      var withinButton=function(p){ var L=selfRef._computeLayout(); var R=L.radius; var dx=p.x-L.cx, dy=p.y-L.cy; return dx*dx+dy*dy<=R*R; };
      var withinNav=function(p){ if(!selfRef.nav||!selfRef.nav.rects||!selfRef.nav.rects.length) return -1; for(var i=0;i<selfRef.nav.rects.length;i++){ if(withinRect(p,selfRef.nav.rects[i])) return i; } return -1; };

      function armAudio(){
        if(audioArmed) return; audioArmed=true;
        try{ AudioSys.unlock(); }catch(_){ }
        // also try to poke the HTMLAudio (Firefox/Android)
        ['spinSound','bangSound','coinSound','spinLoopSound'].forEach(function(id){
          var a=document.getElementById(id);
          try{
            if(a){
              a.muted=false; a.currentTime=0;
              var p=a.play();
              if(p&&p.then){
                p.then(function(){ try{ a.pause(); a.currentTime=0; }catch(_){ } }).catch(function(){});
              }
            }
          }catch(_){ }
        });
        var sh=document.getElementById('soundHint'); if(sh) sh.style.display='none';
      }

      this.canvas.addEventListener('pointerdown',function(e){ var p=canvasToGame(e); armAudio(); if(selfRef.winState!=='idle'){ return; } if(withinButton(p)){ pressActive=true; selfRef.buttonPressed=true; selfRef._draw(); } });
      ['click','touchstart','keydown'].forEach(function(ev){ document.addEventListener(ev, armAudio, {once:true,capture:true}); });
      document.addEventListener('visibilitychange', function(){ if(document.visibilityState==='visible'){ try{ var c=AudioSys.ensure(); if(c&&c.state==='suspended') c.resume(); }catch(_){ } } });
      this.canvas.addEventListener('pointerup',function(e){ var p=canvasToGame(e); var was=pressActive; pressActive=false; selfRef.buttonPressed=false; selfRef._draw();
        if(selfRef.winState==='hidden' && withinRect(p,selfRef.rowHitRect)){ selfRef._startCountdown(3); return; }
        if(selfRef.winState==='countdown' && withinRect(p,selfRef.rowHitRect)){ selfRef.countdown = Math.min(selfRef.countdown, 0.2); return; }
        if(selfRef.winState!=='idle'){ return; }
        if(withinRect(p, selfRef.fpsRect)) { selfRef.toggleFPS(); return; }
        var ni=withinNav(p); if(ni>=0){ var it=selfRef.nav.items[ni]; if(it) selfRef.selectTab(it.key); return; }
        if(was && withinButton(p)){ selfRef._spin(); return; }
        if(withinRect(p,selfRef.betPlusRect)){ selfRef.incBet(+1); return; }
        if(withinRect(p,selfRef.betMinusRect)){ selfRef.incBet(-1); return; }
        if(withinRect(p,selfRef.betRect)){ selfRef._showEditor(); return; }
      });
      this.canvas.addEventListener('pointercancel',function(){ pressActive=false; selfRef.buttonPressed=false; selfRef._draw(); });
      this.canvas.addEventListener('pointerleave',function(){ if(pressActive){ selfRef.buttonPressed=false; selfRef._draw(); } });

      window.addEventListener('keydown',function(e){ if(e.key==='f'||e.key==='F'){ selfRef.toggleFPS(); } if(e.key==='+'){ selfRef.incBet(+1); } if(e.key==='-'){ selfRef.incBet(-1); } });
    }

    // ---------------------------------------------------
    // SlotEngine prototypes
    // ---------------------------------------------------
    SlotEngine.prototype._resize=function(){ var dpr=Math.min(2,Math.max(1,window.devicePixelRatio||1)); var vw=(window.visualViewport?window.visualViewport.width:window.innerWidth); var vh=(window.visualViewport?window.visualViewport.height:window.innerHeight); var scale=Math.min(vw/CONFIG.width, vh/CONFIG.height); this.canvas.width=CONFIG.width*dpr; this.canvas.height=CONFIG.height*dpr; this.canvas.style.width=Math.floor(CONFIG.width*scale)+'px'; this.canvas.style.height=Math.floor(CONFIG.height*scale)+'px'; this.ctx.setTransform(dpr,0,0,dpr,0,0); };

    SlotEngine.prototype._computeLayout=function(){ var cell=CONFIG.symbolSize, rows=CONFIG.rows, reelsN=CONFIG.reelCount; var totalW=reelsN*cell+(reelsN-1)*CONFIG.reelSpacing; var startX=this.machineCenter.x-totalW/2+cell/2; var topY=this.machineCenter.y-rows*cell/2; var frameBottom=topY+rows*cell; var radius=Math.min(totalW*0.18,160); var buttonOffset=Math.round(cell*BUTTON_OFFSET_FRAC); var cx=this.machineCenter.x; var cy=frameBottom+radius*0.70+buttonOffset; var betGap=34; var bottomExtent=cy+radius+betGap; var safeBottom=16, safeTop=16; if(bottomExtent>this.H-safeBottom){ var room=(this.H-safeBottom)-(frameBottom+betGap); var maxR=Math.max(48,room/1.6); radius=Math.min(radius,maxR); cy=frameBottom+radius*0.70+buttonOffset; } if(topY<safeTop){ var needDown=safeTop-topY; topY+=needDown; frameBottom=topY+rows*cell; cy=frameBottom+radius*0.70+buttonOffset; } return {cell:cell,rows:rows,reelsN:reelsN,totalW:totalW,startX:startX,topY:topY,frameBottom:frameBottom,cx:cx,cy:cy,radius:radius,betGap:betGap,buttonOffset:buttonOffset}; };

    SlotEngine.prototype._spin=function(){
      if(this.winState!=='idle') return;
      if(this.reels.some(function(r){return r.spinning;})) return;
      try{ AudioSys.playSpin(); }catch(_){ var sfx=document.getElementById('spinSound'); try{ sfx&&sfx.play&&sfx.play(); }catch(__){} }
      try{ AudioSys.startSpinLoop(); }catch(_){}
      for(var i=0;i<this.reels.length;i++){
        var r=this.reels[i], arr=new Array(CONFIG.rows);
        for(var k=0;k<CONFIG.rows;k++){ arr[k]=SYMBOLS[(Math.random()*SYMBOLS.length)|0]; }
        r.finalSymbols=arr; r.spinning=true; r.time=0; r.duration=CONFIG.spinBaseDuration+i*CONFIG.spinStagger;
        var cycles=CONFIG.cyclesBase+i*CONFIG.cyclesStep; r.totalDistPx=cycles*CONFIG.rows*CONFIG.symbolSize; r.progressPx=0;
      }
    };

    SlotEngine.prototype.setBet=function(v){ this.bet=Math.max(1,Math.floor(v)); };
    SlotEngine.prototype.incBet=function(d){ this.setBet(this.bet+d); this._draw(); };
    SlotEngine.prototype.selectTab=function(key){ for(var i=0;i<this.nav.items.length;i++){ if(this.nav.items[i].key===key){ this.nav.active=key; break; } } this._draw(); };
    SlotEngine.prototype.toggleFPS=function(){ this.showFPS=!this.showFPS; this._draw(); };

    SlotEngine.prototype._beginTransfer=function(){
      if(!this.transfer) this.transfer={};
      this.transfer.active=true; this.transfer.t=0; this.transfer.p=0; this.transfer.committed=false;
      var n=18; this.transfer.coins=[];
      for(var i=0;i<n;i++){
        var delay=i/(n*1.4);
        var r=6 + Math.random()*4;
        var cx=this.transfer.srcX + (Math.random()*2-1)*80;
        var cy=this.transfer.srcY - 120 - Math.random()*120;
        this.transfer.coins.push({delay:delay,r:r,cx:cx,cy:cy,sfx:false});
      }
    };

    SlotEngine.prototype._allStopped=function(){ for(var i=0;i<this.reels.length;i++){ if(this.reels[i].spinning) return false; } return true; };

    function computeWinAmount(sym, bet){ var idx=parseInt(sym,10); if(!isFinite(idx)) return bet*5; var mult = 6 + (idx%4)*4; return bet * mult; }

    SlotEngine.prototype._checkForWin=function(){
      var rows=CONFIG.rows; var n=this.reels.length;
      for(var r=0;r<rows;r++){
        var first=this.reels[0].finalSymbols[r];
        var ok = (first!=='JP');
        for(var c=1;c<n;c++) if(this.reels[c].finalSymbols[r]!==first) ok=false;
        if(ok){ this.winState='hidden'; this.hiddenRow=r; this.countdown=0; this.winAmount = computeWinAmount(first, this.bet); return true; }
      }
      return false;
    };

    SlotEngine.prototype._startCountdown=function(sec){ this.winState='countdown'; this.countdown=3; this._countInt=4; };
    SlotEngine.prototype._triggerReveal=function(){ this.winState='revealing'; this._celebrateT=1.6; this._drop.t=0; this._drop.hit=false; this._drop.boom=0; this._drop.dur=0.35; this._pendingBangPlayed=false; this.transfer={active:false,t:0,p:0,dur:2.0,coins:[],committed:false, srcX:0,srcY:0,tgtX:this.W-40,tgtY:26}; };

    SlotEngine.prototype._updateReels=function(dt){
      for(var i=0;i<this.reels.length;i++){
        var r=this.reels[i]; if(!r.spinning) continue; r.time+=dt; var u=Math.min(1,r.time/r.duration); var eased=easeOutCubic(u); r.progressPx=r.totalDistPx*eased; if(u>=1){ r.spinning=false; r.progressPx=r.totalDistPx; }
      }

      if(this.winState==='idle' && this._allStopped()){
        // stop spin loop as soon as reels finish (win or no win)
        try{ AudioSys.stopSpinLoop(); }catch(_){}
        this._checkForWin();
      }

      if(this.winState==='countdown'){
        var prev=Math.ceil(this.countdown);
        this.countdown -= dt; var nowI=Math.ceil(Math.max(0,this.countdown));
        if(nowI!==prev && nowI>0){ try{ AudioSys.playCountdown(nowI); }catch(_){ } }
        if(this.countdown<=0){ this._triggerReveal(); }
      }

      if(this.winState==='revealing'){
        this._celebrateT -= dt;
        if(!this._drop.hit){
          this._drop.t += dt / this._drop.dur;
          if(this._drop.t>=1){
            this._drop.t=1; this._drop.hit=true; this._drop.boom=0.6;
            if(!this._pendingBangPlayed){ try{ AudioSys.playBang(); }catch(_){ var bang=document.getElementById('bangSound'); try{ bang&&bang.play&&bang.play(); }catch(__){} } this._pendingBangPlayed=true; }
            this._shake.mag = Math.max(24, Math.round(CONFIG.symbolSize*0.28));
            this._shake.time = 0.55;
          }
        } else {
          if(this.transfer && !this.transfer.active){ this._beginTransfer(); }
          if(this.transfer && this.transfer.active){
            this.transfer.t = Math.min(1, this.transfer.t + dt/this.transfer.dur);
            this.transfer.p = easeOutCubic(this.transfer.t);
            this.balanceVis = this.balance + this.winAmount * this.transfer.p;
            if(this.transfer.t>=1 && !this.transfer.committed){
              this.balance += this.winAmount; this.balanceVis=this.balance; this.winAmount=0; this.transfer.committed=true;
              this._celebrateT = Math.min(this._celebrateT, 0.3);
            }
          }
          if(this._drop.boom>0){ this._drop.boom -= dt; }
        }
        if(this._shake.time>0){ this._shake.time = Math.max(0, this._shake.time - dt); }
        if(this._celebrateT<=0){ this.winState='idle'; this.hiddenRow=-1; }
      }
      this.bg.update(dt); this._caretBlink += dt;
    };

    SlotEngine.prototype._loop=function(t){ var dt=(t-this.last)/1000; this.last=t; if(dt<0||!isFinite(dt)) dt=0; if(dt>0){ var fps=1/dt; var a=0.15; this.fpsEMA=this.fpsEMA*(1-a)+fps*a; } this.time+=dt; this._updateReels(dt); this._draw(); var self=this; requestAnimationFrame(function(tt){ self._loop(tt); }); };

    SlotEngine.prototype._draw=function(){
      var ctx=this.ctx; ctx.clearRect(0,0,this.W,this.H); this.bg.draw(ctx); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='medium';

      var shakeX=0, shakeY=0; if(this._shake && this._shake.time>0){ var s=this._shake; var k=s.time/0.55; var m=s.mag*(k*k); shakeX=(Math.random()*2-1)*m; shakeY=(Math.random()*2-1)*m; ctx.save(); ctx.translate(shakeX, shakeY); }

      var L=this._computeLayout(); var cell=L.cell, rows=L.rows, reelsN=L.reelsN, totalW=L.totalW, startX=L.startX, topY=L.topY;

      // reels viewport + symbols
      ctx.save(); ctx.beginPath(); ctx.rect(startX-cell/2, topY, totalW, rows*cell); ctx.clip();
      for(var ri=0;ri<reelsN;ri++){
        var rx=startX+ri*(cell+CONFIG.reelSpacing); var reel=this.reels[ri]; var distPx=reel.progressPx; var whole=(distPx/cell)|0; var frac=distPx-whole*cell; var shift=reel.dir*whole; var fracPx=reel.dir*frac; 
        for(var k=0;k<rows+2;k++){ var visIndex=imod(k-1-shift,rows); var sym=reel.finalSymbols[visIndex]; var cy=topY+(k-1)*cell+fracPx+cell*0.5; drawSymbol(ctx,sym,rx,cy,cell); }
      }
      ctx.restore();

      // winning row overlay & drop
      if(this.hiddenRow>=0){
        var rxv=startX - cell/2; var ryv=topY + this.hiddenRow*cell; var rwv=totalW; var rhv=cell;
        this.rowHitRect={x:rxv,y:ryv,w:rwv,h:rhv};
        if(this.winState==='hidden')      drawRowMask(ctx, rxv, ryv, rwv, rhv, this.time, 'Tap to reveal');
        else if(this.winState==='countdown') drawRowMask(ctx, rxv, ryv, rwv, rhv, this.time, String(Math.ceil(this.countdown)));
        else if(this.winState==='revealing'){
          drawCelebration(ctx, rxv, ryv, rwv, rhv, (1.6-this._celebrateT)/1.6);
          var centerX = rxv + rwv/2; var startY = -Math.max(40, this.H*0.22); var endY=ryv + rhv*0.52; var u=Math.max(0,Math.min(1,this._drop.t));
          var y=startY + (endY-startY)*easeOutBounce(u);
          if(!this._drop.hit){ ctx.save(); var trail=ctx.createLinearGradient(centerX, 0, centerX, y); trail.addColorStop(0,'rgba(255,255,255,0.0)'); trail.addColorStop(1,'rgba(255,208,102,0.9)'); ctx.strokeStyle=trail; ctx.lineWidth=2; ctx.shadowBlur=12; ctx.shadowColor='rgba(255,208,102,0.7)'; ctx.beginPath(); ctx.moveTo(centerX, 0); ctx.lineTo(centerX, y-4); ctx.stroke(); ctx.restore(); }
          if(this._drop.hit && this.transfer && !this.transfer.active && !this.transfer.srcSet){ this.transfer.srcX=centerX; this.transfer.srcY=endY; this.transfer.srcSet=true; }
          var prog = (this.transfer&&this.transfer.active)? (this.transfer.p||0) : 0; var shown = Math.round(this.winAmount * (1 - prog));
          var jitter=(this._drop.hit && this._drop.boom>0)?(Math.sin(this.time*80)*3):0; ctx.save(); var moneyGrad=ctx.createLinearGradient(centerX-60,y-20,centerX+60,y+20); moneyGrad.addColorStop(0,'#ffd066'); moneyGrad.addColorStop(1,'#ff5a0a'); ctx.fillStyle=moneyGrad; ctx.textAlign='center'; ctx.textBaseline='middle'; var fontPx=Math.max(26,Math.round(cell*0.40)); var scale=(this._drop.hit && this._drop.boom>0)? 1 + Math.max(0,this._drop.boom)*0.4 : 1; ctx.font='900 '+Math.round(fontPx*scale)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.shadowBlur=16; ctx.shadowColor='rgba(255,120,30,0.75)'; ctx.fillText((shown>0?'+$'+shown:''), centerX + jitter, y); ctx.restore(); if(this._drop.hit && this._drop.boom>0){ var k=1 - this._drop.boom / 0.6; var rr=rhv*(0.25 + k*0.55); ctx.save(); ctx.strokeStyle='rgba(255,208,102,'+(1-k)+')'; ctx.lineWidth=3 + 4*(1-k); ctx.beginPath(); ctx.arc(centerX, endY, rr, 0, Math.PI*2); ctx.stroke(); ctx.restore(); }
          // coin transfer visuals + SFX
          if(this.transfer && this.transfer.active){
            var p=this.transfer.p; var tgtX=this.transfer.tgtX, tgtY=this.transfer.tgtY; var srcX=this.transfer.srcX, srcY=this.transfer.srcY;
            for(var ci=0; ci<this.transfer.coins.length; ci++){
              var C=this.transfer.coins[ci]; var tt=Math.min(1, Math.max(0, (p - C.delay) / (1 - C.delay)));
              if(tt>0 && !C.sfx){
                if(Math.random() < 0.7){ try{ AudioSys.playCoin(); }catch(_){ } }
                C.sfx = true;
              }
              if(tt<=0) continue;
              var q=tt*tt*(3-2*tt); // smoothstep
              var bx=(1-q)*(1-q)*srcX + 2*(1-q)*q*C.cx + q*q*tgtX;
              var by=(1-q)*(1-q)*srcY + 2*(1-q)*q*C.cy + q*q*tgtY;
              drawCoin(ctx, bx, by, C.r);
            }
          }
        }
      } else { this.rowHitRect=null; }

      for(var ri=1;ri<reelsN;ri++){ var lineX=startX-cell/2+ri*(cell+CONFIG.reelSpacing)-CONFIG.reelSpacing/2; drawDividerLine(ctx,lineX,topY,rows,cell,this.time); }
      var gapPx=Math.max(1,Math.round(cell*FRAME_GAP_FRAC)); var fx=startX-cell/2-gapPx, fy=topY-gapPx, fw=totalW+gapPx*2, fh=rows*cell+gapPx*2; drawLavaFrame(ctx,fx,fy,fw,fh,FRAME_RADIUS,this.time);

      var cx=L.cx, cy=L.cy, radius=L.radius; drawLavaButton(ctx,cx,cy,radius,this.time,this.buttonPressed);

      ctx.save(); var welcomeFontPx=Math.max(18,Math.round(cell*0.18)); var welcomeGrad=ctx.createLinearGradient(16,16,220,36); welcomeGrad.addColorStop(0,'#ffd066'); welcomeGrad.addColorStop(1,'#ff5a0a'); ctx.fillStyle=welcomeGrad; ctx.font='800 '+welcomeFontPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.shadowBlur=8; ctx.shadowColor='rgba(255,120,30,0.55)'; var welcomeText='Hi, '+this.playerName+' ðŸ‘‹'; var maxWelcomeW=Math.min(this.W*0.6,420); var wt=ctx.measureText(welcomeText); if(wt.width>maxWelcomeW){ while(welcomeText.length>4 && ctx.measureText(welcomeText+'â€¦').width>maxWelcomeW){ welcomeText=welcomeText.slice(0,-1); } welcomeText+='â€¦'; } ctx.fillText(welcomeText,16,16); ctx.restore();

      ctx.save(); var frY=16+welcomeFontPx+8; this.fpsRect.y=frY; var fr=this.fpsRect; var rr=12; ctx.fillStyle='rgba(8,12,30,0.55)'; ctx.shadowBlur=10; ctx.shadowColor='rgba(109,40,217,0.35)'; roundRectPath(ctx,fr.x,fr.y,fr.w,fr.h,rr); ctx.fill(); var fg=ctx.createLinearGradient(fr.x,fr.y,fr.x+fr.w,fr.y+fr.h); fg.addColorStop(0,'rgba(167,139,250,0.9)'); fg.addColorStop(1,'rgba(110,231,255,0.9)'); ctx.lineWidth=2; ctx.strokeStyle=fg; ctx.stroke(); var textG=ctx.createLinearGradient(fr.x,fr.y,fr.x+fr.w,fr.y); textG.addColorStop(0,'#6ee7ff'); textG.addColorStop(1,'#a78bfa'); ctx.shadowBlur=8; ctx.shadowColor='rgba(110,231,255,0.4)'; ctx.font='700 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillStyle=textG; ctx.fillText('FPS', fr.x+10, fr.y+fr.h/2); if(this.showFPS){ var txt=(this.fpsEMA||0).toFixed(0); ctx.textAlign='right'; ctx.fillText(txt, fr.x+fr.w-10, fr.y+fr.h/2); } ctx.restore();

      ctx.save(); var balFontPx=Math.max(24,Math.round(cell*0.26)); var moneyGrad=ctx.createLinearGradient(this.W-200,0,this.W,60); moneyGrad.addColorStop(0,'#ffd066'); moneyGrad.addColorStop(1,'#ff5a0a'); ctx.fillStyle=moneyGrad; ctx.font='900 '+balFontPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='right'; ctx.textBaseline='top'; ctx.shadowBlur=10; ctx.shadowColor='rgba(255,120,30,0.65)'; ctx.fillText('$'+Math.round(this.balanceVis),this.W-20,16); ctx.restore();

      ctx.save(); var betFontPx=Math.max(22,Math.round(cell*0.24)); var leftOffset=Math.max(radius*1.5, Math.round(cell*1.0)); var bx=cx-leftOffset, by=cy; var navH=Math.max(64,Math.round(cell*NAV_HEIGHT_FRAC)); var margin=10; var maxY=this.H-navH-margin-Math.round(cell*0.2); if(by>maxY) by=maxY; if(bx>this.W-margin) bx=this.W-margin; if(bx<margin) bx=margin; var betText='$'+(this.editingBet?this.betDraft:this.bet); var betGrad=ctx.createLinearGradient(bx-40,by-20,bx+40,by+20); betGrad.addColorStop(0,'#ffb34a'); betGrad.addColorStop(1,'#ffd066'); ctx.fillStyle=betGrad; ctx.font='900 '+betFontPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowBlur=8; ctx.shadowColor='rgba(255,120,30,0.55)'; ctx.fillText(betText,bx,by+1); var metrics=ctx.measureText(betText); var textW=Math.max(metrics.width, betFontPx*1.4); var textH=Math.round(betFontPx*1.2); this.betRect={ x: Math.round(bx - textW/2 - 8), y: Math.round(by - textH/2 - 8), w: Math.round(textW + 16), h: Math.round(textH + 16) }; var ctlFontPx=Math.max(20,Math.round(betFontPx*0.85)); ctx.font='900 '+ctlFontPx+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.fillStyle='#ffd066'; var plusY=by-textH*0.9-ctlFontPx*0.6; ctx.fillText('+',bx,plusY); var plusW=ctx.measureText('+').width, plusH=Math.round(ctlFontPx*1.1); this.betPlusRect={x:Math.round(bx-plusW/2)-6,y:Math.round(plusY-plusH/2)-4,w:Math.round(plusW)+12,h:plusH+8}; var minusY=by+textH*0.9+ctlFontPx*0.6; ctx.fillText('-',bx,minusY); var minusW=ctx.measureText('-').width, minusH=Math.round(ctlFontPx*1.1); this.betMinusRect={x:Math.round(bx-minusW/2)-6,y:Math.round(minusY-minusH/2)-4,w:Math.round(minusW)+12,h:minusH+8}; if(this.editingBet){ var caretOn=((this._caretBlink*2)|0)%2===0; if(caretOn){ var caretX=bx+textW/2+6; var caretY=by-textH*0.45; ctx.save(); var cg=ctx.createLinearGradient(caretX,caretY,caretX,caretY+textH*0.9); cg.addColorStop(0,'#ffd066'); cg.addColorStop(1,'#ffb34a'); ctx.fillStyle=cg; ctx.fillRect(Math.round(caretX), Math.round(caretY), 3, Math.round(textH*0.9)); ctx.restore(); } } ctx.restore();

      var navH2=Math.max(64,Math.round(cell*NAV_HEIGHT_FRAC)); this._drawNav(ctx,L,navH2);

      if(this._shake && this._shake.time>0){ ctx.restore(); }
    };

    SlotEngine.prototype._drawNav=function(ctx,L,navH){ var pad=12; var w=this.W-pad*2; var h=navH; var x=pad; var y=this.H-h-8; ctx.save(); ctx.globalAlpha=1; ctx.fillStyle='rgba(8,12,30,0.55)'; roundRectPath(ctx,x,y,w,h,26); ctx.fill(); var bg=ctx.createLinearGradient(x,y,x+w,y+h); bg.addColorStop(0,'rgba(167,139,250,0.55)'); bg.addColorStop(1,'rgba(110,231,255,0.55)'); ctx.strokeStyle=bg; ctx.lineWidth=2; ctx.shadowBlur=14; ctx.shadowColor='rgba(109,40,217,0.35)'; ctx.stroke(); ctx.shadowBlur=0; ctx.globalAlpha=1; ctx.restore(); var n=this.nav.items.length; var bw=w/n; this.nav.rects=[]; for(var i=0;i<n;i++){ var bx=x+i*bw, by=y; var rect={x:bx,y:by,w:bw,h:h}; this.nav.rects.push(rect); var it=this.nav.items[i]; drawNavButton(ctx, rect.x+8, rect.y+8, rect.w-16, rect.h-16, it.label, it.icon, this.nav.active===it.key); } };

    // ---------------------------------------------------
    // Tests
    // ---------------------------------------------------
    function assert(c,m){ if(!c){ throw new Error('[TEST FAIL] '+m); } }
    function nearly(a,b,eps){ return Math.abs(a-b) <= (eps||1e-6); }
    function centerOf(r){ return { x:r.x + r.w/2, y:r.y + r.h/2 }; }
    function selfTest(s){
      try{
        assert(typeof SlotEngine==='function','SlotEngine defined');
        assert(!!s.canvas&&!!s.ctx,'canvas initialized');
        assert(typeof s.playerName==='string' && s.playerName.length>0,'playerName resolved');
        assert(s.reels.length===CONFIG.reelCount,'reel count');
        assert(s.reels.every(function(r){return r.finalSymbols.length===CONFIG.rows;}),'rows per reel');
        try{ s.bg.draw(s.ctx); s._draw(); }catch(e){ throw new Error('[TEST FAIL] draw() throws'); }
        var L=s._computeLayout(); assert(L.topY>=0 && L.cy+L.radius+L.betGap<=s.H,'layout kept on screen');
        try{ drawSymbol(s.ctx,'JP',120,120,160);}catch(e){ throw new Error('[TEST FAIL] drawSymbol JP throws'); }
        assert(typeof SYMBOL_FILL==='number' && SYMBOL_FILL>0 && SYMBOL_FILL<=1,'SYMBOL_FILL sane');
        assert(typeof SYMBOL_MARGIN==='number' && SYMBOL_MARGIN>=0 && SYMBOL_MARGIN<0.5,'SYMBOL_MARGIN sane');
        var cell=L.cell, rows=L.rows, totalW=L.totalW, startX=L.startX, topY=L.topY;
        var vx=startX-cell/2, vy=topY, vw=totalW, vh=rows*cell;
        var expectedGap=Math.max(1,Math.round(cell*FRAME_GAP_FRAC));
        var fx=vx-expectedGap, fy=vy-expectedGap, fw=vw+expectedGap*2, fh=vh+expectedGap*2;
        assert(expectedGap>=1,'gap >=1px');
        assert(fx<vx && fy<vy && (fx+fw)>(vx+vw) && (fy+fh)>(vy+vh),'frame surrounds viewport');
        var lineX=startX - cell/2 + 1*(cell+CONFIG.reelSpacing) - CONFIG.reelSpacing/2;
        assert(lineX>vx && lineX<vx+vw,'divider in bounds');
        assert(easeOutCubic(0)===0 && nearly(easeOutCubic(1),1),'easing endpoints');

        s._spin(); s._updateReels(999);
        assert(s.reels.every(function(r){return !r.spinning;}),'reels stop after big dt');

        var anyWin=false; for(var r=0;r<CONFIG.rows;r++){ var a=s.reels[0].finalSymbols[r]; var ok=(a!=='JP'); for(var c=1;c<CONFIG.reelCount;c++){ if(s.reels[c].finalSymbols[r]!==a) ok=false; } if(ok){ anyWin=true; break; } }
        if(anyWin){
          assert(s.winState==='hidden' && s.hiddenRow>=0,'entered hidden state');
          s._startCountdown(2); s._updateReels(1.1);
          assert(s.winState==='countdown','countdown state');
          s._updateReels(2);
          assert(s.winState==='revealing','revealing after countdown');
          s._updateReels(1);
          assert(s._drop.hit===true,'drop hit after duration');
          assert(s._shake.time>=0,'shake started');
          s._updateReels(2);
          assert(s.winState==='idle' && s.hiddenRow===-1,'back to idle after reveal');
        }

        s._draw();
        assert(s.betRect && s.betPlusRect && s.betMinusRect,'bet rects exist');
        var betC=centerOf(s.betRect); assert(betC.x < L.cx,'bet left of spin');
        buildIconCache(cell); assert(iconCache.cell===cell && iconCache.inner>0,'icon cache built');
        assert(s.showFPS===false,'FPS default off'); s.toggleFPS(); assert(s.showFPS===true,'FPS on'); s.toggleFPS(); assert(s.showFPS===false,'FPS off');
        assert(s.nav && s.nav.items && s.nav.items.length===3,'nav items 3');
        assert(['wallet','home','history'].indexOf(s.nav.items[0].icon)>=0,'nav icons are known keys');
        assert(s.nav.active==='home','nav default home');
        var prev=s.nav.active; s.selectTab('wallet'); assert(s.nav.active==='wallet','select wallet'); s.selectTab('history'); assert(s.nav.active==='history','select history'); s.selectTab(prev);
        var old=s.bet; s.incBet(+1); assert(s.bet===old+1,'plus inc'); s.incBet(-1); assert(s.bet===old,'minus dec');
        var navH=Math.max(64,Math.round(L.cell*NAV_HEIGHT_FRAC)); assert((s.betRect.y + s.betRect.h/2) < (s.H - navH),'bet above nav');
        assert(typeof s._showEditor==='function' && typeof s._hideEditor==='function','editor helpers exist'); s._showEditor(); assert(s.editingBet===true,'enter edit'); s.betDraft='123'; s._draw(); s._hideEditor(); assert(s.editingBet===false,'exit edit');

        assert(typeof drawRowMask==='function','drawRowMask exists');
        var savedState=s.winState, savedRow=s.hiddenRow, savedCnt=s.countdown; s.hiddenRow=1; s.winState='countdown'; s.countdown=3; s._draw(); s.winState=savedState; s.hiddenRow=savedRow; s.countdown=savedCnt;
      }catch(e){ window.__showBanner && window.__showBanner(e.message||e); }
    }

    // ---------------------------------------------------
    // Bootstrap
    // ---------------------------------------------------
    try{ var root=document.getElementById('game'); window.$slot=new SlotEngine(root); selfTest(window.$slot); }catch(e){ var el=document.getElementById('errorBanner'); el.textContent='Bootstrap failed: '+(e.message||e); el.style.display='block'; }
  });
})();
</script>
</body>
</html>
