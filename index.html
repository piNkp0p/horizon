<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Telegram Slot Machine – Zodiac (12 PNGs, Clean Contain Fit)</title>
  <style>
    html, body { height: 100%; margin: 0; background: #020616; overflow: hidden; }
    #game { position: fixed; inset: 0; display: grid; place-items: center; }
    canvas { display: block; max-width: 100%; max-height: 100%; object-fit: contain; background: #000; }
    .error-banner { position: fixed; top: 0; left: 0; right: 0; background: #3a0d10; color: #ffd2d2; padding: 10px 14px; font-weight: 700; display: none; z-index: 20; white-space: pre-wrap; }
    body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    audio { display: none !important; }
  </style>
</head>
<body>
  <div id="game"></div>
  <div id="errorBanner" class="error-banner"></div>
  <div id="fallback" class="error-banner" style="display:block;background:#0e1422;color:#cde7ff">
    If you see only this message on iPhone, the file is opening in the Files app preview which doesn’t run JavaScript.
    Tap the share icon → <b>Open in Safari</b>, or host this file on HTTPS (GitHub Pages / Netlify) and open that link.
  </div>
  <audio id="spinSound" hidden preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg" />
  </audio>

<script>
(function(){
  'use strict';

  function show(msg){ var el=document.getElementById('errorBanner'); if(!el) return; el.textContent=String(msg); el.style.display='block'; }
  window.__showBanner=show;
  window.addEventListener('error',function(e){ if(String(e.message).indexOf('Script error')===-1) show('Error: '+e.message); });
  window.addEventListener('unhandledrejection',function(e){ var r=e && e.reason; show('Unhandled: '+(r && (r.message||r))); });

  window.addEventListener('DOMContentLoaded',function(){
    var fb=document.getElementById('fallback'); if(fb) fb.style.display='none';

    // ----- CONFIG -----
    var CONFIG={ width:720, height:1280, reelCount:3, rows:4, symbolSize:180, reelSpacing:16, bet:20, startBalance:1000,
      spinBaseDuration:2.0, spinStagger:0.45, cyclesBase:6, cyclesStep:2 };
    var REEL_DIR=[-1,+1,-1];
    var FRAME_RADIUS=28;

    // visual sizing
    var SYMBOL_FILL   = 1.00; // full inner square
    var SYMBOL_MARGIN = 0.04; // inner margins (fraction of cell)

    // icon set (12 PNGs)
    var AUTO_TRIM_ALPHA = 8;
    var AUTO_TRIM_PAD_MIN = 4;
    var AUTO_TRIM_PAD_RATIO = 0.10;
    var USE_TRIM = true;

    var ICON_URLS = [
      'https://pinkp0p.github.io/horizon/zodiac_1.png',
      'https://pinkp0p.github.io/horizon/zodiac_2.png',
      'https://pinkp0p.github.io/horizon/zodiac_3.png',
      'https://pinkp0p.github.io/horizon/zodiac_4.png',
      'https://pinkp0p.github.io/horizon/zodiac_5.png',
      'https://pinkp0p.github.io/horizon/zodiac_6.png',
      'https://pinkp0p.github.io/horizon/zodiac_7.png',
      'https://pinkp0p.github.io/horizon/zodiac_8.png',
      'https://pinkp0p.github.io/horizon/zodiac_9.png',
      'https://pinkp0p.github.io/horizon/zodiac_10.png',
      'https://pinkp0p.github.io/horizon/zodiac_11.png',
      'https://pinkp0p.github.io/horizon/zodiac_12.png'
    ];

    var icons = { imgs:Array(12).fill(null), rects:Array(12).fill(null), ready:false, error:false };

    function preloadIcons(urls, cb){
      var remaining = urls.length; var failed = false;
      urls.forEach(function(url, i){
        var img = new Image();
        img.decoding='async'; img.crossOrigin='anonymous';
        img.onload=function(){
          icons.imgs[i]=img;
          try { icons.rects[i] = USE_TRIM ? trimRectForImage(img) : { sx:0, sy:0, sw:img.naturalWidth, sh:img.naturalHeight }; }
          catch(e){ icons.rects[i] = { sx:0, sy:0, sw:img.naturalWidth, sh:img.naturalHeight }; }
          remaining -= 1; if(remaining===0 && !failed){ icons.ready=true; if(cb) cb(); }
        };
        img.onerror=function(){ failed=true; icons.error=true; if(window.__showBanner) window.__showBanner('Failed to load: '+url); };
        img.src=url;
      });
    }

    function trimRectForImage(img){
      var w=img.naturalWidth, h=img.naturalHeight;
      var off=document.createElement('canvas'); off.width=w; off.height=h;
      var octx=off.getContext('2d'); octx.drawImage(img,0,0);
      var data=octx.getImageData(0,0,w,h).data;
      var minX=w, minY=h, maxX=-1, maxY=-1;
      for(var y=0;y<h;y++) for(var x=0;x<w;x++){
        var a=data[(y*w+x)*4+3];
        if(a>AUTO_TRIM_ALPHA){ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; }
      }
      if(maxX<0 || maxY<0) return { sx:0, sy:0, sw:w, sh:h };
      var sw=maxX-minX+1, sh=maxY-minY+1;
      var pad=Math.max(AUTO_TRIM_PAD_MIN, Math.round(Math.min(w,h)*AUTO_TRIM_PAD_RATIO));
      var sx=Math.max(0,minX-pad), sy=Math.max(0,minY-pad);
      var sx2=Math.min(w,maxX+1+pad), sy2=Math.min(h,maxY+1+pad);
      return { sx:sx, sy:sy, sw:sx2-sx, sh:sy2-sy };
    }

    preloadIcons(ICON_URLS, function(){
      if(window.__showBanner){
        window.__showBanner('Loaded 12 icons'+(USE_TRIM?' (+safe trim)':''));
        setTimeout(function(){ var el=document.getElementById('errorBanner'); if(el) el.style.display='none'; }, 900);
      }
      try{ if(window.$slot) selfTest(window.$slot); }catch(_){ }
    });

    // ---- utilities ----
    function roundRectPath(ctx, x, y, w, h, r) {
      var rr = Math.max(0, Math.min(r, Math.min(w, h) / 2));
      ctx.beginPath();
      ctx.moveTo(x + rr, y);
      ctx.arcTo(x + w, y, x + w, y + h, rr);
      ctx.arcTo(x + w, y + h, x, y + h, rr);
      ctx.arcTo(x, y + h, x, y, rr);
      ctx.arcTo(x, y, x + w, y, rr);
      ctx.closePath();
    }

    function drawDividerLine(ctx, x, topY, rows, cell, t) {
      ctx.save();
      ctx.lineWidth = 3;
      ctx.strokeStyle = lavaGradient(ctx, x-20, topY, 40, rows*cell, t);
      ctx.shadowBlur=8;
      ctx.shadowColor='rgba(255,120,30,0.6)';
      ctx.beginPath();
      ctx.moveTo(x, topY);
      ctx.lineTo(x, topY + rows * cell);
      ctx.stroke();
      ctx.restore();
    }

    // background (bigger, brighter purple/blue stars + gentle twinkle)
    function StarBG(W,H){
      this.w=W; this.h=H; this.t=0; this.stars=[];
      for(var i=0;i<160;i++){
        var blue = Math.random()<0.5;
        var rgb = blue ? [140,140,255] : [200,130,255];
        this.stars.push({
          x:Math.random()*W,
          y:Math.random()*H,
          r:1.6+Math.random()*3.2,
          v:20+Math.random()*60,
          rgb: rgb,
          baseA: 0.6 + Math.random()*0.35,
          tw: 0.6 + Math.random()*1.6,
          ph: Math.random()*Math.PI*2
        });
      }
    }
    StarBG.prototype.update=function(dt){
      this.t += dt;
      for(var i=0;i<this.stars.length;i++){
        var s=this.stars[i];
        s.y+=s.v*dt; if(s.y>this.h){ s.y=-2; s.x=Math.random()*this.w; }
      }
    };
    StarBG.prototype.draw=function(ctx){
      ctx.fillStyle='#050714'; ctx.fillRect(0,0,this.w,this.h);
      ctx.globalCompositeOperation = 'lighter';
      for(var i=0;i<this.stars.length;i++){
        var s=this.stars[i];
        var twPhase = 0.5 + 0.5*Math.sin(this.t*s.tw + s.ph);
        var a = s.baseA*(0.65 + 0.35*twPhase);
        var color = 'rgba('+s.rgb[0]+','+s.rgb[1]+','+s.rgb[2]+','+a.toFixed(3)+')';
        ctx.beginPath();
        ctx.arc(s.x,s.y,s.r*(0.85 + 0.15*twPhase),0,Math.PI*2);
        ctx.fillStyle=color;
        ctx.shadowBlur=10 + 10*twPhase;
        ctx.shadowColor=color;
        ctx.fill();
      }
      ctx.globalCompositeOperation = 'source-over';
    };

    // frame + button
    function lavaGradient(ctx, x, y, w, h, t){
      var g=ctx.createLinearGradient(x, y+h*Math.sin(t*0.6)*0.1, x+w, y+h*(1+Math.sin(t*0.5)*0.1));
      g.addColorStop(0.00,'#3a0d10'); g.addColorStop(0.25,'#7a1a10'); g.addColorStop(0.45,'#c32c10');
      g.addColorStop(0.65,'#ff5a0a'); g.addColorStop(0.85,'#ffd066'); g.addColorStop(1.00,'#ff5a0a');
      return g;
    }
    function drawLavaFrame(ctx,x,y,w,h,r,t){
      var rr=Math.max(0,Math.min(r,Math.min(w,h)/2));
      ctx.save(); ctx.translate(0.5,0.5);
      ctx.lineWidth=12; ctx.shadowBlur=22; ctx.shadowColor='rgba(255,100,20,0.85)';
      ctx.strokeStyle=lavaGradient(ctx,x,y,w,h,t);
      roundRectPath(ctx,x+3,y+3,w-6,h-6,rr-3); ctx.stroke();
      ctx.lineWidth=3; ctx.shadowBlur=10; ctx.strokeStyle='rgba(255,220,120,0.8)';
      roundRectPath(ctx,x+8,y+8,w-16,h-16,rr-8); ctx.stroke();
      ctx.restore();
    }
    function drawLavaButton(ctx,cx,cy,R,t,pressed){
      ctx.save();
      var g=ctx.createRadialGradient(cx,cy,R*0.2, cx,cy,R);
      var p=(Math.sin(t*1.6)*0.5+0.5)*0.25;
      if(pressed){
        g.addColorStop(0.00,'#ffeebf'); g.addColorStop(0.25+p,'#ffb34a'); g.addColorStop(0.65,'#c42d1f'); g.addColorStop(1.00,'#4a1410');
      } else {
        g.addColorStop(0.00,'#ffea9a'); g.addColorStop(0.25+p,'#ff962a'); g.addColorStop(0.65,'#a81d0f'); g.addColorStop(1.00,'#3a0d10');
      }
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();
      ctx.lineWidth=6; ctx.strokeStyle='rgba(255,140,30,0.95)'; ctx.shadowColor='rgba(255,120,30,0.9)'; ctx.shadowBlur=20; ctx.stroke();
      ctx.beginPath(); ctx.arc(cx,cy,R*0.85, -Math.PI*0.15, Math.PI*0.35);
      ctx.lineWidth=8; ctx.strokeStyle='rgba(255,240,210,0.35)'; ctx.shadowBlur=0; ctx.stroke();
      ctx.restore();
      ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='900 36px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
      var tl=ctx.createLinearGradient(cx-40,cy-20,cx+40,cy+20); tl.addColorStop(0,'#fff4e2'); tl.addColorStop(1,'#ffd18a');
      ctx.fillStyle=tl; ctx.fillText('SPIN', cx, cy); ctx.restore();
    }

    // symbol draw
    function drawSymbol(ctx,sym,x,y,size){
      if(sym==='JP'){
        ctx.save(); ctx.fillStyle='#ff2b2b'; ctx.font='900 '+Math.floor(size*0.30)+'px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('JP',x,y); ctx.restore();
        return;
      }
      var index=parseInt(sym,10); if(isNaN(index)||index<0||index>=12) return;
      if(!icons.ready) return;
      var img=icons.imgs[index]; var r=icons.rects[index] || { sx:0, sy:0, sw:img.naturalWidth, sh:img.naturalHeight };
      var inner=Math.max(1, Math.floor(size * (SYMBOL_FILL - 2*SYMBOL_MARGIN)));
      var scale=Math.min(inner / r.sw, inner / r.sh);
      var dstW=Math.max(1, Math.round(r.sw*scale));
      var dstH=Math.max(1, Math.round(r.sh*scale));
      var dstX=Math.round(x - dstW/2);
      var dstY=Math.round(y - dstH/2);
      ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
      try{ ctx.drawImage(img, r.sx, r.sy, r.sw, r.sh, dstX, dstY, dstW, dstH); }catch(e){}
    }

    var SYMBOLS=[0,1,2,3,4,5,6,7,8,9,10,11,'JP'];

    // ----- ENGINE -----
    function SlotEngine(root){
      this.canvas=document.createElement('canvas'); this.ctx=this.canvas.getContext('2d'); root.appendChild(this.canvas);
      this.W=CONFIG.width; this.H=CONFIG.height;
      this.balance=CONFIG.startBalance; this.bet=CONFIG.bet;
      this.machineCenter={ x:this.W/2, y:this.H*0.43 };
      this.bg=new StarBG(this.W,this.H);
      this.reels=[];
      this.buttonPressed=false;
      for(var i=0;i<CONFIG.reelCount;i++){
        this.reels.push({
          finalSymbols:Array.from({length:CONFIG.rows},function(){return SYMBOLS[(Math.random()*SYMBOLS.length)|0];}),
          spinning:false, dir:REEL_DIR[i]||1, time:0,
          duration:CONFIG.spinBaseDuration+i*CONFIG.spinStagger,
          totalDistPx:0, progressPx:0
        });
      }
      this._resize();
      var self=this; window.addEventListener('resize',function(){ self._resize(); });
      this.last=performance.now(); this.time=0; var that=this; requestAnimationFrame(function(t){ that._loop(t); });

      // Button press visual feedback using pointer events on canvas
      var pressActive=false;
      function withinButton(ev){ var L=self._computeLayout(); var r=L.radius; var rect=self.canvas.getBoundingClientRect(); var x=(ev.clientX-rect.left)/rect.width*self.W; var y=(ev.clientY-rect.top)/rect.height*self.H; var dx=x-L.cx, dy=y-L.cy; return dx*dx+dy*dy<=r*r; }
      this.canvas.addEventListener('pointerdown',function(e){ if(withinButton(e)){ pressActive=true; self.buttonPressed=true; self._draw(); }});
      this.canvas.addEventListener('pointerup',function(e){ var was=pressActive; pressActive=false; self.buttonPressed=false; self._draw(); if(was && withinButton(e)){ self._spin(); }});
      this.canvas.addEventListener('pointercancel',function(){ pressActive=false; self.buttonPressed=false; self._draw(); });
      this.canvas.addEventListener('pointerleave',function(){ if(pressActive){ self.buttonPressed=false; self._draw(); }});
    }

    SlotEngine.prototype._resize=function(){
      var dpr=Math.min(2, Math.max(1,window.devicePixelRatio||1));
      var vw=(window.visualViewport?window.visualViewport.width:window.innerWidth);
      var vh=(window.visualViewport?window.visualViewport.height:window.innerHeight);
      var scale=Math.min(vw/CONFIG.width, vh/CONFIG.height);
      this.canvas.width=CONFIG.width*dpr; this.canvas.height=CONFIG.height*dpr;
      this.canvas.style.width=Math.floor(CONFIG.width*scale)+'px';
      this.canvas.style.height=Math.floor(CONFIG.height*scale)+'px';
      this.ctx.setTransform(dpr,0,0,dpr,0,0);
    };

    SlotEngine.prototype._computeLayout=function(){
      var cell=CONFIG.symbolSize, rows=CONFIG.rows, reelsN=CONFIG.reelCount;
      var totalW=reelsN*cell+(reelsN-1)*CONFIG.reelSpacing;
      var startX=this.machineCenter.x-totalW/2+cell/2;
      var topY=this.machineCenter.y-rows*cell/2;
      var frameBottom=topY+rows*cell;
      var radius=Math.min(totalW*0.18, 160);
      var cx=this.machineCenter.x; var cy=frameBottom + radius*0.70; // keep button inside viewport
      var betGap=34;
      var bottomExtent=cy+radius+betGap; var safeBottom=16; var safeTop=16;
      if(bottomExtent>this.H-safeBottom){
        var room=(this.H-safeBottom)-(frameBottom+betGap);
        var maxR=Math.max(48,room/1.6);
        radius=Math.min(radius,maxR);
        cy=frameBottom+radius*0.70;
      }
      if(topY<safeTop){ var needDown=safeTop-topY; topY+=needDown; frameBottom=topY+rows*cell; cy=frameBottom+radius*0.70; }
      return {cell:cell, rows:rows, reelsN:reelsN, totalW:totalW, startX:startX, topY:topY, frameBottom:frameBottom, cx:cx, cy:cy, radius:radius, betGap:betGap};
    };

    function easeOutCubic(u){return 1-Math.pow(1-u,3);}    
    function imod(n,m){return ((n%m)+m)%m;}

    SlotEngine.prototype._spin=function(){
      if(this.reels.some(function(r){return r.spinning;})) return;
      var sfx=document.getElementById('spinSound'); try{ sfx&&sfx.play&&sfx.play(); }catch(_){}
      for(var i=0;i<this.reels.length;i++){
        var r=this.reels[i], arr=new Array(CONFIG.rows);
        for(var k=0;k<CONFIG.rows;k++){ arr[k]=SYMBOLS[(Math.random()*SYMBOLS.length)|0]; }
        r.finalSymbols=arr; r.spinning=true; r.time=0; r.duration=CONFIG.spinBaseDuration+i*CONFIG.spinStagger;
        var cycles=CONFIG.cyclesBase+i*CONFIG.cyclesStep; r.totalDistPx=cycles*CONFIG.rows*CONFIG.symbolSize; r.progressPx=0;
      }
    };

    SlotEngine.prototype._updateReels=function(dt){
      for(var i=0;i<this.reels.length;i++){
        var r=this.reels[i]; if(!r.spinning) continue; r.time+=dt; var u=Math.min(1,r.time/r.duration); var eased=easeOutCubic(u); r.progressPx=r.totalDistPx*eased; if(u>=1){ r.spinning=false; r.progressPx=r.totalDistPx; }
      }
      this.bg.update(dt);
    };

    SlotEngine.prototype._loop=function(t){ var dt=(t-this.last)/1000; this.last=t; this.time+=dt; this._updateReels(dt); this._draw(); var self=this; requestAnimationFrame(function(tt){ self._loop(tt); }); };

    SlotEngine.prototype._draw=function(){
      var ctx=this.ctx; ctx.clearRect(0,0,this.W,this.H); this.bg.draw(ctx);
      ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';

      var L=this._computeLayout(); var cell=L.cell, rows=L.rows, reelsN=L.reelsN, totalW=L.totalW, startX=L.startX, topY=L.topY;

      // reels viewport + symbols
      ctx.save();
      ctx.beginPath(); ctx.rect(startX - cell/2, topY, totalW, rows*cell); ctx.clip();
      for(var ri=0;ri<reelsN;ri++){
        var rx=startX+ri*(cell+CONFIG.reelSpacing); var reel=this.reels[ri];
        var distPx=reel.progressPx; var whole=Math.floor(distPx/cell); var frac=distPx-whole*cell; var shift=reel.dir*whole; var fracPx=reel.dir*frac;
        for(var k=-1;k<rows+1;k++){
          var visIndex=imod(k-shift,rows);
          var sym=reel.finalSymbols[visIndex];
          var cy=topY + k*cell + fracPx + cell*0.5;
          drawSymbol(ctx, sym, rx, cy, cell);
        }
      }
      ctx.restore();

      // divider lines between reels (match frame gradient)
      for(var ri=1;ri<reelsN;ri++){
        var lineX=startX - cell/2 + ri*(cell+CONFIG.reelSpacing) - CONFIG.reelSpacing/2;
        drawDividerLine(ctx, lineX, topY, rows, cell, this.time);
      }

      // lava frame
      drawLavaFrame(ctx, startX-cell/2, topY, totalW, rows*cell, FRAME_RADIUS, this.time);

      // lava spin button (with press feedback)
      var cx=L.cx, cy=L.cy, radius=L.radius; drawLavaButton(ctx, cx, cy, radius, this.time, this.buttonPressed);

      // HUD
      ctx.fillStyle='#d6e4ff'; ctx.font='24px sans-serif'; ctx.textAlign='right'; ctx.fillText('BALANCE: '+this.balance, this.W-20, 30);
      ctx.textAlign='center'; ctx.font='bold 22px sans-serif'; ctx.fillStyle='rgba(230,235,245,0.9)'; var betY=Math.min(cy+radius+L.betGap, this.H-8); ctx.fillText('BET: '+this.bet, cx, betY);
    };

    // ----- TESTS -----
    function assert(c,m){ if(!c){ throw new Error('[TEST FAIL] '+m); } }
    function selfTest(s){
      try{
        assert(typeof SlotEngine==='function','SlotEngine defined');
        assert(!!s.canvas&&!!s.ctx,'canvas initialized');
        assert(s.reels.length===CONFIG.reelCount,'reel count');
        assert(s.reels.every(function(r){return r.finalSymbols.length===CONFIG.rows;}),'rows per reel');
        try{ s.bg.draw(s.ctx); s._draw(); }catch(e){ throw new Error('[TEST FAIL] draw() throws'); }
        var L=s._computeLayout(); assert(L.topY>=0 && L.cy+L.radius+L.betGap<=s.H, 'layout kept on screen');
        try{ drawSymbol(s.ctx,'JP',120,120,160); }catch(e){ throw new Error('[TEST FAIL] drawSymbol JP throws'); }
        assert(typeof SYMBOL_FILL==='number' && SYMBOL_FILL>0 && SYMBOL_FILL<=1, 'SYMBOL_FILL sane');
        assert(typeof SYMBOL_MARGIN==='number' && SYMBOL_MARGIN>=0 && SYMBOL_MARGIN<0.5, 'SYMBOL_MARGIN sane');
      } catch(e){ if(window.__showBanner) window.__showBanner(e.message||e); }
    }

    // bootstrap
    try{
      var root=document.getElementById('game');
      window.$slot=new SlotEngine(root);
      selfTest(window.$slot);
    } catch(e){
      var el=document.getElementById('errorBanner');
      el.textContent='Bootstrap failed: '+(e.message||e);
      el.style.display='block';
    }
  });
})();
</script>
</body>
</html>
